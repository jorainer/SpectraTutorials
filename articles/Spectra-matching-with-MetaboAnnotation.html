<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SpectraTutorials">
<title>MS/MS Spectra Matching with the `MetaboAnnotation` Package • SpectraTutorials</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="MS/MS Spectra Matching with the `MetaboAnnotation` Package">
<meta property="og:description" content="SpectraTutorials">
<meta property="og:image" content="https://jorainer.github.io/SpectraTutorials/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SpectraTutorials</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    <a class="dropdown-item" href="../articles/Spectra-backends.html">Spectra: an expandable infrastructure to handle mass spectrometry data</a>
    <a class="dropdown-item" href="../articles/Spectra-matching-with-MetaboAnnotation.html">MS/MS Spectra Matching with the `MetaboAnnotation` Package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jorainer/SpectraTutorials/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>MS/MS Spectra Matching with the `MetaboAnnotation` Package</h1>
                        <h4 data-toc-skip class="author">Johannes
Rainer<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Institute for Biomedicine, Eurac Research, Bolzano,
Italy; &lt;a href="mailto:johannes.rainer@eurac.edu" class="email"&gt;johannes.rainer@eurac.edu&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>,
Michael Witting<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Research Unit Analytical BioGeoChemistry, Helmholtz
Zentrum München and Chair of Analytical Food Chemistry, TUM School or
Life Sciences, Technical University of Munich, Germany&lt;/p&gt;"><sup>2</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/HEAD/vignettes/Spectra-matching-with-MetaboAnnotation.Rmd" class="external-link"><code>vignettes/Spectra-matching-with-MetaboAnnotation.Rmd</code></a></small>
      <div class="d-none name"><code>Spectra-matching-with-MetaboAnnotation.Rmd</code></div>
    </div>

    
    
<p><strong>Last modified:</strong> 2024-05-17 15:09:18.976484<br><strong>Compiled</strong>: Fri May 17 15:15:54 2024</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>The <code>Spectra</code> package provides all the functionality
required for annotation and identification workflows for untargeted
LC-MS/MS data, but, while being very flexible and customizable, it might
be too cumbersome for beginners or analysts not accustomed with R. To
fill this gap we developed the <a href="https://rformassspectrometry.github.io/MetaboAnnotation" class="external-link"><code>MetaboAnnotation</code></a>
package that builds upon <code>Spectra</code> and provides functions for
annotation of LC-MS and LC-MS/MS data sets tailored towards the less
experienced R user <span class="citation">(Rainer et al.
2022)</span>.</p>
</div>
<div class="section level3">
<h3 id="convenient-spectra-matching-using-metaboannotation">Convenient spectra matching using <code>MetaboAnnotation</code><a class="anchor" aria-label="anchor" href="#convenient-spectra-matching-using-metaboannotation"></a>
</h3>
<p>In this example use case we match experimental MS2 spectra from a DDA
experiment on a pesticide mix against reference spectra from MassBank.
Below we load the experimental data file which is distributed
<em>via</em> the <em>msdata</em> R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/" class="external-link">pander</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Load the pesticide mix data</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_DDA.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span></span>
<span><span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span></span></code></pre></div>
<p>We next restrict the data set to MS2 spectra only and in addition
<em>clean</em> these spectra by removing all peaks from a spectrum that
have an intensity lower than 5% of the largest peak intensity of that
spectrum. Finally, single-peak spectra are removed.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' restrict to MS2 data and remove intensities with intensity lower 5%</span></span>
<span><span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="va">pest</span>, msLevel <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Remove peaks with an intensity below 5% or the spectra's BPC</span></span>
<span><span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span></span>
<span><span class="op">}</span></span>
<span><span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">pest</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Remove peaks with a single peak</span></span>
<span><span class="va">pest</span> <span class="op">&lt;-</span> <span class="va">pest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">pest</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>This leads to a data set consisting of 2451 spectra. We next connect
to a MassBank database (release 2023.11, running within this docker
image) and create a <code>Spectra</code> object representing that
data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org" class="external-link">RMariaDB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMassbank" class="external-link">MsBackendMassbank</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Connect to the MassBank MySQL database</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, user <span class="op">=</span> <span class="st">"massbank"</span>, dbname <span class="op">=</span> <span class="st">"MassBank"</span>,</span>
<span>                 host <span class="op">=</span> <span class="st">"localhost"</span>, pass <span class="op">=</span> <span class="st">"massbank"</span><span class="op">)</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html" class="external-link">MsBackendMassbankSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, MassBank spectral libraries are also provided through
Bioconductor’s <em>AnnotationHub</em> and can be conveniently loaded
from there. The code below first loads the <em>AnnotationHub</em>
resource and then loads the data for one MassBank release. The database
will be cached locally, avoiding thus to re-download the data for future
use.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Load the AnnotationHub resource</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AnnotationHub</span><span class="op">)</span></span>
<span><span class="va">ah</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">AnnotationHub</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' List available MassBank release</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">query</a></span><span class="op">(</span><span class="va">ah</span>, <span class="st">"MassBank"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## AnnotationHub with 6 records</span></span>
<span><span class="co">## # snapshotDate(): 2024-04-29</span></span>
<span><span class="co">## # $dataprovider: MassBank</span></span>
<span><span class="co">## # $species: NA</span></span>
<span><span class="co">## # $rdataclass: CompDb</span></span>
<span><span class="co">## # additional mcols(): taxonomyid, genome, description,</span></span>
<span><span class="co">## #   coordinate_1_based, maintainer, rdatadateadded, preparerclass, tags,</span></span>
<span><span class="co">## #   rdatapath, sourceurl, sourcetype </span></span>
<span><span class="co">## # retrieve records with, e.g., 'object[["AH107048"]]' </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##              title                                </span></span>
<span><span class="co">##   AH107048 | MassBank CompDb for release 2021.03  </span></span>
<span><span class="co">##   AH107049 | MassBank CompDb for release 2022.06  </span></span>
<span><span class="co">##   AH111334 | MassBank CompDb for release 2022.12.1</span></span>
<span><span class="co">##   AH116164 | MassBank CompDb for release 2023.06  </span></span>
<span><span class="co">##   AH116165 | MassBank CompDb for release 2023.09  </span></span>
<span><span class="co">##   AH116166 | MassBank CompDb for release 2023.11</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Load the MassBank release 2023.11 and get a Spectra object</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="va">ah</span><span class="op">[[</span><span class="st">"AH116166"</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>It is suggested to apply the same processing applied to the query
spectra also to the target (reference) spectra. Thus we below filter
also the reference spectra from MassBank with the same intensity
filter.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Remove low intensity peaks and subsequently remove</span></span>
<span><span class="co">#' spectra with less than 2 peaks</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">mbank</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="va">mbank</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>We could now directly calculate similarities between the 2451
experimental (query) MS2 spectra and the 103525 MassBank reference
(target) spectra using the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> method, but
this would be computationally very intense because a similarity score
would be calculated between each query and each target spectrum. As
alternative we use here the <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra()</a></code> function from
the <em><a href="https://bioconductor.org/packages/3.19/MetaboAnnotation" class="external-link">MetaboAnnotation</a></em>
package that allows to restrict similarity calculations between query
and target spectra with similar <em>m/z</em> of their precursor ion (or
considering also a similar retention time if available for reference
spectra).</p>
<p>Below we create a <code>CompareSpectraParam</code> object setting
parameter <code>requirePrecursor = TRUE</code> (to restrict similarity
calculations only to query and target spectra with a similar precursor
<em>m/z</em>) and <code>ppm = 10</code> (<em>m/z</em> difference between
the query and target precursor has to be within 10 ppm). Parameter
<code>THRESHFUN</code> enables to define a <em>threshold function</em>
that defines which spectra are considered matching. With the function
used below only MS2 spectra with a similarity (calculated with the
default <em>dotproduct</em> function) larger or equal to 0.8 are
considered matching.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboAnnotation" class="external-link">MetaboAnnotation</a></span><span class="op">)</span></span>
<span><span class="va">prm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/CompareSpectraParam.html" class="external-link">CompareSpectraParam</a></span><span class="op">(</span>ppm <span class="op">=</span> <span class="fl">10</span>, requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           THRESHFUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We next call <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra()</a></code> with this parameter object
and pass <code>pest</code> and <code>mbank</code> as query and target
<code>Spectra</code>, respectively.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra</a></span><span class="op">(</span><span class="va">pest</span>, <span class="va">mbank</span>, param <span class="op">=</span> <span class="va">prm</span><span class="op">)</span></span>
<span><span class="va">mtch</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 113 </span></span>
<span><span class="co">## Number of query objects: 2451 (39 matched)</span></span>
<span><span class="co">## Number of target objects: 103525 (69 matched)</span></span></code></pre>
<p>As a result we get a <code>MatchedSpectra</code> object that contains
the query and target spectra as well as the matching result (i.e. the
information which query spectrum matches with which target spectrum
based on what similarity score). We can use the <code><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">query()</a></code> and
<code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">target()</a></code> functions to access the query and target
<code>Spectra</code> objects and <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">matches()</a></code> to extract the
matching information. Below we display the first 6 rows of that
matrix.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">matches</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   query_idx target_idx     score</span></span>
<span><span class="co">## 1       433      97386 0.9471924</span></span>
<span><span class="co">## 2       433      97387 0.9258791</span></span>
<span><span class="co">## 3       433      97388 0.8188538</span></span>
<span><span class="co">## 4       435      97386 0.9745761</span></span>
<span><span class="co">## 5       435      97387 0.8573438</span></span>
<span><span class="co">## 6       493      68124 0.9089015</span></span></code></pre>
<p>Functions <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery()</a></code> and <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichTarget()</a></code>
return the (unique) indices of the query and target spectra that could
be matched.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  433  435  493  496  497  571  682  685  686  805  807  809  810  819  829</span></span>
<span><span class="co">## [16]  983 1095 1127 1266 1281 1283 1454 1457 1480 1706 1828 1830 1834 1839 1874</span></span>
<span><span class="co">## [31] 1882 1901 1906 2038 2040 2043 2050 2124 2309</span></span></code></pre>
<p>As we can see only few of the query spectra (39 of the 2451 spectra)
could be matched. This is in part because for a large proportion spectra
in MassBank no precursor <em>m/z</em> is available and with
<code>requirePrecursor = TRUE</code> these are not considered in the
similarity calculation. Setting <code>requirePrecursor = FALSE</code>
would calculate a similarity between all spectra (even those with
missing precursor information) but calculations would take much
longer.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">precursorMz</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 23519</span></span></code></pre>
<p>The <code>MatchedSpectra</code> object inherits much of the
functionality of a <code>Spectra</code> object. The
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables()</a></code> function returns for example all the
available <em>spectra variables</em>, from both the query as well as the
target <code>Spectra</code>. The variable names of the latter are
prefixed with <code>target_</code> to discriminate them from the
variable names of the query.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                        "rtime"                         </span></span>
<span><span class="co">##  [3] "acquisitionNum"                 "scanIndex"                     </span></span>
<span><span class="co">##  [5] "dataStorage"                    "dataOrigin"                    </span></span>
<span><span class="co">##  [7] "centroided"                     "smoothed"                      </span></span>
<span><span class="co">##  [9] "polarity"                       "precScanNum"                   </span></span>
<span><span class="co">## [11] "precursorMz"                    "precursorIntensity"            </span></span>
<span><span class="co">## [13] "precursorCharge"                "collisionEnergy"               </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"         "isolationWindowTargetMz"       </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"         "peaksCount"                    </span></span>
<span><span class="co">## [19] "totIonCurrent"                  "basePeakMZ"                    </span></span>
<span><span class="co">## [21] "basePeakIntensity"              "ionisationEnergy"              </span></span>
<span><span class="co">## [23] "lowMZ"                          "highMZ"                        </span></span>
<span><span class="co">## [25] "mergedScan"                     "mergedResultScanNum"           </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum"       "mergedResultEndScanNum"        </span></span>
<span><span class="co">## [29] "injectionTime"                  "filterString"                  </span></span>
<span><span class="co">## [31] "spectrumId"                     "ionMobilityDriftTime"          </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"           "scanWindowUpperLimit"          </span></span>
<span><span class="co">## [35] ".original_query_index"          "target_msLevel"                </span></span>
<span><span class="co">## [37] "target_rtime"                   "target_acquisitionNum"         </span></span>
<span><span class="co">## [39] "target_scanIndex"               "target_dataStorage"            </span></span>
<span><span class="co">## [41] "target_dataOrigin"              "target_centroided"             </span></span>
<span><span class="co">## [43] "target_smoothed"                "target_polarity"               </span></span>
<span><span class="co">## [45] "target_precScanNum"             "target_precursorMz"            </span></span>
<span><span class="co">## [47] "target_precursorIntensity"      "target_precursorCharge"        </span></span>
<span><span class="co">## [49] "target_collisionEnergy"         "target_isolationWindowLowerMz" </span></span>
<span><span class="co">## [51] "target_isolationWindowTargetMz" "target_isolationWindowUpperMz" </span></span>
<span><span class="co">## [53] "target_compound_id"             "target_formula"                </span></span>
<span><span class="co">## [55] "target_exactmass"               "target_smiles"                 </span></span>
<span><span class="co">## [57] "target_inchi"                   "target_inchikey"               </span></span>
<span><span class="co">## [59] "target_cas"                     "target_pubchem"                </span></span>
<span><span class="co">## [61] "target_name"                    "target_spectrum_id"            </span></span>
<span><span class="co">## [63] "target_spectrum_name"           "target_date"                   </span></span>
<span><span class="co">## [65] "target_authors"                 "target_license"                </span></span>
<span><span class="co">## [67] "target_copyright"               "target_publication"            </span></span>
<span><span class="co">## [69] "target_splash"                  "target_precursorMz_text"       </span></span>
<span><span class="co">## [71] "target_adduct"                  "target_ionization"             </span></span>
<span><span class="co">## [73] "target_ionization_voltage"      "target_fragmentation_mode"     </span></span>
<span><span class="co">## [75] "target_collisionEnergy_text"    "target_instrument"             </span></span>
<span><span class="co">## [77] "target_instrument_type"         "target_original_spectrum_id"   </span></span>
<span><span class="co">## [79] "target_predicted"               "target_msms_mz_range_min"      </span></span>
<span><span class="co">## [81] "target_msms_mz_range_max"       "target_synonym"                </span></span>
<span><span class="co">## [83] "score"</span></span></code></pre>
<p>We can access individual spectra variables using <code>$</code> and
the variable name, or multiple variables with the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData()</a></code> function. Below we extract the retention
time, the precursor <em>m/z</em> of the query spectrum, the precursor
<em>m/z</em> of the target spectrum as well as the similarity score from
the object using the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData()</a></code> function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="st">"precursorMz"</span>, <span class="st">"target_precursorMz"</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 2525 rows and 4 columns</span></span>
<span><span class="co">##          rtime precursorMz target_precursorMz     score</span></span>
<span><span class="co">##      &lt;numeric&gt;   &lt;numeric&gt;          &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1        7.216    137.9639                 NA        NA</span></span>
<span><span class="co">## 2       13.146     56.9419                 NA        NA</span></span>
<span><span class="co">## 3       13.556     89.9449                 NA        NA</span></span>
<span><span class="co">## 4       23.085    207.0294                 NA        NA</span></span>
<span><span class="co">## 5       27.385    121.0990                 NA        NA</span></span>
<span><span class="co">## ...        ...         ...                ...       ...</span></span>
<span><span class="co">## 2521   895.182    137.9850                 NA        NA</span></span>
<span><span class="co">## 2522   895.472     56.0495                 NA        NA</span></span>
<span><span class="co">## 2523   896.252    142.9611                 NA        NA</span></span>
<span><span class="co">## 2524   896.662     53.0129                 NA        NA</span></span>
<span><span class="co">## 2525   898.602     91.5022                 NA        NA</span></span></code></pre>
<p>The returned <code>DataFrame</code> contains the matching information
for the full data set, i.e. of each query spectrum and hence, returns
<code>NA</code> values for query spectra that could not be matched with
a target spectrum. Note also that query spectra matching multiple target
spectra are represented by multiple rows (one for each matching target
spectrum).</p>
<p>Here we’re only interested in query spectra matching at least one
target spectrum and hence subset the matching result to these using the
<code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery()</a></code> function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtch</span> <span class="op">&lt;-</span> <span class="va">mtch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">mtch</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 113 </span></span>
<span><span class="co">## Number of query objects: 39 (39 matched)</span></span>
<span><span class="co">## Number of target objects: 103525 (69 matched)</span></span></code></pre>
<p>Subsetting of <code>MatchedSpectra</code> is always relative to the
query, i.e. <code>mtch[4]</code> would subset the object to the matching
results for the 4th query spectrum.</p>
<p>We now extract the matching information on the data subset:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="st">"precursorMz"</span>, <span class="st">"target_precursorMz"</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 113 rows and 4 columns</span></span>
<span><span class="co">##         rtime precursorMz target_precursorMz     score</span></span>
<span><span class="co">##     &lt;numeric&gt;   &lt;numeric&gt;          &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1     326.703     235.143            235.144  0.947192</span></span>
<span><span class="co">## 2     326.703     235.143            235.144  0.925879</span></span>
<span><span class="co">## 3     326.703     235.143            235.144  0.818854</span></span>
<span><span class="co">## 4     327.113     235.144            235.144  0.974576</span></span>
<span><span class="co">## 5     327.113     235.144            235.144  0.857344</span></span>
<span><span class="co">## ...       ...         ...                ...       ...</span></span>
<span><span class="co">## 109   565.646     425.214            425.215  0.947080</span></span>
<span><span class="co">## 110   565.646     425.214            425.215  0.853670</span></span>
<span><span class="co">## 111   570.825     373.040            373.041  0.879824</span></span>
<span><span class="co">## 112   596.584     313.039            313.039  0.818335</span></span>
<span><span class="co">## 113   873.144     136.112            136.112  0.804731</span></span></code></pre>
<p>We can also return the compound names for the matching spectra.
Depending on whether the annotations are retrieved from the MassBank
MySQL database or the version from <em>AnnotationHub</em> we need to use
a different spectra variable name for the compound name.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get the name of the column containing the compound name</span></span>
<span><span class="va">name_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"target_name"</span>, <span class="st">"target_compound_name"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html" class="external-link">pandoc.table</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"rmarkdown"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="va">name_col</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center">rtime</th>
<th align="center">target_name</th>
<th align="center">score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.9472</td>
</tr>
<tr class="even">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.9259</td>
</tr>
<tr class="odd">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.8189</td>
</tr>
<tr class="even">
<td align="center">327.1</td>
<td align="center">Lenacil</td>
<td align="center">0.9746</td>
</tr>
<tr class="odd">
<td align="center">327.1</td>
<td align="center">Lenacil</td>
<td align="center">0.8573</td>
</tr>
<tr class="even">
<td align="center">338.5</td>
<td align="center">Azaconazole</td>
<td align="center">0.9089</td>
</tr>
<tr class="odd">
<td align="center">338.5</td>
<td align="center">Azaconazole</td>
<td align="center">0.8028</td>
</tr>
<tr class="even">
<td align="center">338.9</td>
<td align="center">Azaconazole</td>
<td align="center">0.9226</td>
</tr>
<tr class="odd">
<td align="center">339.3</td>
<td align="center">Azaconazole</td>
<td align="center">0.9168</td>
</tr>
<tr class="even">
<td align="center">353.5</td>
<td align="center">Fosthiazate</td>
<td align="center">0.9396</td>
</tr>
<tr class="odd">
<td align="center">361.7</td>
<td align="center">Azaconazole</td>
<td align="center">0.9157</td>
</tr>
<tr class="even">
<td align="center">362.3</td>
<td align="center">Azaconazole</td>
<td align="center">0.9083</td>
</tr>
<tr class="odd">
<td align="center">362.6</td>
<td align="center">Azaconazole</td>
<td align="center">0.906</td>
</tr>
<tr class="even">
<td align="center">377.7</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.9148</td>
</tr>
<tr class="odd">
<td align="center">377.7</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8734</td>
</tr>
<tr class="even">
<td align="center">377.7</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8809</td>
</tr>
<tr class="odd">
<td align="center">377.7</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.9269</td>
</tr>
<tr class="even">
<td align="center">377.7</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8352</td>
</tr>
<tr class="odd">
<td align="center">378.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8459</td>
</tr>
<tr class="even">
<td align="center">378.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8423</td>
</tr>
<tr class="odd">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8784</td>
</tr>
<tr class="even">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8729</td>
</tr>
<tr class="odd">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.9108</td>
</tr>
<tr class="even">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8111</td>
</tr>
<tr class="odd">
<td align="center">379</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8393</td>
</tr>
<tr class="even">
<td align="center">379</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8555</td>
</tr>
<tr class="odd">
<td align="center">379</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8498</td>
</tr>
<tr class="even">
<td align="center">379</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8962</td>
</tr>
<tr class="odd">
<td align="center">379</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8577</td>
</tr>
<tr class="even">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8823</td>
</tr>
<tr class="odd">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8785</td>
</tr>
<tr class="even">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.9024</td>
</tr>
<tr class="odd">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8017</td>
</tr>
<tr class="even">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8924</td>
</tr>
<tr class="odd">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8038</td>
</tr>
<tr class="even">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8879</td>
</tr>
<tr class="odd">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.9096</td>
</tr>
<tr class="even">
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
<td align="center">0.8112</td>
</tr>
<tr class="odd">
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
<td align="center">0.8098</td>
</tr>
<tr class="even">
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
<td align="center">0.8109</td>
</tr>
<tr class="odd">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl) phosphate</td>
<td align="center">0.8293</td>
</tr>
<tr class="even">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl) phosphate</td>
<td align="center">0.8132</td>
</tr>
<tr class="odd">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl)phosphate</td>
<td align="center">0.8901</td>
</tr>
<tr class="even">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl)phosphate</td>
<td align="center">0.8457</td>
</tr>
<tr class="odd">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl)phosphate</td>
<td align="center">0.9992</td>
</tr>
<tr class="even">
<td align="center">419.8</td>
<td align="center">Fenamiphos</td>
<td align="center">0.8033</td>
</tr>
<tr class="odd">
<td align="center">431.5</td>
<td align="center">Tris(1-chloro-2-propyl) phosphate</td>
<td align="center">0.8146</td>
</tr>
<tr class="even">
<td align="center">431.5</td>
<td align="center">Tris(1-chloro-2-propyl)phosphate</td>
<td align="center">0.9011</td>
</tr>
<tr class="odd">
<td align="center">435</td>
<td align="center">Fluopicolide</td>
<td align="center">0.8542</td>
</tr>
<tr class="even">
<td align="center">435.4</td>
<td align="center">Fluopicolide</td>
<td align="center">0.8085</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8079</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8949</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8898</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8909</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.9051</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.8634</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9009</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9508</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9487</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.8492</td>
</tr>
<tr class="odd">
<td align="center">455.3</td>
<td align="center">Dimoxystrobin</td>
<td align="center">0.8179</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8834</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8854</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8253</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8514</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Tributyl phosphate</td>
<td align="center">0.9988</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Tributyl phosphate</td>
<td align="center">0.9891</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Tributyl phosphate</td>
<td align="center">0.944</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Tributyl phosphate</td>
<td align="center">0.8639</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8746</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.9747</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.9926</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.961</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Triisobutyl phosphate</td>
<td align="center">0.8165</td>
</tr>
<tr class="odd">
<td align="center">506.7</td>
<td align="center">Didecyl-dimethylammonium</td>
<td align="center">0.9766</td>
</tr>
<tr class="even">
<td align="center">506.7</td>
<td align="center">Didecyl-dimethylammonium</td>
<td align="center">0.9109</td>
</tr>
<tr class="odd">
<td align="center">506.7</td>
<td align="center">Didecyl-dimethylammonium</td>
<td align="center">0.9941</td>
</tr>
<tr class="even">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.8661</td>
</tr>
<tr class="odd">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.877</td>
</tr>
<tr class="even">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.9272</td>
</tr>
<tr class="odd">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.814</td>
</tr>
<tr class="even">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.826</td>
</tr>
<tr class="odd">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.8385</td>
</tr>
<tr class="even">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.843</td>
</tr>
<tr class="odd">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.9183</td>
</tr>
<tr class="even">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.9113</td>
</tr>
<tr class="odd">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.8424</td>
</tr>
<tr class="even">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.8732</td>
</tr>
<tr class="odd">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.9041</td>
</tr>
<tr class="even">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.8026</td>
</tr>
<tr class="odd">
<td align="center">511</td>
<td align="center">Diflufenican</td>
<td align="center">0.835</td>
</tr>
<tr class="even">
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
<td align="center">0.8813</td>
</tr>
<tr class="odd">
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
<td align="center">0.8439</td>
</tr>
<tr class="even">
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
<td align="center">0.8797</td>
</tr>
<tr class="odd">
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
<td align="center">0.8105</td>
</tr>
<tr class="even">
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
<td align="center">0.8389</td>
</tr>
<tr class="odd">
<td align="center">526.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.87</td>
</tr>
<tr class="even">
<td align="center">526.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.9468</td>
</tr>
<tr class="odd">
<td align="center">526.4</td>
<td align="center">Diisobutyl phthalate</td>
<td align="center">0.8584</td>
</tr>
<tr class="even">
<td align="center">526.4</td>
<td align="center">Diisobutyl phthalate</td>
<td align="center">0.9351</td>
</tr>
<tr class="odd">
<td align="center">526.4</td>
<td align="center">Diisobutyl phthalate</td>
<td align="center">0.8683</td>
</tr>
<tr class="even">
<td align="center">527.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.8506</td>
</tr>
<tr class="odd">
<td align="center">527.4</td>
<td align="center">Diisobutyl phthalate</td>
<td align="center">0.8409</td>
</tr>
<tr class="even">
<td align="center">527.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.818</td>
</tr>
<tr class="odd">
<td align="center">563.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.8066</td>
</tr>
<tr class="even">
<td align="center">564.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.9893</td>
</tr>
<tr class="odd">
<td align="center">564.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.9963</td>
</tr>
<tr class="even">
<td align="center">565.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.9506</td>
</tr>
<tr class="odd">
<td align="center">565.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.9471</td>
</tr>
<tr class="even">
<td align="center">565.6</td>
<td align="center">Tributyl acetylcitrate</td>
<td align="center">0.8537</td>
</tr>
<tr class="odd">
<td align="center">570.8</td>
<td align="center">Proquinazid</td>
<td align="center">0.8798</td>
</tr>
<tr class="even">
<td align="center">596.6</td>
<td align="center">Spirodiclofen-enol</td>
<td align="center">0.8183</td>
</tr>
<tr class="odd">
<td align="center">873.1</td>
<td align="center">Trimethylphenylammonium</td>
<td align="center">0.8047</td>
</tr>
</tbody>
</table>
<p>We can also visually inspect the matches using mirror plots. Below we
create mirror plots between the first query spectrum with all matching
reference spectra. For better visualization we scale the peak
intensities of all spectra to a total intensity sum of one by setting
<code>scalePeaks = TRUE</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' plot the results for the first query spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ppm <span class="op">=</span> <span class="fl">10</span>, scalePeaks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-matching-with-MetaboAnnotation_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Spectra matching results could also be manually, and interactively,
evaluated and validated with the <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/validateMatchedSpectra.html" class="external-link">validateMatchedSpectra()</a></code>
function.</p>
<p>Summarizing, the <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra()</a></code> function enables thus a
convenient spectra matching between MS data represented as
<code>Spectra</code> objects. As a result, a <code>MatchedSpectra</code>
object is returned that, in addition to the matching results, contains
also the query and target spectra. Pre-filtering the spectra prior to
the actual spectra similarity calculation can reduce the running time of
a <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra()</a></code> call but might also miss some potential
matches. Note that in addition to the precursor <em>m/z</em>-based
pre-filter also retention time pre-filtering would be available (see
<code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">?matchSpectra</a></code> for more information). Also, a more advanced
matching approach would be available with the
<code>MatchForwardReverseParam</code> that calculates in addition to the
<em>forward score</em> also a <em>reverse similarity</em> for each
match.</p>
</div>
<div class="section level3">
<h3 id="ms2-spectra-matching-in-an-xcms-workflow">MS2 spectra matching in an <code>xcms</code> workflow<a class="anchor" aria-label="anchor" href="#ms2-spectra-matching-in-an-xcms-workflow"></a>
</h3>
<p>In LC-MS/MS-based untargeted metabolomics (or small compound mass
spectrometry experiments in general) quantification of the compounds is
performed in MS1 while the MS2 data is used for identification of the
features. Quantification of MS1 data requires a chromatographic peak
detection step which can be performed using the functionality from the
<em><a href="https://bioconductor.org/packages/3.19/xcms" class="external-link">xcms</a></em>
package. Below we load thus the <code>xcms</code> package and import the
full MS data using the <code>readMsExperiment</code> function.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sneumann/xcms" class="external-link">xcms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsExperiment" class="external-link">MsExperiment</a></span><span class="op">)</span></span>
<span><span class="va">pest_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/readMsExperiment.html" class="external-link">readMsExperiment</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span></span></code></pre></div>
<p>We next perform the chromatographic peak detection using the
<em>centWave</em> algorithm (see the <em>LC-MS/MS data analysis with
xcms</em> vignette from the <code>xcms</code> package for details on the
chromatographic peak detection settings).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cwp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks-centWave.html" class="external-link">CentWaveParam</a></span><span class="op">(</span>snthresh <span class="op">=</span> <span class="fl">5</span>, noise <span class="op">=</span> <span class="fl">100</span>, ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                     peakwidth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pest_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks.html" class="external-link">findChromPeaks</a></span><span class="op">(</span><span class="va">pest_all</span>, param <span class="op">=</span> <span class="va">cwp</span><span class="op">)</span></span></code></pre></div>
<p>In total 99 chromatographic peaks have been identified. Below we
display the first 6 of them.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">pest_all</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            mz    mzmin    mzmax      rt   rtmin   rtmax       into      intb</span></span>
<span><span class="co">## CP01 142.9926 142.9921 142.9931 130.615 125.856 134.241  1113.8028  1106.229</span></span>
<span><span class="co">## CP02 221.0918 221.0906 221.0925 240.897 236.657 246.984   756.6935   744.779</span></span>
<span><span class="co">## CP03 220.0985 220.0978 220.0988 240.897 237.187 246.327  2060.5921  2052.549</span></span>
<span><span class="co">## CP04 219.0957 219.0950 219.0962 241.018 236.253 246.327 15172.6662 15133.811</span></span>
<span><span class="co">## CP05 153.0659 153.0655 153.0663 330.591 325.373 334.400  2148.7134  2141.943</span></span>
<span><span class="co">## CP06 235.1447 235.1441 235.1454 330.591 326.431 334.400  2836.2675  2829.627</span></span>
<span><span class="co">##           maxo  sn sample</span></span>
<span><span class="co">## CP01  346.7006 102      1</span></span>
<span><span class="co">## CP02  212.5239  21      1</span></span>
<span><span class="co">## CP03  585.3036 151      1</span></span>
<span><span class="co">## CP04 4877.1162 367      1</span></span>
<span><span class="co">## CP05  784.9196 114      1</span></span>
<span><span class="co">## CP06 1006.9720 110      1</span></span></code></pre>
<p>We can now extract all MS2 spectra for each chromatographic peak with
the <code><a href="https://rdrr.io/pkg/xcms/man/chromPeakSpectra.html" class="external-link">chromPeakSpectra()</a></code> function. This function identifies
all MS2 spectra recorded by the instrument with a retention time within
the retention time and with a precursor m/z within the <em>m/z</em>
boundaries of the chromatographic peak. By setting
<code>return.type = "Spectra"</code> we ensure that the data is being
returned in the newer <code>Spectra</code> format hence enabling the
simplified spectra matching with the functionality presented here.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/chromPeakSpectra.html" class="external-link">chromPeakSpectra</a></span><span class="op">(</span><span class="va">pest_all</span>, return.type <span class="op">=</span> <span class="st">"Spectra"</span><span class="op">)</span></span>
<span><span class="va">pest_ms2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 158 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##       msLevel     rtime scanIndex</span></span>
<span><span class="co">##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           2   128.237      1000</span></span>
<span><span class="co">## 2           2   128.737      1008</span></span>
<span><span class="co">## 3           2   129.857      1023</span></span>
<span><span class="co">## 4           2   237.869      1812</span></span>
<span><span class="co">## 5           2   241.299      1846</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 154         2   575.255      5115</span></span>
<span><span class="co">## 155         2   596.584      5272</span></span>
<span><span class="co">## 156         2   592.424      5236</span></span>
<span><span class="co">## 157         2   596.054      5266</span></span>
<span><span class="co">## 158         2   873.714      7344</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## PestMix1_DDA.mzML</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select MS level(s) 2 [Fri May 17 15:17:11 2024]</span></span>
<span><span class="co">##  Merge 1 Spectra into one [Fri May 17 15:17:11 2024]</span></span></code></pre>
<p>Spectra variable <code>peak_id</code> contains the identified of the
chromatographic peak (i.e. its row name in <code>chromPeaks</code>).</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_ms2</span><span class="op">$</span><span class="va">peak_id</span></span></code></pre></div>
<pre><code><span><span class="co">##   [1] "CP01" "CP01" "CP01" "CP04" "CP04" "CP05" "CP05" "CP06" "CP06" "CP08"</span></span>
<span><span class="co">##  [11] "CP08" "CP11" "CP11" "CP12" "CP12" "CP13" "CP13" "CP13" "CP13" "CP14"</span></span>
<span><span class="co">##  [21] "CP14" "CP14" "CP14" "CP18" "CP22" "CP22" "CP22" "CP22" "CP22" "CP25"</span></span>
<span><span class="co">##  [31] "CP25" "CP25" "CP25" "CP25" "CP26" "CP26" "CP26" "CP26" "CP26" "CP26"</span></span>
<span><span class="co">##  [41] "CP33" "CP33" "CP34" "CP34" "CP34" "CP34" "CP34" "CP35" "CP35" "CP35"</span></span>
<span><span class="co">##  [51] "CP35" "CP35" "CP36" "CP41" "CP41" "CP41" "CP42" "CP42" "CP42" "CP42"</span></span>
<span><span class="co">##  [61] "CP42" "CP44" "CP44" "CP46" "CP46" "CP46" "CP46" "CP47" "CP47" "CP47"</span></span>
<span><span class="co">##  [71] "CP48" "CP48" "CP48" "CP50" "CP51" "CP51" "CP51" "CP52" "CP52" "CP52"</span></span>
<span><span class="co">##  [81] "CP53" "CP53" "CP53" "CP53" "CP53" "CP57" "CP57" "CP57" "CP57" "CP57"</span></span>
<span><span class="co">##  [91] "CP59" "CP59" "CP60" "CP60" "CP61" "CP61" "CP63" "CP63" "CP63" "CP63"</span></span>
<span><span class="co">## [101] "CP64" "CP64" "CP64" "CP64" "CP64" "CP65" "CP66" "CP66" "CP66" "CP66"</span></span>
<span><span class="co">## [111] "CP67" "CP67" "CP67" "CP69" "CP69" "CP69" "CP71" "CP71" "CP71" "CP71"</span></span>
<span><span class="co">## [121] "CP72" "CP72" "CP72" "CP73" "CP81" "CP81" "CP81" "CP81" "CP82" "CP82"</span></span>
<span><span class="co">## [131] "CP82" "CP85" "CP85" "CP88" "CP88" "CP89" "CP89" "CP89" "CP90" "CP90"</span></span>
<span><span class="co">## [141] "CP90" "CP91" "CP91" "CP91" "CP93" "CP93" "CP93" "CP93" "CP93" "CP93"</span></span>
<span><span class="co">## [151] "CP94" "CP94" "CP94" "CP94" "CP95" "CP98" "CP98" "CP99"</span></span></code></pre>
<p>We next, like in the previous section, <em>clean up</em> the spectra
removing peaks with an intensity below 5% of the largest peak intensity
per spectrum and removing spectra with a single peak.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Remove peaks with an intensity below 5%</span></span>
<span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">pest_ms2</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Remove peaks with a single peak</span></span>
<span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="va">pest_ms2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>We in addition also scale the peak intensities per spectrum using the
<code><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">scalePeaks()</a></code> function. While most spectra similarity
scoring algorithms are independent of absolute peak intensities, peak
scaling will improve the graphical visualization of results. We perform
the peak scaling to both the experimental as well as the reference
spectra in MassBank.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">scalePeaks</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">scalePeaks</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span></span></code></pre></div>
<p>Next we perform the spectra matching with the same parameters as in
the previous section.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">mbank</span>, param <span class="op">=</span> <span class="va">prm</span><span class="op">)</span></span>
<span><span class="va">pest_match</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 33 </span></span>
<span><span class="co">## Number of query objects: 155 (12 matched)</span></span>
<span><span class="co">## Number of target objects: 103525 (26 matched)</span></span></code></pre>
<p>Again, we restrict the <code>MatchedSpectra</code> to query spectra
which could be matched.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_match</span> <span class="op">&lt;-</span> <span class="va">pest_match</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery</a></span><span class="op">(</span><span class="va">pest_match</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The table below lists the compound names of matching spectra for the
chromatographic peaks.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get the name of the column containing the compound name</span></span>
<span><span class="va">name_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">pest_match</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"target_name"</span>, <span class="st">"target_compound_name"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html" class="external-link">pandoc.table</a></span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="st">"rmarkdown"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">pest_match</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"peak_id"</span>, <span class="st">"rtime"</span>, <span class="va">name_col</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center">peak_id</th>
<th align="center">rtime</th>
<th align="center">target_name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">CP06</td>
<td align="center">327.1</td>
<td align="center">Lenacil</td>
</tr>
<tr class="even">
<td align="center">CP06</td>
<td align="center">327.1</td>
<td align="center">Lenacil</td>
</tr>
<tr class="odd">
<td align="center">CP18</td>
<td align="center">362.6</td>
<td align="center">Azaconazole</td>
</tr>
<tr class="even">
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
</tr>
<tr class="odd">
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
</tr>
<tr class="even">
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
</tr>
<tr class="odd">
<td align="center">CP57</td>
<td align="center">435.4</td>
<td align="center">Fluopicolide</td>
</tr>
<tr class="even">
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center">CP72</td>
<td align="center">455.3</td>
<td align="center">Dimoxystrobin</td>
</tr>
<tr class="odd">
<td align="center">CP88</td>
<td align="center">511</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="even">
<td align="center">CP88</td>
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="odd">
<td align="center">CP88</td>
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="even">
<td align="center">CP88</td>
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="odd">
<td align="center">CP88</td>
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="even">
<td align="center">CP88</td>
<td align="center">512.1</td>
<td align="center">Diflufenican</td>
</tr>
<tr class="odd">
<td align="center">CP95</td>
<td align="center">596.6</td>
<td align="center">Spirodiclofen-enol</td>
</tr>
</tbody>
</table>
<p>We can also directly plot matching (query and target) spectra against
each other using the <code><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror()</a></code> function
subsetting the <code>MatchedSpectra</code> object to the query spectrum
of interest. Below we plot the third query spectrum against all of its
matching target spectra.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">pest_match</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-matching-with-MetaboAnnotation_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Summarizing, with the <code><a href="https://rdrr.io/pkg/xcms/man/chromPeakSpectra.html" class="external-link">chromPeakSpectra()</a></code> and the
<code><a href="https://rdrr.io/pkg/xcms/man/featureSpectra.html" class="external-link">featureSpectra()</a></code> functions, <code>xcms</code> allows to
return MS data as <code>Spectra</code> objects which enables, as shown
in this simple example, to perform MS2 spectra matching using the
<code>Spectra</code> as well as the <code>MetaboAnnotation</code>
packages hence simplifying MS/MS-based annotation of LC-MS features from
<code>xcms</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.4.0 (2024-04-24)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.4 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: Etc/UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] MsExperiment_1.6.0       xcms_4.2.1               MetaboAnnotation_1.8.1  </span></span>
<span><span class="co">##  [4] CompoundDb_1.8.0         AnnotationFilter_1.28.0  AnnotationHub_3.12.0    </span></span>
<span><span class="co">##  [7] BiocFileCache_2.12.0     dbplyr_2.5.0             MsBackendMassbank_1.12.0</span></span>
<span><span class="co">## [10] RMariaDB_1.3.1           pander_0.6.5             Spectra_1.14.0          </span></span>
<span><span class="co">## [13] ProtGenerics_1.36.0      S4Vectors_0.42.0         BiocGenerics_0.50.0     </span></span>
<span><span class="co">## [16] BiocParallel_1.38.0      BiocStyle_2.32.0        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RColorBrewer_1.1-3          jsonlite_1.8.8             </span></span>
<span><span class="co">##   [3] MultiAssayExperiment_1.30.1 magrittr_2.0.3             </span></span>
<span><span class="co">##   [5] MALDIquant_1.22.2           rmarkdown_2.27             </span></span>
<span><span class="co">##   [7] fs_1.6.4                    zlibbioc_1.50.0            </span></span>
<span><span class="co">##   [9] ragg_1.3.2                  vctrs_0.6.5                </span></span>
<span><span class="co">##  [11] memoise_2.0.1               RCurl_1.98-1.14            </span></span>
<span><span class="co">##  [13] base64enc_0.1-3             progress_1.2.3             </span></span>
<span><span class="co">##  [15] htmltools_0.5.8.1           S4Arrays_1.4.0             </span></span>
<span><span class="co">##  [17] curl_5.2.1                  SparseArray_1.4.3          </span></span>
<span><span class="co">##  [19] mzID_1.42.0                 sass_0.4.9                 </span></span>
<span><span class="co">##  [21] bslib_0.7.0                 htmlwidgets_1.6.4          </span></span>
<span><span class="co">##  [23] desc_1.4.3                  plyr_1.8.9                 </span></span>
<span><span class="co">##  [25] impute_1.78.0               lubridate_1.9.3            </span></span>
<span><span class="co">##  [27] cachem_1.1.0                igraph_2.0.3               </span></span>
<span><span class="co">##  [29] iterators_1.0.14            mime_0.12                  </span></span>
<span><span class="co">##  [31] lifecycle_1.0.4             pkgconfig_2.0.3            </span></span>
<span><span class="co">##  [33] Matrix_1.7-0                R6_2.5.1                   </span></span>
<span><span class="co">##  [35] fastmap_1.2.0               GenomeInfoDbData_1.2.12    </span></span>
<span><span class="co">##  [37] MatrixGenerics_1.16.0       clue_0.3-65                </span></span>
<span><span class="co">##  [39] digest_0.6.35               pcaMethods_1.96.0          </span></span>
<span><span class="co">##  [41] rsvg_2.6.0                  colorspace_2.1-0           </span></span>
<span><span class="co">##  [43] AnnotationDbi_1.66.0        textshaping_0.3.7          </span></span>
<span><span class="co">##  [45] GenomicRanges_1.56.0        RSQLite_2.3.6              </span></span>
<span><span class="co">##  [47] filelock_1.0.3              fansi_1.0.6                </span></span>
<span><span class="co">##  [49] timechange_0.3.0            httr_1.4.7                 </span></span>
<span><span class="co">##  [51] abind_1.4-5                 compiler_4.4.0             </span></span>
<span><span class="co">##  [53] doParallel_1.0.17           bit64_4.0.5                </span></span>
<span><span class="co">##  [55] withr_3.0.0                 DBI_1.2.2                  </span></span>
<span><span class="co">##  [57] highr_0.10                  MASS_7.3-60.2              </span></span>
<span><span class="co">##  [59] ChemmineR_3.56.0            rappdirs_0.3.3             </span></span>
<span><span class="co">##  [61] DelayedArray_0.30.1         rjson_0.2.21               </span></span>
<span><span class="co">##  [63] mzR_2.38.0                  tools_4.4.0                </span></span>
<span><span class="co">##  [65] PSMatch_1.8.0               glue_1.7.0                 </span></span>
<span><span class="co">##  [67] QFeatures_1.14.1            grid_4.4.0                 </span></span>
<span><span class="co">##  [69] cluster_2.1.6               reshape2_1.4.4             </span></span>
<span><span class="co">##  [71] generics_0.1.3              gtable_0.3.5               </span></span>
<span><span class="co">##  [73] preprocessCore_1.66.0       tidyr_1.3.1                </span></span>
<span><span class="co">##  [75] hms_1.1.3                   MetaboCoreUtils_1.12.0     </span></span>
<span><span class="co">##  [77] xml2_1.3.6                  utf8_1.2.4                 </span></span>
<span><span class="co">##  [79] XVector_0.44.0              foreach_1.5.2              </span></span>
<span><span class="co">##  [81] BiocVersion_3.19.1          pillar_1.9.0               </span></span>
<span><span class="co">##  [83] stringr_1.5.1               limma_3.60.0               </span></span>
<span><span class="co">##  [85] dplyr_1.1.4                 lattice_0.22-6             </span></span>
<span><span class="co">##  [87] bit_4.0.5                   tidyselect_1.2.1           </span></span>
<span><span class="co">##  [89] Biostrings_2.72.0           knitr_1.46                 </span></span>
<span><span class="co">##  [91] gridExtra_2.3               IRanges_2.38.0             </span></span>
<span><span class="co">##  [93] SummarizedExperiment_1.34.0 xfun_0.44                  </span></span>
<span><span class="co">##  [95] Biobase_2.64.0              statmod_1.5.0              </span></span>
<span><span class="co">##  [97] MSnbase_2.30.1              matrixStats_1.3.0          </span></span>
<span><span class="co">##  [99] DT_0.33                     stringi_1.8.4              </span></span>
<span><span class="co">## [101] UCSC.utils_1.0.0            lazyeval_0.2.2             </span></span>
<span><span class="co">## [103] yaml_2.3.8                  evaluate_0.23              </span></span>
<span><span class="co">## [105] codetools_0.2-20            MsCoreUtils_1.16.0         </span></span>
<span><span class="co">## [107] tibble_3.2.1                BiocManager_1.30.23        </span></span>
<span><span class="co">## [109] affyio_1.74.0               cli_3.6.2                  </span></span>
<span><span class="co">## [111] systemfonts_1.1.0           munsell_0.5.1              </span></span>
<span><span class="co">## [113] jquerylib_0.1.4             MassSpecWavelet_1.70.0     </span></span>
<span><span class="co">## [115] Rcpp_1.0.12                 GenomeInfoDb_1.40.0        </span></span>
<span><span class="co">## [117] png_0.1-8                   XML_3.99-0.16.1            </span></span>
<span><span class="co">## [119] parallel_4.4.0              pkgdown_2.0.9              </span></span>
<span><span class="co">## [121] ggplot2_3.5.1               blob_1.2.4                 </span></span>
<span><span class="co">## [123] prettyunits_1.2.0           bitops_1.0-7               </span></span>
<span><span class="co">## [125] MsFeatures_1.12.0           affy_1.82.0                </span></span>
<span><span class="co">## [127] scales_1.3.0                ncdf4_1.22                 </span></span>
<span><span class="co">## [129] purrr_1.0.2                 crayon_1.5.2               </span></span>
<span><span class="co">## [131] rlang_1.1.3                 vsn_3.72.0                 </span></span>
<span><span class="co">## [133] KEGGREST_1.44.0</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-rainer_modular_2022" class="csl-entry">
Rainer, Johannes, Andrea Vicini, Liesa Salzer, Jan Stanstrup, Josep M.
Badia, Steffen Neumann, Michael A. Stravs, et al. 2022. <span>“A
<span>Modular</span> and <span>Expandable</span> <span>Ecosystem</span>
for <span>Metabolomics</span> <span>Data</span> <span>Annotation</span>
in <span>R</span>.”</span> <em>Metabolites</em> 12 (2): 173. <a href="https://doi.org/10.3390/metabo12020173" class="external-link">https://doi.org/10.3390/metabo12020173</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
