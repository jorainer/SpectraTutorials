name: pkgdown

on:
  repository_dispatch:
    types: [trigger-workflow-2]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container: jorainer/spectra_tutorials:latest
    steps:
      ## Most of these steps are the same as the ones in
      ## https://github.com/r-lib/actions/blob/master/examples/check-standard.yaml
      ## If they update their steps, we will also need to update ours.
      - uses: actions/checkout@v2

      - name: Query dependencies
        run: |
          install.packages('remotes')
          saveRDS(remotes::dev_package_deps(dependencies = TRUE), ".github/depends.Rds", version = 2)
        shell: Rscript {0}

      # - name: Cache R packages
      #   if: runner.os != 'Windows'
      #   uses: actions/cache@v1
      #   with:
      #     path: /usr/local/lib/R/site-library
      #     key: ${{ runner.os }}-r-1-${{ hashFiles('.github/depends.Rds') }}
      #     restore-keys: ${{ runner.os }}-r-1-

      # This lets us augment with additional dependencies
      # - name: Install mysql client
      #   if: runner.os == 'Linux'
      #   run: |
      #     apt-get update
      #     apt-get -y install mariadb-server

      # - name: Install system dependencies
      #   if: runner.os == 'Linux'
      #   env:
      #     RHUB_PLATFORM: linux-x86_64-ubuntu-gcc
      #   run: |
      #     Rscript -e "remotes::install_github('r-hub/sysreqs')"
      #     sysreqs=$(Rscript -e "cat(sysreqs::sysreq_commands('DESCRIPTION'))")
      #     sudo -s eval "$sysreqs"

      # - name: Install dependencies
      #   run: |
      #     options(repos = c(CRAN = "https://cran.r-project.org"))
      #     remotes::install_deps(dependencies = TRUE, repos = BiocManager::repositories())
      #     remotes::install_cran("rcmdcheck")
      #   shell: Rscript {0}

      - name: Install deps
        run: |
          remotes::install_cran("rcmdcheck")
        shell: Rscript {0}

      - name: Check
        env:
          _R_CHECK_CRAN_INCOMING_REMOTE_: false
        run: |
          service mysql start
          Rscript -e "rcmdcheck::rcmdcheck(args = c('--no-manual'), error_on = 'warning', check_dir = 'check')"
        shell: bash {0}

      - name: Install deploy dependencies
        run: |
          apt-get update
          apt-get -y install rsync

      - name: Install pkgdown
        if: github.ref == 'refs/heads/main'
        run: |
          remotes::install_github("r-lib/pkgdown")
        shell: Rscript {0}

      - name: Install package
        if: github.ref == 'refs/heads/main'
        run: R CMD INSTALL .

      - name: Deploy package
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          service mysql start
          Rscript -e "pkgdown::deploy_to_branch(new_process = FALSE)"
        shell: bash {0}
        ## Note that you need to run pkgdown::deploy_to_branch(new_process = FALSE)
        ## at least one locally before this will work. This creates the gh-pages
        ## branch (erasing anything you haven't version controlled!) and
        ## makes the git history recognizable by pkgdown.
