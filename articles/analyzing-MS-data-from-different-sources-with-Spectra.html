<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package • SpectraTutorials</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package">
<meta property="og:description" content="SpectraTutorials">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpectraTutorials</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jorainer/SpectraTutorials/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="analyzing-MS-data-from-different-sources-with-Spectra_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Seamless Integration of Mass Spectrometry Data from Different Sources with the <code>Spectra</code> Package</h1>
                        <h4 class="author">Johannes Rainer<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, Sebastian Gibb<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, Laurent Gatto<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/master/vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd"><code>vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></a></small>
      <div class="hidden name"><code>analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></div>

    </div>

    
    
<p><strong>Last modified:</strong> 2020-10-14 07:56:16<br><strong>Compiled</strong>: Wed Oct 14 08:04:49 2020</p>
<div id="abstract" class="section level1">
<h1 class="hasAnchor">
<a href="#abstract" class="anchor"></a>Abstract</h1>
<p>Mass spectrometry (MS) data is a key technology in modern proteomics and metabolomics experiments. Due to continuous improvements in MS instrumentation, the generated data can easily become very large. Also, different additional resources of MS data exist, such as spectra libraries and databases, all with their own specific file formats that sometimes do not support manipulations of the original data.</p>
<p>Learning from experiences with the <em><a href="https://bioconductor.org/packages/3.12/MSnbase">MSnbase</a></em> Bioconductor package we developed a novel infrastructure to handle MS spectral data in R, the <code>r Biocpkg("Spectra")</code> package. This package implements a clear separation of user functionality from code to provide, store and import mass spectrometry data. Different <em>backends</em> can hence be used that enable access to data from various data resources or that are designed specifically for very large MS data sets. Data manipulations are by default not directly applied to the data but cached in a <em>lazy processing queue</em> which allows analyses also of <em>read-only</em> data representations.</p>
<p>This workshop shows the expandability of the new infrastructure to enable a seamless integration and analysis of MS data from a variety of input formats illustrated by a simple matching of experimental MS2 spectra against a public spectral database and export of the data in a format commonly used for exchange of MS2 data.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>The source code of this tutorial is available at <a href="https://github.com/jorainer/SpectraTutorials">https://github.com/jorainer/SpectraTutorials</a>. A recent version or <a href="https://r-project.org">R</a> (4.0 or higher) and a set of R and Bioconductor packages are required to run the tutorial. These can be installed with the R code shown below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"devtools"</span>, <span class="st">"rmarkdown"</span>, <span class="st">"BiocManager"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BiocStyle"</span>,
                       <span class="st">"MsCoreUtils"</span>,
                       <span class="st">"Spectra"</span>,
                       <span class="st">"pheatmap"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span><span class="op">(</span><span class="st">"RforMassSpectrometry/MsBackendHmdb"</span><span class="op">)</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span><span class="op">(</span><span class="st">"RforMassSpectrometry/MsBackendMgf"</span><span class="op">)</span></pre></div>
<p>To run the tutorial locally: - clone <a href="https://github.com/jorainer/SpectraTutorials">this github repository</a>, e.g. with <code>git clone https://github.com/jorainer/SpectraTutorials</code>. - to run also the code to import the MS2 spectra from HMDB the <em>All Spectra Files (XML)</em> from the <a href="https://hmdb.ca/downloads">hmdb downloads page</a> has to be downloaded. The contents of the <em>hmdb_all_spectra.zip</em> archive should then be unzipped into the folder <em>data/hmdb_all_spectra</em>.</p>
<p>Alternatively, a <a href="https://www.docker.com/">docker</a> image with all necessary packages pre-installed is available <a href="https://hub.docker.com/r/jorainer/spectra_tutorials">here</a>. This can be installed with <code>docker pull jorainer/spectra_tutorials:latest</code>.</p>
<p>To run the docker use:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>docker run \</span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="op">-</span>e PASSWORD=bioc \</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="op">-</span>p <span class="dv">8787</span><span class="op">:</span><span class="dv">8787</span> \</span>
<span id="cb2-4"><a href="#cb2-4"></a>    jorainer<span class="op">/</span>spectra_tutorials<span class="op">:</span>latest</span></code></pre></div>
<p>Interaction with the R within the running docker container is then possible by entering the address <code>http://localhost:8787/</code> in a web browser and logging in with user <code>rstudio</code> password <code>bioc</code>. This gives access to a RStudio instance running within the container.</p>
</div>
<div id="analysing-ms-data-with-spectra" class="section level1">
<h1 class="hasAnchor">
<a href="#analysing-ms-data-with-spectra" class="anchor"></a>Analysing MS data with <code>Spectra</code>
</h1>
<p>The <code>Spectra</code> package implements a clear separation of user functionality from code to provide, store and read mass spectrometry data. Thus, different data or file format-specific <em>backends</em> can be implemented and directly <em>plugged-in</em> without affecting the way the user would access or analyze the data. This represents an extension to the <em>in-memory</em> and <em>on-disk</em> data modes in the <code>r Biocpkg("MSnbase")</code> package that enabled either fast data processings or analysis of very large data sets by keeping only a limited amount of data in the computer’s memory <span class="citation">(Gatto, Gibb, and Rainer 2020)</span>.</p>
<p>In this workshop we will import MS data from mzML files, match the MS2 fragment spectra for one ion against MS2 spectra from a public database (i.e. the Human Metabolome Database <a href="https://hmdb.ca">HMDB</a>) and export the data as a MGF file. For each of the data sources and the export file format we will use a specific backend.</p>
<p>Below we import the MS data from the mzML files provided within this package. These files contain MSn data of a mix of 8 standard compounds (solved either in water or a pool of human serum samples) measured with a HILIC-based LC-MS/MS setup. MS2 data was generated by data dependent acquisition using two different collision energies. For data import and representation we use the <code>MsBackendMzR</code> backend which supports import (and export) of data from the most common <em>raw</em> mass spectrometry file formats (i.e. mzML, mzXML and CDF).</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"mzML"</span>, package <span class="op">=</span> <span class="st">"SpectraTutorials"</span><span class="op">)</span>,
           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The MS data is represented by a <code>Spectra</code> object, which can be thought of as being a <code>data.frame</code> containing MS data, columns being the spectra variables (such as <code>"rtime"</code>, i.e. the retention time) and rows the individual spectra. Individual spectra variables can be accessed either via <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> and their name or using their dedicated access functions (which is the preferred way). Below we access the retention times of the first spectra using either <code>rtime</code> or <code>$rtime</code>. Note that we could use the <code>spectraVariables</code> function on our object to get the full listing of all available spectra variables.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">rtime</span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">$</span><span class="va">rtime</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<p>Our <code>Spectra</code> object contains information from in total 3203 spectra from <code><a href="https://rdrr.io/r/base/length.html">length(unique(dataOrigin(sps_all)))</a></code> mzML files. By using the <code>MsBackendMzR</code> backend only general information about each spectrum is kept in memory resulting in a low memory footprint.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></pre></div>
<pre><code>## 0.8 Mb</code></pre>
<p>We can also load the full data into memory by changing the backend from <code>MsBackendMzR</code> to <code>MsBackendDataFrame</code>. This does not affect the way how we can use the <code>Spectra</code> object itself. The same operations and functions are available to us, independently of the way how the data is stored (i.e. which backend is used).</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">setBackend</a></span><span class="op">(</span><span class="va">sps_all</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The size of our <code>Spectra</code> object is now however larger, since the full data has been loaded into memory.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></pre></div>
<pre><code>## 35.9 Mb</code></pre>
<p>Next we subset our data to MS2 spectra with a precursor ion that matches the m/z of the [M+H]+ ion of the metabolite Cystine (accepting a difference of 10 parts-per-million (ppm)).</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">mz</span> <span class="op">&lt;-</span> <span class="fl">241.0311</span>

<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu">filterPrecursorMz</span><span class="op">(</span><span class="va">sps_all</span>, mz <span class="op">=</span> <span class="va">mz</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">ppm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">mz</span>, <span class="va">mz</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps</span></pre></div>
<pre><code>## MSn data (Spectra) with 11 spectra in a MsBackendDataFrame backend:
##      msLevel     rtime scanIndex
##    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1          2   209.936       673
## 2          2   220.072       714
## 3          2   231.604       734
## 4          2   211.481       687
## 5          2   224.634       718
## 6          2   236.326       731
## 7          2   215.089       761
## 8          2   225.739       781
## 9          2   240.020       804
## 10         2   212.161       771
## 11         2   224.662       801
##  ... 33 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendDataFrame [Wed Oct 14 08:04:55 2020]
##  Filter: select spectra with a precursor m/z within [241.028689689, 241.033510311] [Wed Oct 14 08:04:55 2020]</code></pre>
<p>We could identify 11 spectra matching our condition. The plot below shows the first spectrum.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/raw-ms2-1.png" width="672"></p>
<p>The spectrum contains still very low abundance peaks, most likely representing noise. Thus we next filter the spectra removing all peaks with an intensity smaller 5% of the maximum intensity of each spectrum. To this end we define a function that takes intensity values from each spectrum and returns a logical value whether the peak should be kept (<code>TRUE</code>) or not (<code>FALSE</code>). This function is passed along to the <code>filterIntensity</code> function.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span>
<span class="op">}</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">filterIntensity</a></span><span class="op">(</span><span class="va">sps</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></pre></div>
<p>In addition we <em>normalize</em> each spectrum replacing the absolute intensity values to relative values related to the maximum intensity (which is set to 100). For this operation we also define a function which is applied to the peak matrix of each spectrum by passing it as parameter <code>FUN</code> to the <code>addProcessing</code> function.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">norm_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">maxint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="va">maxint</span>
    <span class="va">x</span>
<span class="op">}</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">addProcessing</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">norm_int</span><span class="op">)</span></pre></div>
<p>To show the effect of the normalization we extract the intensities of the first spectrum:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu">intensity</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></pre></div>
<pre><code>## [1]  13.439402  93.631648  49.287979 100.000000   9.422415   6.581111  12.969807
## [8]  54.633224</code></pre>
<p>We next perform a pairwise comparison of the spectra using the dot product as the similarity measure to evaluate whether all spectra are the same or represent different fragmentations. Prior to the similarity calculation the peaks of the individual spectra have to be matched against each other (based on their m/z). We specify <code>ppm = 20</code> so that peaks with a difference in m/z smaller than 20ppm will be considered matching.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></pre></div>
<p>The similarity of the spectra with each other is represented in the heatmap below.</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>
<span class="va">hm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span><span class="va">cormat</span>, cutree_rows <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/ms2-heatmap-1.png" width="672"></p>
<p>The spectra group into 3 clusters, which are related to the collision energy used for the fragmentation (see below; the collision energy is encoded in the file name as CE20 and CE30). We subsequently reduce our dataset to the cluster with the spectra generated with a collision energy of 20.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hm</span><span class="op">$</span><span class="va">tree_row</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## $`1`
## [1] "HighIS_Mix06_CE20_POS.mzML"    "HighIS_Mix06_CE20_POS.mzML"   
## [3] "HighIS_Mix06_CE20_POS.mzML"    "QC_HighIS_Mix06_CE20_POS.mzML"
## [5] "QC_HighIS_Mix06_CE20_POS.mzML" "QC_HighIS_Mix06_CE20_POS.mzML"
## 
## $`2`
## [1] "HighIS_Mix06_CE30_POS.mzML"    "HighIS_Mix06_CE30_POS.mzML"   
## [3] "QC_HighIS_Mix06_CE30_POS.mzML"
## 
## $`3`
## [1] "HighIS_Mix06_CE30_POS.mzML"    "QC_HighIS_Mix06_CE30_POS.mzML"</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">sps_ce20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hm</span><span class="op">$</span><span class="va">tree_row</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></pre></div>
<p>Although the precursor m/z of our spectra matches the m/z of Cystine, we can not be sure that they might not represent fragmentation of ions from other compounds. We thus aim to compare our experimental MS2 spectra against spectra from a public database, for our example the Human Metabolome Database (HMDB). Predicted and experimental MS2 spectra are provided by HMDB as individual xml files in a custom file format which are bundled (and can hence be downloaded) in a single archive. The <code>MsBackendHmdbXml</code> backend (provided by the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb">MsBackendHmdb</a> package) allows to import spectral data from these xml files. To reproduce the following code it is expected (as detailed in the Installation section) that all xml files from HMDB are available in a folder <em>data/hmdb_all_spectra</em>. Below we identify all xml files containing the key word <code>"ms_ms"</code> in their file name and load them into a <code>Spectra</code> object using the <code>MsBackendHmdbXml</code> backend. Note that this import operation from ~ 500,000 individual xml files takes a long time.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendHmdb">MsBackendHmdb</a></span><span class="op">)</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"data/hmdb_all_spectra/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">"ms_ms"</span><span class="op">)</span>
<span class="va">hmdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendHmdb/man/MsBackendHmdbXml.html">MsBackendHmdbXml</a></span><span class="op">(</span><span class="op">)</span>, nonStop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p>With this we have now also <code>Spectra</code> object containing all MS2 spectra from HMDB.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">hmdb</span></pre></div>
<pre><code>## MSn data (Spectra) with 458963 spectra in a MsBackendHmdbXml backend:
##          msLevel     rtime scanIndex
##        &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1              2        NA        NA
## 2              2        NA        NA
## 3              2        NA        NA
## 4              2        NA        NA
## 5              2        NA        NA
## ...          ...       ...       ...
## 458959         2        NA        NA
## 458960         2        NA        NA
## 458961         2        NA        NA
## 458962         2        NA        NA
## 458963         2        NA        NA
##  ... 21 more variables/columns.</code></pre>
<p>To avoid comparing our experimental spectra against all these ~500,000 spectra, we first determine using the <code>containsMz</code> function which of the HMDB spectra contain a peak matching the m/z of our ion of interest. We have to use a rather large <code>tolerance</code> value (which defines the maximal acceptable absolute difference in m/z values) since some of the experimental spectra in HMDB seem to be recorded by not well calibrated instruments.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">has_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">containsMz</a></span><span class="op">(</span><span class="va">hmdb</span>, mz <span class="op">=</span> <span class="va">mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></pre></div>
<p>In total 46772 spectra contain a peak with the required m/z (+/- 0.2 dalton) and we can proceed to calculate spectral similarities between our experimental spectra and this subset from HMDB.</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="va">hmdb_with_mz</span> <span class="op">&lt;-</span> <span class="va">hmdb</span><span class="op">[</span><span class="va">has_mz</span><span class="op">]</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps_ce20</span>, <span class="va">hmdb_with_mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></pre></div>
<p>The highest similarity between our spectra and the spectra from HMDB is <code>r max(res)</code>. Below we compare the two best matching spectra with a <em>mirror plot</em>, in the upper panel showing our experimental spectrum and in the lower panel the best matching MS2 spectrum from HMDB.</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## Specifying a function to draw peak labels</span>
<span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu">mz</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps_ce20</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">hmdb_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span>,
                  labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.2</span>,
                  labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/mirror-plot-1.png" width="672"></p>
<p>Our experimental spectrum seems to nicely match the <em>reference</em> MS2 in HMDB. Below we extract its compound identifier from the HMDB spectrum (stored in a spectra variable called <code>"compound_id"</code>) and add it as an additional spectra variable <code>"hmdb_id"</code> to our experimental spectra. We also set the collision energy for these spectra to 20eV.</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="va">sps_ce20</span><span class="op">$</span><span class="va">hmdb_id</span> <span class="op">&lt;-</span> <span class="va">hmdb_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">compound_id</span>
<span class="va">sps_ce20</span><span class="op">$</span><span class="va">collisionEnergy</span> <span class="op">&lt;-</span> <span class="fl">20</span></pre></div>
<p>In fact, the matching spectrum from HMDB is an experimental spectrum for <a href="https://hmdb.ca/metabolites/HMDB0000192">L-Cystine</a>.</p>
<p>At last we want to export our spectra to a file in MGF format. The <code>Spectra</code> package does however not have any built-in support for this file format. The required functionality is implemented in the <a href="https://github.com/RforMassSpectrometry/MsBackendMgf">MsBackendMgf</a> R package and can thus be added to <code>Spectra</code> by using <code>MsBackendMgf</code> backend provided by that package.</p>
<p>Data from <code>Spectra</code> objects can be exported with the <code>export</code> function. The format in which the data is exported depends on the specified <code>MsBackend</code> class. By using an instance of <code>MsBackendMgf</code> we can write the data to a file in MGF format.</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf">MsBackendMgf</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">export</a></span><span class="op">(</span><span class="va">sps_ce20</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"Cystine_ce20.mgf"</span><span class="op">)</span></pre></div>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>With the simple use case of matching experimental MS2 spectra against a public database we illustrated in this short tutorial the flexibility and expandability of the <code>Spectra</code> package that enables the seamless integration of mass spectrometry data from different sources. This was only possible with a clear separation of the user functionality (<code>Spectra</code> object) from the representation of the data (<code>MsBackend</code> object). Backends such as the <a href="https://github.com/RforMassSpectrometry/MsBackendMgf"><code>MsBackendMgf</code></a> or <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb"><code>MsBackendHmdbXml</code></a> can provide support for additional data formats or data sources, while others, due to their much lower memory footprint (<code>MsBackendMzR</code>, <code>MsBackendHdf5Peaks</code>), enable the analysis of also very large data sets. Most importantly however, these backends are interchangeable and do not affect the way users can handle and analyze MS data with the <code>Spectra</code> package.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-gattoMSnbaseEfficientElegant2020a">
<p>Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020. “MSnbase, Efficient and Elegant R-Based Processing and Visualization of Raw Mass Spectrometry Data.” <em>Journal of Proteome Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313">https://doi.org/10.1021/acs.jproteome.0c00313</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Institute for Biomedicine, Eurac Research, Bolzano, Italy; <a href="mailto:johannes.rainer@eurac.edu" class="email">johannes.rainer@eurac.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Department of Anaesthesiology and Intensive Care, University Medicine Greifswald, Germany<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Computational Biology Unit, de Duve Institute, UCLouvain, Brussels, Belgium<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Johannes Rainer, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
