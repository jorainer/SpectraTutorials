<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SpectraTutorials">
<title>Spectra: an expandable infrastructure to handle mass spectrometry data • SpectraTutorials</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spectra: an expandable infrastructure to handle mass spectrometry data">
<meta property="og:description" content="SpectraTutorials">
<meta property="og:image" content="https://jorainer.github.io/SpectraTutorials/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SpectraTutorials</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Spectra-backends.html">Spectra: an expandable infrastructure to handle mass spectrometry data</a>
    <a class="dropdown-item" href="../articles/Spectra-matching-with-MetaboAnnotation.html">MS/MS Spectra Matching with the `MetaboAnnotation` Package</a>
    <a class="dropdown-item" href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jorainer/SpectraTutorials/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Spectra: an expandable infrastructure to handle mass spectrometry data</h1>
                        <h4 data-toc-skip class="author">Johannes
Rainer<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Institute for Biomedicine, Eurac Research, Bolzano,
Italy; &lt;a href="mailto:johannes.rainer@eurac.edu" class="email"&gt;johannes.rainer@eurac.edu&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>,
Sebastian Gibb<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Department of Anaesthesiology and Intensive Care,
University Medicine Greifswald, Germany&lt;/p&gt;"><sup>2</sup></a>, Laurent Gatto<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Computational Biology Unit, de Duve Institute,
UCLouvain, Brussels, Belgium&lt;/p&gt;"><sup>3</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/HEAD/vignettes/Spectra-backends.Rmd" class="external-link"><code>vignettes/Spectra-backends.Rmd</code></a></small>
      <div class="d-none name"><code>Spectra-backends.Rmd</code></div>
    </div>

    
    
<p><strong>Last modified:</strong> 2023-12-05 09:09:17.874995<br><strong>Compiled</strong>: Tue Dec 5 09:13:59 2023</p>
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>Mass spectrometry (MS) data is a key technology in modern
metabolomics and proteomics experiments. Continuous improvements in MS
instrumentation, larger experiments and new technological developments
lead to ever growing data sizes and increased number of available
variables making standard in-memory data handling and processing
difficult.</p>
<p>The <em><a href="https://bioconductor.org/packages/3.18/Spectra" class="external-link">Spectra</a></em>
package provides a modern infrastructure for MS data handling
specifically designed to enable extension to additional data resources
or alternative data representations. These can be realized by extending
the virtual <code>MsBackend</code> class and its related methods.
Implementations of such <code>MsBackend</code> classes can be tailored
for specific needs, such as low memory footprint, fast processing,
remote data access, or also support for specific additional data types
or variables. Importantly, data processing of <code>Spectra</code>
objects is independent of the backend in use due to a lazy evaluation
mechanism that caches data manipulations internally.</p>
<p>This workshop discusses different available data representations for
MS data along with their properties, advantages and performances. In
addition, <em>Spectra</em>’s concept of lazy evaluation for data
manipulations is presented, as well as a simple caching mechanism for
data modifications. Finally, it explains how new <code>MsBackend</code>
instances can be implemented and tested to ensure compliance.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This workshop/tutorial assumes that readers are familiar with mass
spectrometry data. See the <a href="https://jorainer.github.io/SpectraTutorials/articles/analyzing-MS-data-from-different-sources-with-Spectra.html#lc-msms-in-a-nutshell"><em>LC-MS/MS
in a nutshell</em></a> section of the <em>Seamless Integration of Mass
Spectrometry Data from Different Sources</em> vignette in this package
for a general introduction to MS.</p>
<div class="section level3">
<h3 id="pre-requisites">Pre-requisites<a class="anchor" aria-label="anchor" href="#pre-requisites"></a>
</h3>
<ul>
<li>Basic familiarity with R and Bioconductor.</li>
<li>Basic understanding of Mass Spectrometry (MS) data.</li>
</ul>
</div>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<ul>
<li><p>Get the <a href="https://hub.docker.com/r/jorainer/spectra_tutorials" class="external-link">docker
image</a> of this tutorial with
<code>docker pull jorainer/spectra_tutorials:latest</code>.</p></li>
<li>
<p>Start docker using</p>
<pre><code>docker run \
    -e PASSWORD=bioc \
    -p 8787:8787 \
    jorainer/spectra_tutorials:latest</code></pre>
</li>
<li><p>Enter <code>http://localhost:8787</code> in a web browser and log
in with username <code>rstudio</code> and password
<code>bioc</code>.</p></li>
<li><p>Open this R-markdown file
(<em>vignettes/Spectra-backends.Rmd</em>) in the RStudio server version
in the web browser and evaluate the R code blocks.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="rbioconductor-packages-used">R/Bioconductor packages used<a class="anchor" aria-label="anchor" href="#rbioconductor-packages-used"></a>
</h3>
<ul>
<li><a href="https://bioconductor.org/packages/Spectra" class="external-link"><code>Spectra</code></a></li>
<li><a href="https://bioconductor.org/packages/MsBackendSql" class="external-link"><code>MsBackendSql</code></a></li>
</ul>
</div>
<div class="section level3">
<h3 id="workshop-goals-and-objectives">Workshop goals and objectives<a class="anchor" aria-label="anchor" href="#workshop-goals-and-objectives"></a>
</h3>
<p>This is a technical demonstration of the internals of the
<em>Spectra</em> package and the design of its MS infrastructure. We’re
not demonstrating any use cases or analysis workflows here.</p>
<div class="section level4">
<h4 id="learning-goals">Learning goals<a class="anchor" aria-label="anchor" href="#learning-goals"></a>
</h4>
<ul>
<li>Understand how MS data is handled with <em>Spectra</em>.</li>
<li>Understand differences and properties of different
<code>MsBackend</code> implementations.</li>
</ul>
</div>
<div class="section level4">
<h4 id="learning-objectives">Learning objectives<a class="anchor" aria-label="anchor" href="#learning-objectives"></a>
</h4>
<ul>
<li>Learn how MS data is handled with <em>Spectra</em>.</li>
<li>Understand which data representations/backends fit which purpose/use
case.</li>
<li>Insights into the internals of the <em>Spectra</em> MS
infrastructure to facilitate implementation of own backend(s).</li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="workshop">Workshop<a class="anchor" aria-label="anchor" href="#workshop"></a>
</h2>
<div class="section level3">
<h3 id="the-spectra-package">The <em>Spectra</em> package<a class="anchor" aria-label="anchor" href="#the-spectra-package"></a>
</h3>
<ul>
<li>
<strong>Purpose</strong>: provide an expandable, well tested and
user-friendly infrastructure for mass spectrometry (MS) data.</li>
<li>
<strong>Design</strong>: separation of code representing the main
user interface and code to provide, store and read MS data.</li>
</ul>
<div class="float">
<img src="Spectra.png" alt="Spectra: separation into user functionality and data representation"><div class="figcaption">Spectra: separation into user functionality and
data representation</div>
</div>
<ul>
<li>
<code>Spectra</code>: main interface for the end user.</li>
<li>
<code>MsBackend</code>: defines how and where data is stored and how
it is managed.</li>
<li>
<strong>Why?</strong>:
<ul>
<li>the user does not need to care about where or how the data is
stored.</li>
<li>the same functionality can be applied to MS data, regardless of
where and how the data is stored.</li>
<li>enables specialized data storage/representation options: remote
data, low memory footprint, high performance.</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="creating-and-using-spectra-objects">Creating and using <code>Spectra</code> objects<a class="anchor" aria-label="anchor" href="#creating-and-using-spectra-objects"></a>
</h3>
<p>MS data consists of duplets of mass-to-charge (<em>m/z</em>) and
intensity values along with potential additional information, such as
the MS level, retention time, polarity etc. In its simplest form, MS
data consists thus of two (aligned) numeric vectors with the
<em>m/z</em> and intensity values and an e.g. <code>data.frame</code>
containing potential additional annotations for a MS spectrum. In
<code>Spectra</code> terminology, <code>"mz"</code> and
<code>"intensity"</code> are called <em>peak variables</em> (because
they provide information on individual mass peaks), and all other
annotations <em>spectra variables</em> (usually being a single value per
spectrum).</p>
<p>Below we define <em>m/z</em> and intensity values for a mass spectrum
as well as a <code>data.frame</code> with additional <em>spectra
variables</em>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define simple MS data</span></span>
<span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">56.0494</span>, <span class="fl">69.0447</span>, <span class="fl">83.0603</span>, <span class="fl">109.0395</span>, <span class="fl">110.0712</span>,</span>
<span>        <span class="fl">111.0551</span>, <span class="fl">123.0429</span>, <span class="fl">138.0662</span>, <span class="fl">195.0876</span><span class="op">)</span></span>
<span><span class="va">int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.459</span>, <span class="fl">2.585</span>, <span class="fl">2.446</span>, <span class="fl">0.508</span>, <span class="fl">8.968</span>, <span class="fl">0.524</span>, <span class="fl">0.974</span>, <span class="fl">100.0</span>, <span class="fl">40.994</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>msLevel <span class="op">=</span> <span class="fl">1L</span>, polarity <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<p>This would be a basic representation of MS data in R. For obvious
reasons it is however better to store such data in a single
<em>container</em> than keeping it in separate, unrelated, variables. We
thus create below a <code>Spectra</code> object from this MS data.
<code>Spectra</code> objects can be created with the
<code>Spectra</code> constructor function that accepts (among other
possibilities) a <code>data.frame</code> with the full MS data as input.
Each row in that <code>data.frame</code> is expected to contain data
from one spectrum. We therefore need to add the <em>m/z</em> and
intensity values as a <code>list</code> of numerical vectors to our data
frame.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' wrap m/z and intensities into a list and add them to the data.frame</span></span>
<span><span class="va">sv</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mz</span><span class="op">)</span></span>
<span><span class="va">sv</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">int</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Create a `Spectra` object from the data.</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">sv</span><span class="op">)</span></span>
<span><span class="va">s</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         1        NA        NA</span></span>
<span><span class="co">##  ... 16 more variables/columns.</span></span></code></pre>
<p>We have now created a <code>Spectra</code> object representing our
toy MS data. Individual spectra variables can be accessed with either
<code>$</code> and the name of the spectra variable, or with one of the
dedicated accessor functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access the MS level spectra variable</span></span>
<span><span class="va">s</span><span class="op">$</span><span class="va">msLevel</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>Also, while we provided only the spectra variables
<code>"msLevel"</code> and <code>"polarity"</code> with out input data
frame, more variables are available by default for a
<code>Spectra</code> object. These are called <em>core spectra
variables</em> and they can <strong>always</strong> be extracted from a
<code>Spectra</code> object, even if they are not defined (in which case
missing values are returned). Spectra variables available from a
<code>Spectra</code> object can be listed with the
<code>spectraVariables</code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' List all available spectra variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract the retention time spectra variable</span></span>
<span><span class="va">s</span><span class="op">$</span><span class="va">rtime</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] NA</span></span></code></pre>
<p>We’ve now got a <code>Spectra</code> object representing a single MS
spectrum - but, as the name of the class implies, it is actually
designed to represent data from multiple mass spectra (possibly from a
whole experiment). Below we thus define again a <code>data.frame</code>,
this time with 3 rows, and create a <code>Spectra</code> object from
that. Also, we define some additional spectra variables providing the
name and ID of the compounds the MS2 (fragment) spectrum represents.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define spectra variables for 3 MS spectra.</span></span>
<span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>    polarity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0001847"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1-Methylhistidine"</span>, <span class="st">"1-Methylhistidine"</span>, <span class="st">"Caffeine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Assign m/z and intensity values.</span></span>
<span><span class="va">sv</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">109.2</span>, <span class="fl">124.2</span>, <span class="fl">124.5</span>, <span class="fl">170.16</span>, <span class="fl">170.52</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">83.1</span>, <span class="fl">96.12</span>, <span class="fl">97.14</span>, <span class="fl">109.14</span>, <span class="fl">124.08</span>, <span class="fl">125.1</span>, <span class="fl">170.16</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">56.0494</span>, <span class="fl">69.0447</span>, <span class="fl">83.0603</span>, <span class="fl">109.0395</span>, <span class="fl">110.0712</span>,</span>
<span>      <span class="fl">111.0551</span>, <span class="fl">123.0429</span>, <span class="fl">138.0662</span>, <span class="fl">195.0876</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sv</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.407</span>, <span class="fl">47.494</span>, <span class="fl">3.094</span>, <span class="fl">100.0</span>, <span class="fl">13.240</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.685</span>, <span class="fl">4.381</span>, <span class="fl">3.022</span>, <span class="fl">16.708</span>, <span class="fl">100.0</span>, <span class="fl">4.565</span>, <span class="fl">40.643</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.459</span>, <span class="fl">2.585</span>, <span class="fl">2.446</span>, <span class="fl">0.508</span>, <span class="fl">8.968</span>, <span class="fl">0.524</span>, <span class="fl">0.974</span>, <span class="fl">100.0</span>, <span class="fl">40.994</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Create a Spectra from this data.</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">sv</span><span class="op">)</span></span>
<span><span class="va">s</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 3 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">##  ... 18 more variables/columns.</span></span></code></pre>
<p>Now we have a <code>Spectra</code> object representing 3 mass spectra
and a set of spectra and peak variables.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' List available spectra and peaks variables.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "id"                     </span></span>
<span><span class="co">## [19] "name"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksVariables</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mz"        "intensity"</span></span></code></pre>
<p>Spectra are organized linearly, i.e., one after the other. Thus, our
<code>Spectra</code> has a length of 3 with each element being one
spectrum. Subsetting works as for any other R object:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract the 2nd spectrum</span></span>
<span><span class="va">s</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">##  ... 18 more variables/columns.</span></span></code></pre>
<p>A <code>Spectra</code> <em>behaves</em> similar to a
<code>data.frame</code> with elements (<em>rows</em>) being individual
spectra and <em>columns</em> being the spectra (or peaks) variables,
that can be accessed with the <code>$</code> operator.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span><span class="op">$</span><span class="va">msLevel</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 2 2</span></span></code></pre>
<p>Similar to a <code>data.frame</code> we can also add new spectra
variables (columns) using <code>$&lt;-</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Add a new spectra variable.</span></span>
<span><span class="va">s</span><span class="op">$</span><span class="va">new_variable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "id"                     </span></span>
<span><span class="co">## [19] "name"                    "new_variable"</span></span></code></pre>
<p>The full peak data can be extracted with the <code>peaksData</code>
function, that returns a <code>list</code> of two-dimensional arrays
with the values of the peak variables. Each list element represents the
peak data from one spectrum, which is stored in a
e.g. <code>matrix</code> with columns being the peak variables and rows
the respective values for each peak. The number of rows of such peak
variable arrays depends on the number of mass peaks of each spectrum.
This number can be extracted using <code>lengths</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get the number of peaks per spectrum.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5 7 9</span></span></code></pre>
<p>We next extract the peaks’ data of our <code>Spectra</code> and
subset that to data from the second spectrum.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract the peaks matrix of the second spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,]  83.10     6.685</span></span>
<span><span class="co">## [2,]  96.12     4.381</span></span>
<span><span class="co">## [3,]  97.14     3.022</span></span>
<span><span class="co">## [4,] 109.14    16.708</span></span>
<span><span class="co">## [5,] 124.08   100.000</span></span>
<span><span class="co">## [6,] 125.10     4.565</span></span>
<span><span class="co">## [7,] 170.16    40.643</span></span></code></pre>
<p>Finally, we can also visualize the peak data of a spectrum in the
<code>Spectra</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Plot the second spectrum.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-backends_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Such plots could also be created <em>manually</em> from the
<em>m/z</em> and intensity values, but built-in functions are in most
cases more efficient.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"h"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"m/z"</span>, ylab <span class="op">=</span> <span class="st">"intensity"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-backends_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Experimental MS data is generally (ideally) stored in files in mzML,
mzXML or CDF format. These are open file formats that can be read by
most software. In Bioconductor, the <em><a href="https://bioconductor.org/packages/3.18/mzR" class="external-link">mzR</a></em> package
allows to read/write data in/to these formats. Also <em>Spectra</em>
allows to represent data from such raw data files. To illustrate this we
below create a <code>Spectra</code> object for from two mzML files that
are provided in Bioconductor’s <em><a href="https://bioconductor.org/packages/3.18/msdata" class="external-link">msdata</a></em>
package.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Import MS data from 2 mzML files.</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##        msLevel     rtime scanIndex</span></span>
<span><span class="co">##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1     0.280         1</span></span>
<span><span class="co">## 2            1     0.559         2</span></span>
<span><span class="co">## 3            1     0.838         3</span></span>
<span><span class="co">## 4            1     1.117         4</span></span>
<span><span class="co">## 5            1     1.396         5</span></span>
<span><span class="co">## ...        ...       ...       ...</span></span>
<span><span class="co">## 1858         1   258.636       927</span></span>
<span><span class="co">## 1859         1   258.915       928</span></span>
<span><span class="co">## 1860         1   259.194       929</span></span>
<span><span class="co">## 1861         1   259.473       930</span></span>
<span><span class="co">## 1862         1   259.752       931</span></span>
<span><span class="co">##  ... 33 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## 20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 20171016_POOL_POS_3_105-134.mzML</span></span></code></pre>
<p>We have thus access to the raw experimental MS data through this
<code>Spectra</code> object. In contrast to the first example above, we
used here the <code>Spectra</code> constructor providing a
<code>character</code> vector with the file names and specified
<code>source = MsBackendMzR()</code>. This anticipates the concept of
backends in the <em>Spectra</em> package: the <code>source</code>
parameter of the <code>Spectra</code> call defines the backend to use to
import (or represent) the data, which is in our example the
<code>MsBackendMzR</code> that enables import of data from mzML
files.</p>
<p>Like in our first example, we can again subset the object or access
any of its spectra variables. Note however that in this
<code>Spectra</code> object we have many more spectra variables
available (depending on what is provided by the raw data files).</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Available spectra variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access the MS levels for the first 6 spectra</span></span>
<span><span class="va">s2</span><span class="op">$</span><span class="va">msLevel</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1 1 1 1 1</span></span></code></pre>
<p>And we can again visualize the data.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Plot the 4th spectrum.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">s2</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-backends_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="use-of-different-backends-with-spectra-why-and-how">Use of different <em>backends</em> with <code>Spectra</code>, why
and how?<a class="anchor" aria-label="anchor" href="#use-of-different-backends-with-spectra-why-and-how"></a>
</h3>
<p>While both <code>Spectra</code> objects <em>behave</em> the same way,
i.e. all data can be accessed in the same fashion, they actually use
different <em>backends</em> and thus data representations:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">backend</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "MsBackendMemory"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Spectra"</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">s2</span><span class="op">@</span><span class="va">backend</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "MsBackendMzR"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Spectra"</span></span></code></pre>
<p>Our first example <code>Spectra</code> uses a
<code>MsBackendMemory</code> backend that, as the name tells, keeps all
MS data in memory (within the backend object). In contrast, the second
<code>Spectra</code> which represents the experimental MS data from the
two mzML files uses the <code>MsBackendMzR</code> backend. This backend
loads only general spectra data (variables) into memory while it imports
the peak data only <em>on-demand</em> from the original data files when
needed/requested (similar to the <em>on-disk</em> mode discussed in
<span class="citation">(Gatto, Gibb, and Rainer 2020)</span>). The
advantage of this <em>offline</em> storage mode is a lower memory
footprint that enables also the analysis of large data experiments on
<em>standard</em> computers.</p>
<p><strong>Why different backends?</strong></p>
<p><strong>Reason 1</strong>: support for additional file formats. The
backend class defines the functionality to import/export data from/to
specific file formats. The <code>Spectra</code> class stays <em>data
storage agnostic</em> and e.g. no import/export routines need to be
implemented for that class. Support for additional file formats can be
implemented independently of the <em>Spectra</em> package and can be
contributed by different developers.</p>
<p>Examples:</p>
<ul>
<li>
<code>MsBackendMgf</code> (defined in <em><a href="https://bioconductor.org/packages/3.18/MsBackendMgf" class="external-link">MsBackendMgf</a></em>)
adds support for MS files in MGF file format.</li>
<li>
<code>MsBackendMsp</code> (defined in <em><a href="https://bioconductor.org/packages/3.18/MsBackendMsp" class="external-link">MsBackendMsp</a></em>
adds support for MSP files.</li>
<li>
<code>MsBackendRawFileReader</code> (defined in <em><a href="https://bioconductor.org/packages/3.18/MsBackendRawFileReader" class="external-link">MsBackendRawFileReader</a></em>)
adds support for MS data files in Thermo Fisher Scientific’s raw data
file format.</li>
</ul>
<p>To import data from files of a certain file format, the respective
backend able to handle such data needs to be specified with the
parameter <code>source</code> in the <code>Spectra</code> constructor
call:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Import MS data from mzML files</span></span>
<span><span class="va">s_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Reason 2</strong>: support different implementations to store
or represent the data. This includes both <em>where</em> the data is
stored or <em>how</em> it is stored. Specialized backends can be defined
that are, for example, optimized for high performance or for low memory
demand.</p>
<p>Examples:</p>
<ul>
<li>
<code>MsBackendMemory</code> (defined in <em><a href="https://bioconductor.org/packages/3.18/Spectra" class="external-link">Spectra</a></em>):
keeps all the MS data in memory and is optimized for a fast and
efficient access to the peaks data matrices (i.e., the <em>m/z</em> and
intensity values of the spectra).</li>
<li>
<code>MsBackendMzR</code> (defined in <em><a href="https://bioconductor.org/packages/3.18/Spectra" class="external-link">Spectra</a></em>):
keeps only spectra variables in memory and retrieves the peaks data
on-the-fly from the original data files upon request. This guarantees a
lower memory footprint and enables also analysis of large MS
experiments.</li>
<li>
<code>MsBackendSql</code> (defined in the <em><a href="https://bioconductor.org/packages/3.18/MsBackendSql" class="external-link">MsBackendSql</a></em>
package): all MS data is stored in a SQL database. Has minimal memory
requirements but any data (whether spectra or peaks variables) need to
be retrieved from the database. Depending on the SQL database system
used, this backend would also allow remote data access.</li>
</ul>
<p>To evaluate and illustrate the properties of these different backends
we create below <code>Spectra</code> objects for the same data, but
using different backends. We use the <code>setBackend</code> function to
change the backend for a <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Change the backend to MsBackendMemory</span></span>
<span><span class="va">s_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">s_mzr</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With the call above we loaded all MS data from the original data
files into memory. As a third option we next store the full MS data into
a SQL database by using/changing to a <code>MsBackendOfflineSql</code>
backend defined by the <em><a href="https://bioconductor.org/packages/3.18/MsBackendSql" class="external-link">MsBackendSql</a></em>
package.</p>
<p>For the <code>setBackend</code> call we need to provide the
connection information for the database that should contain the data.
This includes the database driver (parameter <code>drv</code>, depending
on the database system), the database name (parameter
<code>dbname</code>) as well as eventual additional connection
information like the host, username, port or password. Which of these
parameters are required depends on the SQL database used and hence the
driver (see also <code>?dbConnect</code> for more information on the
parameters). In our example we will store the data in a SQLite database.
We thus set <code>drv = SQLite()</code> and provide with parameter
<code>dbname</code> the name of the SQLite database file (that should
not yet exist). In addition, importantly, we disable parallel processing
with <code>BPPARAM = SerialParam()</code> since most SQL databases don’t
support parallel data import.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Change the backend to a SQL representation of the data.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendSql" class="external-link">MsBackendSql</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span><span class="va">s_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">s_mzr</span>, <span class="fu"><a href="https://rdrr.io/pkg/MsBackendSql/man/MsBackendOfflineSql.html" class="external-link">MsBackendOfflineSql</a></span><span class="op">(</span><span class="op">)</span>, drv <span class="op">=</span> <span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   dbname <span class="op">=</span> <span class="st">"ms_backend_sql_test.sqlite"</span>,</span>
<span>                   BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><em>Note</em>: a more efficient way to import MS data from data files
into a SQL database is the <code>createMsBackendSqlDatabase</code> from
the <em>MsBackendSql</em> package. Also, for larger data sets it is
suggested to use more advanced and powerful SQL database systems
(e.g. MySQL/MariaDB SQL databases).</p>
<p>We have now 3 <code>Spectra</code> objects representing the same MS
data, but using different backends. As a first comparison we evaluate
their size in memory:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare memory footprint.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 53.2 Mb</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.4 Mb</span></span></code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.1 Mb</span></span></code></pre>
<p>As expected, the size of the <code>Spectra</code> object with the
<code>MsBackendMemory</code> backend is the largest of the three. Since
the <code>MsBackendOfflineSql</code> backend keeps only the primary keys
of the spectra in memory it’s memory requirements are particularly small
and is thus ideal to represent even very large MS experiments.</p>
<p>We next evaluate the performance to extract spectra variables. We
compare the time needed to extract the retention times from the 3
<code>Spectra</code> objects using the <code>microbenchmark</code>
function. With <code>register(SerialParam())</code> we globally disable
parallel processing for <em>Spectra</em> to ensure the results to be
independent that.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare performance to extract the retention times.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">13</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##          expr      min       lq       mean   median       uq       max neval</span></span>
<span><span class="co">##  rtime(s_mem)   12.292   13.395   19.64815   19.877   26.169    31.269    13</span></span>
<span><span class="co">##  rtime(s_mzr)  385.288  407.640  451.69762  419.863  445.912   836.380    13</span></span>
<span><span class="co">##   rtime(s_db) 6983.250 7037.401 8782.54131 7179.236 7268.913 27920.037    13</span></span></code></pre>
<p>Highest performance can be seen for the <code>Spectra</code> object
with the <code>MsBackendMemory</code> backend, followed by the
<code>Spectra</code> object with the <code>MsBackendMzR</code> backend,
while extraction of spectra variables is slowest for the
<code>Spectra</code> with the <code>MsBackendOfflineSql</code>. Again,
this is expected because the <code>MsBackendOfflineSql</code> needs to
retrieve the data from the database while the two other backends keep
the retention times of the spectra (along with other general spectra
metadata) in memory.</p>
<p>We next also evaluate the performance to extract peaks data, i.e. the
individual <em>m/z</em> and intensity values for all spectra in the two
files.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare performance to extract the peaks data.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">7</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##              expr        min          lq        mean     median          uq</span></span>
<span><span class="co">##  peaksData(s_mem)    380.319    485.0095    704.9917    780.716    806.9495</span></span>
<span><span class="co">##  peaksData(s_mzr) 487238.872 492587.2645 524201.2064 496422.977 500894.0630</span></span>
<span><span class="co">##   peaksData(s_db)  89571.778  97788.3475 185583.6216 102420.344 210867.2850</span></span>
<span><span class="co">##         max neval</span></span>
<span><span class="co">##    1189.989     7</span></span>
<span><span class="co">##  698783.941     7</span></span>
<span><span class="co">##  489781.964     7</span></span></code></pre>
<p>The <code>MsBackendMemory</code> outperforms the two other backends
also in this comparison. Both the <code>MsBackendMzR</code> and
<code>MsBackendOfflineSql</code> need to import this data, the
<code>MsBackendMzR</code> from the original mzML files and the
<code>MsBackendOfflineSql</code> from the SQL database (which for the
present data is more efficient).</p>
<p>At last we evaluate the performance to subset any of the 3
<code>Spectra</code> objects to 10 random spectra.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare performance to subset the Spectra.</span></span>
<span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="va">s_mem</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>    <span class="va">s_mzr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>    <span class="va">s_db</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##        expr     min       lq     mean  median       uq      max neval</span></span>
<span><span class="co">##  s_mem[idx] 230.711 238.1690 246.4851 245.468 251.5495  314.927   100</span></span>
<span><span class="co">##  s_mzr[idx] 642.047 664.8100 683.6366 676.962 690.1570 1084.352   100</span></span>
<span><span class="co">##   s_db[idx] 133.279 141.9445 163.7531 147.515 153.4465 1633.125   100</span></span></code></pre>
<p>Here, the <code>MsBackendOfflineSql</code> has a clear advantage over
the two other backends, because it only needs to subset the integer
vector of primary keys (the only data it keeps in memory), while the
<code>MsBackendMemory</code> needs to subset the full data, and the
<code>MsBackendMzR</code> the data frame with the spectra variables.</p>
<div class="section level4">
<h4 id="performance-considerations-and-tweaks">Performance considerations and tweaks<a class="anchor" aria-label="anchor" href="#performance-considerations-and-tweaks"></a>
</h4>
<p>Keeping all data in memory (e.g. by using a
<code>MsBackendMemory</code>) has its obvious performance advantages,
but might not be possible for all MS experiments. <em>On-disk</em>
backends such as the <code>MsBackendMzR</code> or
<code>MsBackendOfflineSql</code> allow, due to their lower memory
footprint, to analyze also very large data sets. This is further
optimized by the build-in option for most <code>Spectra</code> methods
to load and process MS data only in small chunks in contrast to loading
and processing the full data as a whole. The performance of the
<em>offline</em> backends <code>MsBackendMzR</code> and
<code>MsBackendSql</code>/<code>MsBackendOfflineSql</code> depend also
on the I/O capabilities of the hard disks containing the data files and,
for the latter, in addition on the configuration of the SQL database
system used.</p>
</div>
</div>
<div class="section level3">
<h3 id="data-manipulation-and-the-lazy-evaluation-queue">Data manipulation and the lazy evaluation queue<a class="anchor" aria-label="anchor" href="#data-manipulation-and-the-lazy-evaluation-queue"></a>
</h3>
<p>Not all data representations might, by design or because of the way
the data is handled and stored, allow changing existing or adding new
values. The <code>MsBackendMzR</code> backend for example retrieves the
peaks data directly from the raw data files and we don’t want any
manipulation of <em>m/z</em> or intensity values to be directly written
back to these original data files. Also other backends, specifically
those that provide access to spectral reference databases (such as the
<code>MsBackendMassbankSql</code> from the <em><a href="https://bioconductor.org/packages/3.18/MsBackendMassbank" class="external-link">MsBackendMassbank</a></em>
package or the <code>MsBackendCompDb</code> from the <em><a href="https://bioconductor.org/packages/3.18/CompoundDb" class="external-link">CompoundDb</a></em>
package), are not supposed to allow any changes to the information
stored in these databases.</p>
<p>Data manipulations are however an integral part of any data analysis
and we thus need for such backends some mechanism that allows changes to
data without propagating these to the original data resource. For some
backend classes a <em>caching</em> mechanism is implemented that enables
adding, changing, or deleting spectra variables. To illustrate this we
below add a new spectra variable <code>"new_variable"</code> to each of
our 3 <code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Assign new spectra variables.</span></span>
<span><span class="va">s_mem</span><span class="op">$</span><span class="va">new_variable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span></span>
<span><span class="va">s_mzr</span><span class="op">$</span><span class="va">new_variable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span></span>
<span><span class="va">s_db</span><span class="op">$</span><span class="va">new_variable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span></span></code></pre></div>
<p>A new spectra variable was now added to each of the 3
<code>Spectra</code> objects:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Show spectra variables for one of the Spectra</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"    </span></span>
<span><span class="co">## [35] "new_variable"</span></span></code></pre>
<p>The <code>MsBackendMemory</code> stores all spectra variables in a
<code>data.frame</code> within the object. The new spectra variable was
thus simply added as a new column to this <code>data.frame</code>.</p>
<p><strong>Warning</strong>: <strong>NEVER</strong> access or manipulate
any of the slots of a backend class directly like below as this can
easily result in data corruption.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Direct access to the backend's data.</span></span>
<span><span class="va">s_mem</span><span class="op">@</span><span class="va">backend</span><span class="op">@</span><span class="va">spectraData</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   msLevel rtime acquisitionNum scanIndex dataStorage</span></span>
<span><span class="co">## 1       1 0.280              1         1    &lt;memory&gt;</span></span>
<span><span class="co">## 2       1 0.559              2         2    &lt;memory&gt;</span></span>
<span><span class="co">## 3       1 0.838              3         3    &lt;memory&gt;</span></span>
<span><span class="co">## 4       1 1.117              4         4    &lt;memory&gt;</span></span>
<span><span class="co">## 5       1 1.396              5         5    &lt;memory&gt;</span></span>
<span><span class="co">## 6       1 1.675              6         6    &lt;memory&gt;</span></span>
<span><span class="co">##                                                                    dataOrigin</span></span>
<span><span class="co">## 1 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 2 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 3 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 4 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 5 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 6 /usr/local/lib/R/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">##   centroided smoothed polarity precScanNum precursorMz precursorIntensity</span></span>
<span><span class="co">## 1      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">## 2      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">## 3      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">## 4      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">## 5      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">## 6      FALSE       NA        1          NA          NA                 NA</span></span>
<span><span class="co">##   precursorCharge collisionEnergy isolationWindowLowerMz</span></span>
<span><span class="co">## 1              NA              NA                     NA</span></span>
<span><span class="co">## 2              NA              NA                     NA</span></span>
<span><span class="co">## 3              NA              NA                     NA</span></span>
<span><span class="co">## 4              NA              NA                     NA</span></span>
<span><span class="co">## 5              NA              NA                     NA</span></span>
<span><span class="co">## 6              NA              NA                     NA</span></span>
<span><span class="co">##   isolationWindowTargetMz isolationWindowUpperMz peaksCount totIonCurrent</span></span>
<span><span class="co">## 1                      NA                     NA        578        898185</span></span>
<span><span class="co">## 2                      NA                     NA       1529       1037012</span></span>
<span><span class="co">## 3                      NA                     NA       1600       1094971</span></span>
<span><span class="co">## 4                      NA                     NA       1664       1135015</span></span>
<span><span class="co">## 5                      NA                     NA       1417       1106233</span></span>
<span><span class="co">## 6                      NA                     NA       1602       1181489</span></span>
<span><span class="co">##   basePeakMZ basePeakIntensity ionisationEnergy    lowMZ   highMZ mergedScan</span></span>
<span><span class="co">## 1   124.0860            154089                0 105.0435 133.9837         NA</span></span>
<span><span class="co">## 2   124.0859            182690                0 105.0275 133.9836         NA</span></span>
<span><span class="co">## 3   124.0859            196650                0 105.0376 133.9902         NA</span></span>
<span><span class="co">## 4   124.0859            203502                0 105.0376 133.9853         NA</span></span>
<span><span class="co">## 5   124.0859            191715                0 105.0347 133.9885         NA</span></span>
<span><span class="co">## 6   124.0859            213400                0 105.0420 133.9836         NA</span></span>
<span><span class="co">##   mergedResultScanNum mergedResultStartScanNum mergedResultEndScanNum</span></span>
<span><span class="co">## 1                  NA                       NA                     NA</span></span>
<span><span class="co">## 2                  NA                       NA                     NA</span></span>
<span><span class="co">## 3                  NA                       NA                     NA</span></span>
<span><span class="co">## 4                  NA                       NA                     NA</span></span>
<span><span class="co">## 5                  NA                       NA                     NA</span></span>
<span><span class="co">## 6                  NA                       NA                     NA</span></span>
<span><span class="co">##   injectionTime filterString                             spectrumId</span></span>
<span><span class="co">## 1             0         &lt;NA&gt; sample=1 period=1 cycle=1 experiment=1</span></span>
<span><span class="co">## 2             0         &lt;NA&gt; sample=1 period=1 cycle=2 experiment=1</span></span>
<span><span class="co">## 3             0         &lt;NA&gt; sample=1 period=1 cycle=3 experiment=1</span></span>
<span><span class="co">## 4             0         &lt;NA&gt; sample=1 period=1 cycle=4 experiment=1</span></span>
<span><span class="co">## 5             0         &lt;NA&gt; sample=1 period=1 cycle=5 experiment=1</span></span>
<span><span class="co">## 6             0         &lt;NA&gt; sample=1 period=1 cycle=6 experiment=1</span></span>
<span><span class="co">##   ionMobilityDriftTime scanWindowLowerLimit scanWindowUpperLimit new_variable</span></span>
<span><span class="co">## 1                   NA                   NA                   NA            1</span></span>
<span><span class="co">## 2                   NA                   NA                   NA            2</span></span>
<span><span class="co">## 3                   NA                   NA                   NA            3</span></span>
<span><span class="co">## 4                   NA                   NA                   NA            4</span></span>
<span><span class="co">## 5                   NA                   NA                   NA            5</span></span>
<span><span class="co">## 6                   NA                   NA                   NA            6</span></span></code></pre>
<p>Similarly, also the <code>MsBackendMzR</code> stores data for spectra
variables (but not peaks variables!) within a <code>DataFrame</code>
inside the object. Adding a new spectra variable thus also added a new
column to this <code>DataFrame</code>. <em>Note</em>: the use of a
<code>DataFrame</code> instead of a <code>data.frame</code> in
<code>MsBackendMzR</code> explains most of the performance differences
to subset or access spectra variables we’ve seen between this backend
and the <code>MsBackendMemory</code> above.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_mzr</span><span class="op">@</span><span class="va">backend</span><span class="op">@</span><span class="va">spectraData</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 1862 rows and 26 columns</span></span>
<span><span class="co">##      scanIndex acquisitionNum   msLevel  polarity peaksCount totIonCurrent</span></span>
<span><span class="co">##      &lt;integer&gt;      &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;  &lt;integer&gt;     &lt;numeric&gt;</span></span>
<span><span class="co">## 1            1              1         1         1        578        898185</span></span>
<span><span class="co">## 2            2              2         1         1       1529       1037012</span></span>
<span><span class="co">## 3            3              3         1         1       1600       1094971</span></span>
<span><span class="co">## 4            4              4         1         1       1664       1135015</span></span>
<span><span class="co">## 5            5              5         1         1       1417       1106233</span></span>
<span><span class="co">## ...        ...            ...       ...       ...        ...           ...</span></span>
<span><span class="co">## 1858       927            927         1         1       3528        418159</span></span>
<span><span class="co">## 1859       928            928         1         1       3662        429930</span></span>
<span><span class="co">## 1860       929            929         1         1       3442        413427</span></span>
<span><span class="co">## 1861       930            930         1         1       3564        447033</span></span>
<span><span class="co">## 1862       931            931         1         1       3517        441025</span></span>
<span><span class="co">##          rtime basePeakMZ basePeakIntensity ionisationEnergy     lowMZ</span></span>
<span><span class="co">##      &lt;numeric&gt;  &lt;numeric&gt;         &lt;numeric&gt;        &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1        0.280    124.086            154089                0   105.043</span></span>
<span><span class="co">## 2        0.559    124.086            182690                0   105.028</span></span>
<span><span class="co">## 3        0.838    124.086            196650                0   105.038</span></span>
<span><span class="co">## 4        1.117    124.086            203502                0   105.038</span></span>
<span><span class="co">## 5        1.396    124.086            191715                0   105.035</span></span>
<span><span class="co">## ...        ...        ...               ...              ...       ...</span></span>
<span><span class="co">## 1858   258.636    123.090             28544                0   105.008</span></span>
<span><span class="co">## 1859   258.915    123.090             29164                0   105.009</span></span>
<span><span class="co">## 1860   259.194    123.090             28724                0   105.010</span></span>
<span><span class="co">## 1861   259.473    123.091             28743                0   105.012</span></span>
<span><span class="co">## 1862   259.752    123.091             27503                0   105.012</span></span>
<span><span class="co">##         highMZ mergedScan mergedResultScanNum mergedResultStartScanNum</span></span>
<span><span class="co">##      &lt;numeric&gt;  &lt;integer&gt;           &lt;integer&gt;                &lt;integer&gt;</span></span>
<span><span class="co">## 1      133.984         NA                  NA                       NA</span></span>
<span><span class="co">## 2      133.984         NA                  NA                       NA</span></span>
<span><span class="co">## 3      133.990         NA                  NA                       NA</span></span>
<span><span class="co">## 4      133.985         NA                  NA                       NA</span></span>
<span><span class="co">## 5      133.989         NA                  NA                       NA</span></span>
<span><span class="co">## ...        ...        ...                 ...                      ...</span></span>
<span><span class="co">## 1858   134.000         NA                  NA                       NA</span></span>
<span><span class="co">## 1859   134.000         NA                  NA                       NA</span></span>
<span><span class="co">## 1860   134.000         NA                  NA                       NA</span></span>
<span><span class="co">## 1861   133.998         NA                  NA                       NA</span></span>
<span><span class="co">## 1862   133.997         NA                  NA                       NA</span></span>
<span><span class="co">##      mergedResultEndScanNum injectionTime filterString             spectrumId</span></span>
<span><span class="co">##                   &lt;integer&gt;     &lt;numeric&gt;  &lt;character&gt;            &lt;character&gt;</span></span>
<span><span class="co">## 1                        NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 2                        NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 3                        NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 4                        NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 5                        NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## ...                     ...           ...          ...                    ...</span></span>
<span><span class="co">## 1858                     NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 1859                     NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 1860                     NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 1861                     NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">## 1862                     NA             0           NA sample=1 period=1 cy..</span></span>
<span><span class="co">##      centroided ionMobilityDriftTime scanWindowLowerLimit scanWindowUpperLimit</span></span>
<span><span class="co">##       &lt;logical&gt;            &lt;numeric&gt;            &lt;numeric&gt;            &lt;numeric&gt;</span></span>
<span><span class="co">## 1         FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 2         FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 3         FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 4         FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 5         FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## ...         ...                  ...                  ...                  ...</span></span>
<span><span class="co">## 1858      FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 1859      FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 1860      FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 1861      FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">## 1862      FALSE                   NA                   NA                   NA</span></span>
<span><span class="co">##                 dataStorage             dataOrigin new_variable</span></span>
<span><span class="co">##                 &lt;character&gt;            &lt;character&gt;    &lt;integer&gt;</span></span>
<span><span class="co">## 1    /usr/local/lib/R/sit.. /usr/local/lib/R/sit..            1</span></span>
<span><span class="co">## 2    /usr/local/lib/R/sit.. /usr/local/lib/R/sit..            2</span></span>
<span><span class="co">## 3    /usr/local/lib/R/sit.. /usr/local/lib/R/sit..            3</span></span>
<span><span class="co">## 4    /usr/local/lib/R/sit.. /usr/local/lib/R/sit..            4</span></span>
<span><span class="co">## 5    /usr/local/lib/R/sit.. /usr/local/lib/R/sit..            5</span></span>
<span><span class="co">## ...                     ...                    ...          ...</span></span>
<span><span class="co">## 1858 /usr/local/lib/R/sit.. /usr/local/lib/R/sit..         1858</span></span>
<span><span class="co">## 1859 /usr/local/lib/R/sit.. /usr/local/lib/R/sit..         1859</span></span>
<span><span class="co">## 1860 /usr/local/lib/R/sit.. /usr/local/lib/R/sit..         1860</span></span>
<span><span class="co">## 1861 /usr/local/lib/R/sit.. /usr/local/lib/R/sit..         1861</span></span>
<span><span class="co">## 1862 /usr/local/lib/R/sit.. /usr/local/lib/R/sit..         1862</span></span></code></pre>
<p>The <code>MsBackendOfflineSql</code> implements the support for
changes to spectra variables differently: the object contains a vector
with the available database column names and in addition an (initially
empty) <code>data.frame</code> to cache changes to spectra variables. If
a spectra variable is deleted, only the respective column name is
removed from the character vector with available column names. If a new
spectra variable is added (like in the example above) or if values of an
existing spectra variable are changed, this spectra variable,
respectively its values, are stored (as a new column) in the caching
data frame:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_db</span><span class="op">@</span><span class="va">backend</span><span class="op">@</span><span class="va">localData</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   new_variable</span></span>
<span><span class="co">## 1            1</span></span>
<span><span class="co">## 2            2</span></span>
<span><span class="co">## 3            3</span></span>
<span><span class="co">## 4            4</span></span>
<span><span class="co">## 5            5</span></span>
<span><span class="co">## 6            6</span></span></code></pre>
<p>Actually, why do we not want to change the data directly in the
database? It should be fairly simple to add a new column to the database
table or change the values in that. There are actually two reasons to
<strong>not</strong> do that: firstly we don’t want to change the
<em>raw</em> data that might be stored in the database (e.g. if the
database contains reference MS2 spectra, such as in the case of a
<code>Spectra</code> with MassBank data) and secondly, we want to avoid
the following situation: imagine we create a copy of our
<code>s_db</code> variable and change the retention times in that
variable:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Change values in a copy of the variable</span></span>
<span><span class="va">s_db2</span> <span class="op">&lt;-</span> <span class="va">s_db</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span></span></code></pre></div>
<p>Writing these changes back to the database would also change the
retention time values in the original <code>s_db</code> variable and
that is for obvious reasons not desired.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Retention times of original copy should NOT change</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.280 0.559 0.838 1.117 1.396 1.675</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db2</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10.280 10.559 10.838 11.117 11.396 11.675</span></span></code></pre>
<p>Note that this can also be used for <code>MsBackendOfflineSql</code>
backends to cache spectra variables in memory for faster access.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_db2</span> <span class="op">&lt;-</span> <span class="va">s_db</span></span>
<span></span>
<span><span class="co">#' Cache an existing spectra variable in memory</span></span>
<span><span class="va">s_db2</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">s_db2</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">17</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##          expr      min       lq     mean   median       uq      max neval</span></span>
<span><span class="co">##   rtime(s_db) 6.867144 6.935762 7.046637 6.957643 7.034997 8.032556    17</span></span>
<span><span class="co">##  rtime(s_db2) 2.967924 3.004833 3.158521 3.054445 3.088198 4.590840    17</span></span></code></pre>
<p><em>Note</em>: the <code>MsBackendCached</code> class from the
<em>Spectra</em> package provides the internal
<code>data.frame</code>-based caching mechanism described above. The
<code>MsBackendOfflineSql</code> class directly extends this backend and
hence inherits this mechanism and only database-specific additional
functionality needed to be implemented. Thus, any <code>MsBackend</code>
implementation extending the <code>MsBackendCached</code> base class
automatically inherit this caching mechanism and do not need to
implement their own. Examples of backends extending
<code>MsBackendCached</code> are, among others,
<code>MsBackendSql</code>, <code>MsBackendOfflineSql</code>, and
<code>MsBackendMassbankSql</code>.</p>
<p>Analysis of MS data requires, in addition to changing or adding
spectra variables also the possibility to manipulate the peaks’ data
(i.e. the <em>m/z</em> and intensity values of the individual mass peaks
of the spectra). As a simple example we remove below all mass peaks with
an intensity below 100 from the data set and compare the number of peaks
per spectra before and after that operation.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Remove all peaks with an intensity below 100</span></span>
<span><span class="va">s_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">s_mem</span>, intensity <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Compare the number of peaks before/after</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span>, after <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"number of peaks"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra-backends_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>This operation did reduce the number of peaks considerably. We repeat
this operation now also for the two other backends.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Repeast filtering for the two other Spectra objects.</span></span>
<span><span class="va">s_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">s_mzr</span>, intensity <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">s_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">s_db</span>, intensity <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>The number of peaks were also reduced for these two backends although
they do not keep the peak data in memory and, as discussed before, we do
not allow changes to the data file (or the database) containing the
original data.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Evaluate that subsetting worked for all.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 433</span></span></code></pre>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 433</span></span></code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 433</span></span></code></pre>
<p>The caching mechanisms described above work well for spectra
variables because of their (generally) limited and manageable sizes. MS
peaks data (<em>m/z</em> and intensity values of the individual peaks of
MS spectra) however represent much larger data volumes preventing to
cache and store changes to these directly in-memory, especially for data
from large experiments or high resolution instruments.</p>
<p>For that reason, instead of caching changes to the values within the
object, we cache the actual data manipulation operation(s). The function
to modify peaks data, along with all of its parameters, is automatically
added to an internal <em>lazy processing queue</em> within the
<code>Spectra</code> object for each call to one of the
<code>Spectra</code>’s (peaks) data manipulation functions. This
mechanism is implemented directly for the <code>Spectra</code> class and
backends thus do not have to implement their own.</p>
<p>When calling <code>filterIntensity</code> above, the data was
actually not modified, but the function to filter the peaks data was
added to this processig queue. The function along with all possibly
defined parameters was added as a <code>ProcessingStep</code>
object:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Show the processing queue.</span></span>
<span><span class="va">s_db</span><span class="op">@</span><span class="va">processingQueue</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## Object of class "ProcessingStep"</span></span>
<span><span class="co">##  Function: user-provided function</span></span>
<span><span class="co">##  Arguments:</span></span>
<span><span class="co">##   o intensity = 100Inf</span></span>
<span><span class="co">##   o msLevel = 1</span></span></code></pre>
<p>Again, it is not advisable to directly access any of the internal
slots of a <code>Spectra</code> object! The function could be accessed
with:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access a processing step's function</span></span>
<span><span class="va">s_db</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">FUN</span></span></code></pre></div>
<pre><code><span><span class="co">## function (x, spectrumMsLevel, intensity = c(0, Inf), msLevel = spectrumMsLevel, </span></span>
<span><span class="co">##     ...) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     if (!spectrumMsLevel %in% msLevel || !length(x)) </span></span>
<span><span class="co">##         return(x)</span></span>
<span><span class="co">##     x[which(between(x[, "intensity"], intensity)), , drop = FALSE]</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55a2b582b590&gt;</span></span>
<span><span class="co">## &lt;environment: namespace:Spectra&gt;</span></span></code></pre>
<p>and all of its parameters with:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access the parameters for that function</span></span>
<span><span class="va">s_db</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">ARGS</span></span></code></pre></div>
<pre><code><span><span class="co">## $intensity</span></span>
<span><span class="co">## [1] 100 Inf</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $msLevel</span></span>
<span><span class="co">## [1] 1</span></span></code></pre>
<p>Each time peaks data is accessed (like with the
<code>intensity</code> call in the example below), the
<code>Spectra</code> object will first request the <em>raw</em> peaks
data from the backend, check its own processing queue and, if that is
not empty, apply each of the contained cached processing steps to the
peaks data before returning it to the user.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access intensity values and extract those of the 1st spectrum.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   [1]    412    412    412    412    412    412    412    412    412   1237</span></span>
<span><span class="co">##  [11]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">##  [21]    412    412    824    412    412    412    412    412    412    412</span></span>
<span><span class="co">##  [31]    412    412    412    412    412    412   1237    412    412    412</span></span>
<span><span class="co">##  [41]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">##  [51]    824    412    412    412    412    412    412    412    824   1649</span></span>
<span><span class="co">##  [61]   2061   1237    412    412    412    412    412    412   2061   7008</span></span>
<span><span class="co">##  [71]  17727  22674  23910  12780   6184   3710   2061   1237    412    412</span></span>
<span><span class="co">##  [81]    412   1662    412   1258    861    854    845    873    842    412</span></span>
<span><span class="co">##  [91]    860   1307    882    442  12347  55349 132662 154089 115667  76817</span></span>
<span><span class="co">## [101]  41233  26904  11577   6155   2650   3966    872    461    461    433</span></span>
<span><span class="co">## [111]    412    442    430    461    412    412    412    412    412    426</span></span>
<span><span class="co">## [121]    449    412    412    824    412    412    433    412    412    412</span></span>
<span><span class="co">## [131]    412    412   1684    412    412    412   1649   1649   2061   1649</span></span>
<span><span class="co">## [141]   4947   6184   9482  10718   5359   2886   1649   1649   1237    412</span></span>
<span><span class="co">## [151]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">## [161]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">## [171]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">## [181]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">## [191]    412    412    412    412    824    412    412    412    412    412</span></span>
<span><span class="co">## [201]    412    412    412    412    412    412    412    824    412    412</span></span>
<span><span class="co">## [211]    412    412    412    412    412    412    412    412    412    412</span></span>
<span><span class="co">## [221]    412    824    824   1237   1649    824    412    412    412    412</span></span>
<span><span class="co">## [231]    824    412    824   1237    412    412    412    412    412    412</span></span>
<span><span class="co">## [241]    412    412    412    412    412    412    412</span></span></code></pre>
<p>As a nice side effect, if only a subset of the data is accessed, the
data manipulations need only to be applied to the requested data subset,
and not the full data. This can have a positive impact on overall
performance:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare applying the processing queue to either 10 spectra or the</span></span>
<span><span class="co">#' full set of spectra.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##                    expr       min        lq       mean     median         uq</span></span>
<span><span class="co">##  intensity(s_mem[1:10])  3.542345  3.699177   3.906552   3.882108   3.977156</span></span>
<span><span class="co">##  intensity(s_mem)[1:10] 99.563948 99.721442 103.931024 100.194454 108.821023</span></span>
<span><span class="co">##         max neval</span></span>
<span><span class="co">##    4.568749     7</span></span>
<span><span class="co">##  110.673833     7</span></span></code></pre>
<p>Next to the number of common peaks data manipulation methods that are
already implemented for <code>Spectra</code>, and that all make use of
this processing queue, there is also the <code>addProcessing</code>
function that allows to apply any user-provided function to the peaks
data (using the same lazy evaluation mechanism). As a simple example we
define below a function that <em>scales</em> all intensities in a
spectrum such that the total intensity sum per spectrum is 1. Functions
for <code>addProcessing</code> are expected to take a peaks array as
input and should again return a peaks array as their result. Note also
that the <code>...</code> in the function definition below is required,
because internally additional parameters, such as the spectrum’s MS
level, are by default passed along to the function (see also the
<code>addProcessing</code> documentation entry in <code><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">?Spectra</a></code>
for more information and more advanced examples).</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define a function that scales intensities</span></span>
<span><span class="va">scale_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Add this function to the processing queue</span></span>
<span><span class="va">s_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">s_mem</span>, <span class="va">scale_sum</span><span class="op">)</span></span>
<span><span class="va">s_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">s_mzr</span>, <span class="va">scale_sum</span><span class="op">)</span></span>
<span><span class="va">s_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">s_db</span>, <span class="va">scale_sum</span><span class="op">)</span></span></code></pre></div>
<p>As a validation we calculate the sum of intensities for the first 6
spectra.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_mem</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1 1 1 1 1</span></span></code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_mzr</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1 1 1 1 1</span></span></code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1 1 1 1 1</span></span></code></pre>
<p>All intensities were thus scaled to a total intensity sum per spectra
of 1. Note that, while this is a common operation for MS2 data (fragment
spectra), such a scaling function should generally not be used for
(quantitative) MS1 data (as in our example here).</p>
<p>Finally, since through this lazy evaluation mechanism we are not
changing actual peaks data, we can also <em>undo</em> data
manipulations. A simple <code>reset</code> call on a
<code>Spectra</code> object will restore the data in the object to its
initial state (in fact it simply clears the processing queue).</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Restore the Spectra object to its initial state.</span></span>
<span><span class="va">s_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">reset</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1547</span></span></code></pre>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">s_db</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  898185 1037012 1094971 1135015 1106233 1181489</span></span></code></pre>
<p>Along with potential chaching mechanisms for spectra variables, this
implementation of a lazy-evaluation queue allows to apply also data
manipulations to MS data from data resources that would be inherently
<em>read-only</em> (such as reference libraries of fragment spectra) and
thus enable the analysis of MS data independently of <em>where</em> and
<em>how</em> the data is stored.</p>
</div>
<div class="section level3">
<h3 id="implementing-your-own-msbackend">Implementing your own <code>MsBackend</code><a class="anchor" aria-label="anchor" href="#implementing-your-own-msbackend"></a>
</h3>
<ul>
<li><p>New backends for <code>Spectra</code> should extend the
<code>MsBackend</code> class and implement the methods defined by its
infrastructure.</p></li>
<li><p>Extending other classes, such as the <code>MsBackendMemory</code>
or <code>MsBackendCached</code> can help reducing the number of methods
or concepts needed to implement.</p></li>
<li><p>A detailed example and description is provided in the <a href="https://rformassspectrometry.github.io/Spectra...." class="external-link"><em>Creating
new <code>MsBackend</code> classes</em></a> vignette - otherwise: open
an issue on the <a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link"><em>Spectra</em>
github repo</a>.</p></li>
<li>
<p>Add the following code to your <em>testthat.R</em> file to ensure
compliance with the <code>MsBackend</code> definition:</p>
<pre><code><span><span class="va">test_suite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"test_backends"</span>, <span class="st">"test_MsBackend"</span>,</span>
<span>                        package <span class="op">=</span> <span class="st">"Spectra"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Assign an instance of the developed `MsBackend` to variable `be`.</span></span>
<span><span class="va">be</span> <span class="op">&lt;-</span> <span class="va">my_be</span></span>
<span><span class="fu">test_dir</span><span class="op">(</span><span class="va">test_suite</span>, stop_on_failure <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="final-words">Final words<a class="anchor" aria-label="anchor" href="#final-words"></a>
</h3>
<ul>
<li>The <em><a href="https://bioconductor.org/packages/3.18/Spectra" class="external-link">Spectra</a></em>
package provides a powerful infrastructure to handle and process MS data
in R:
<ul>
<li>designed to support very large data sets.</li>
<li>easily extendable.</li>
<li>support for a variety of MS data file formats and data
representations.</li>
<li>caching mechanism and processing queue allow data analysis also of
<em>read-only</em> data resources.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="acknowledgments">Acknowledgments<a class="anchor" aria-label="anchor" href="#acknowledgments"></a>
</h2>
<p>Thank you to <a href="https://github.com/philouail" class="external-link">Philippine
Louail</a> for fixing typos and suggesting improvements.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gattoMSnbaseEfficientElegant2020a" class="csl-entry">
Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020.
<span>“<span>MSnbase</span>, <span>Efficient</span> and <span>Elegant
R</span>-<span>Based Processing</span> and <span>Visualization</span> of
<span>Raw Mass Spectrometry Data</span>.”</span> <em>Journal of Proteome
Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313" class="external-link">https://doi.org/10.1021/acs.jproteome.0c00313</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
