<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package • SpectraTutorials</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package">
<meta property="og:description" content="SpectraTutorials">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpectraTutorials</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jorainer/SpectraTutorials" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="analyzing-MS-data-from-different-sources-with-Spectra_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Seamless Integration of Mass Spectrometry Data from Different Sources with the <code>Spectra</code> Package</h1>
                        <h4 data-toc-skip class="author">Johannes Rainer<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, Michael Witting<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, Sebastian Gibb<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>, Laurent Gatto<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/master/vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd" class="external-link"><code>vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></a></small>
      <div class="hidden name"><code>analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></div>

    </div>

    
    
<p><strong>Last modified:</strong> 2021-08-04 15:29:49<br><strong>Compiled</strong>: Wed Aug 4 15:34:37 2021</p>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor" aria-hidden="true"></a>Overview</h1>
<div id="description" class="section level2">
<h2 class="hasAnchor">
<a href="#description" class="anchor" aria-hidden="true"></a>Description</h2>
<p>Mass spectrometry (MS) data is a key technology in modern proteomics and metabolomics experiments. Due to continuous improvements in MS instrumentation, the generated data can easily become very large. Also, additional resources of MS data exist, such as spectra libraries and databases, all with their own specific file formats and database systems that sometimes do not support manipulations of the original data.</p>
<p>Learning from experiences with the <em><a href="https://bioconductor.org/packages/3.14/MSnbase" class="external-link">MSnbase</a></em> Bioconductor package, the <em><a href="https://bioconductor.org/packages/3.14/Spectra" class="external-link">Spectra</a></em> package was developed to provide an even more flexible and expandable infrastructure for MS data in R. This package implements a clear separation between the user interface and the code to provide, store and import MS data. The latter is defined by the <code>MsBackend</code> interface which thus allows implementation of data type, format or storage-dependent <em>backends</em>. Backends can thus be implemented for specific file types and data resources or different ways to represent MS data (e.g. in memory or <em>on-disk</em> data representations as described in <span class="citation">(Gatto, Gibb, and Rainer 2020)</span>). They are also supposed to be interchangeable hence allowing the user to switch backends without affecting the analysis. To enable processing of also very large MS data sets, data manipulations are by default not directly applied to the data but cached in a <em>lazy evaluation queue</em> which allows analyses also of <em>read-only</em> data representations.</p>
<p>This (instructor-led live demo) workshop shows the expandability of the new infrastructure to enable a seamless integration and analysis of MS data from a variety of input formats illustrated by a simple comparison and matching of experimental MS2 spectra against public spectral databases and export of the data in a format commonly used for exchange of MS2 data.</p>
</div>
<div id="pre-requisites" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-requisites" class="anchor" aria-hidden="true"></a>Pre-requisites</h2>
<ul>
<li>Basic familiarity with R and Bioconductor.</li>
<li>Basic understanding of Mass Spectrometry (MS) data.</li>
</ul>
</div>
<div id="installation-and-participation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-and-participation" class="anchor" aria-hidden="true"></a>Installation and Participation</h2>
<ul>
<li><p>Get the <a href="https://hub.docker.com/r/jorainer/spectra_tutorials" class="external-link">docker image</a> of this tutorial with <code>docker pull jorainer/spectra_tutorials:latest</code>.</p></li>
<li>
<p>Start docker using</p>
<pre><code>docker run \
    -e PASSWORD=bioc \
    -p 8787:8787 \
    jorainer/spectra_tutorials:latest</code></pre>
</li>
<li><p>Enter <code>http://localhost:8787</code> in a web browser and log in with username <code>rstudio</code> and password <code>bioc</code>.</p></li>
<li><p>Open this R-markdown file (<em>vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd</em>) in the RStudio server version in the web browser and evaluate the R code blocks.</p></li>
<li><p>To get the source code: clone <a href="https://github.com/jorainer/SpectraTutorials" class="external-link">this github repository</a>, e.g. with <code>git clone https://github.com/jorainer/SpectraTutorials</code>.</p></li>
<li><p>Optionally, to run also the code to import the MS2 spectra from HMDB the <em>All Spectra Files (XML)</em> archive from the <a href="https://hmdb.ca/downloads" class="external-link">hmdb downloads page</a> has to be downloaded. The contents of the <em>hmdb_all_spectra.zip</em> archive should then be unzipped into the folder <em>data/hmdb_all_spectra</em>.</p></li>
</ul>
</div>
<div id="rbioconductor-packages-used" class="section level2">
<h2 class="hasAnchor">
<a href="#rbioconductor-packages-used" class="anchor" aria-hidden="true"></a>R/Bioconductor packages used</h2>
<ul>
<li><a href="https://bioconductor.org/packages/Spectra" class="external-link"><code>Spectra</code></a></li>
<li><a href="https://bioconductor.org/packages/MsCoreUtils" class="external-link"><code>MsCoreUtils</code></a></li>
<li><a href="https://bioconductor.org/packages/MsBackendMgf" class="external-link"><code>MsBackendMgf</code></a></li>
<li><a href="https://bioconductor.org/packages/MsBackendMassbank" class="external-link"><code>MsBackendMassbank</code></a></li>
</ul>
<p>Other R packages not (yet) in Bioconductor:</p>
<ul>
<li><a href="https://rformassspectrometry.github.io/MsBackendHmdb" class="external-link"><code>MsBackendHmdb</code></a></li>
</ul>
</div>
<div id="time-outline" class="section level2">
<h2 class="hasAnchor">
<a href="#time-outline" class="anchor" aria-hidden="true"></a>Time outline</h2>
<div id="time-outline-1" class="section level3">
<h3 class="hasAnchor">
<a href="#time-outline-1" class="anchor" aria-hidden="true"></a>Time outline</h3>
<table class="table">
<thead><tr class="header">
<th>Activity</th>
<th>Time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Introduction (LC-MS/MS, <code>Spectra</code> package)</td>
<td>10min</td>
</tr>
<tr class="even">
<td>MS data import and handling</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>Data processing and manipulation</td>
<td>5min</td>
</tr>
<tr class="even">
<td>Spectrum data comparison</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>Comparing spectra against MassBank</td>
<td>10min</td>
</tr>
<tr class="even">
<td>Data export</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>(Comparing spectra against HMDB)</td>
<td>(5min)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="workshop-goals-and-objectives" class="section level2">
<h2 class="hasAnchor">
<a href="#workshop-goals-and-objectives" class="anchor" aria-hidden="true"></a>Workshop goals and objectives</h2>
<div id="learning-goals" class="section level3">
<h3 class="hasAnchor">
<a href="#learning-goals" class="anchor" aria-hidden="true"></a>Learning goals</h3>
<ul>
<li>Understand how to import MS data into R.</li>
<li>Understand the basic concept of <em>backends</em> in <code>Spectra</code> and how they can be used to work with MS data from various sources.</li>
</ul>
</div>
<div id="learning-objectives" class="section level3">
<h3 class="hasAnchor">
<a href="#learning-objectives" class="anchor" aria-hidden="true"></a>Learning objectives</h3>
<ul>
<li>Import and export MS data with <code>Spectra</code>.</li>
<li>Integrate MS data from different resources into an MS data analysis workflow.</li>
<li>Apply different data manipulations on MS data represented as a <code>Spectra</code> object.</li>
<li>Use <code>Spectra</code> to perform spectra comparisons in R.</li>
</ul>
</div>
</div>
</div>
<div id="workshop" class="section level1">
<h1 class="hasAnchor">
<a href="#workshop" class="anchor" aria-hidden="true"></a>Workshop</h1>
<div id="lc-msms-in-a-nutshell" class="section level2">
<h2 class="hasAnchor">
<a href="#lc-msms-in-a-nutshell" class="anchor" aria-hidden="true"></a>LC-MS/MS in a nutshell</h2>
<ul>
<li>Mass spectrometry (<strong>MS</strong>) instruments measure mass-to-charge ratios (m/z) and abundances of ions. The resulting m/z and intensity values are stored/represented as a <em>spectrum</em>.</li>
<li>Most compounds are not charged, they need to be ionized first (with e.g. electro spray ionization (<strong>ESI</strong>)).</li>
<li>MS is usually combined with another separation technique, such as liquid chromatography (<strong>LC</strong>). This adds another dimension to the data: retention time (rt). For LC-MS data is represented by multiple spectra, each spectrum with its own retention time.</li>
</ul>
<div class="figure">
<img src="LC-MS-drawing.gif" alt=""><p class="caption"><em>LC-MS setup</em></p>
</div>
<ul>
<li>With LC-MS we measure <em>features</em> characterized by m/z and retention time - we still don’t know what molecule was actually measured.</li>
<li>Create in addition fragment (MS/MS) spectra from the ions to get some information about their structure.</li>
</ul>
<div class="figure">
<img src="MSMS.png" alt=""><p class="caption"><em>CID-based fragmentation</em></p>
</div>
<ul>
<li>Commonly used method: collision induced dissociation (<strong>CID</strong>). In a collision chamber filled with e.g. N2, ions get fragmented and a spectrum of these fragments is recorded.</li>
<li>Comparing and matching such fragment spectra against a <em>reference</em> helps identifying the compound.</li>
</ul>
</div>
<div id="the-spectra-package" class="section level2">
<h2 class="hasAnchor">
<a href="#the-spectra-package" class="anchor" aria-hidden="true"></a>The <code>Spectra</code> package</h2>
<p>The <code>Spectra</code> package implements a clear separation between the user interface and the code to provide, store and read mass spectrometry data. Thus, different data or file format-specific <em>backends</em> can be implemented and directly <em>plugged-in</em> without affecting the way the user would access or analyze the data. This represents an extension to the <em>in-memory</em> and <em>on-disk</em> data modes already available in the <em><a href="https://bioconductor.org/packages/3.14/MSnbase" class="external-link">MSnbase</a></em> package that enabled either a fast data processing or an analysis of very large data sets by keeping only a limited amount of data in the computer’s memory <span class="citation">(Gatto, Gibb, and Rainer 2020)</span>.</p>
<div class="figure">
<img src="Spectra.png" alt=""><p class="caption">Spectra: separation into user functionality and data representation</p>
</div>
<p>In this workshop we will:</p>
<ul>
<li>import MS data from <em>mzML</em> files,</li>
<li>select MS2 spectra for a certain compound,</li>
<li>compare and match the MS2 spectra against <em>reference</em> MS2 spectra from a public database,</li>
<li>annotate the spectra and export them to a file in <em>MGF</em> format.</li>
</ul>
</div>
<div id="ms-data-import-and-handling" class="section level2">
<h2 class="hasAnchor">
<a href="#ms-data-import-and-handling" class="anchor" aria-hidden="true"></a>MS data import and handling</h2>
<p>Below we import the MS data from the mzML files provided within this package. These files contain MSn data of a mix of 8 standard compounds (added either to water or a pool of human serum samples) measured with a HILIC-based LC-MS/MS setup. MS2 data was generated by data dependent acquisition using a collision energy of 20eV. For data import and representation of these experimental data we use the <code>MsBackendMzR</code> backend which supports import (and export) of data from the most common <em>raw</em> mass spectrometry file formats (i.e. mzML, mzXML and CDF).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span>

<span class="co">#' Define the input files</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mzML"</span>, package <span class="op">=</span> <span class="st">"SpectraTutorials"</span><span class="op">)</span>,
           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">#' Import the data</span>
<span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The MS data is now represented by a <code>Spectra</code> object, which can be thought of as a <code>data.frame</code> with rows being the individual spectra and columns the spectra <em>variables</em> (such as <code>"rtime"</code>, i.e. the retention time). The <code>spectraVariables</code> function lists all available variables within such a <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' List all available spectra variables (attributes)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                  "rtime"                   
##  [3] "acquisitionNum"           "scanIndex"               
##  [5] "dataStorage"              "dataOrigin"              
##  [7] "centroided"               "smoothed"                
##  [9] "polarity"                 "precScanNum"             
## [11] "precursorMz"              "precursorIntensity"      
## [13] "precursorCharge"          "collisionEnergy"         
## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" 
## [17] "isolationWindowUpperMz"   "peaksCount"              
## [19] "totIonCurrent"            "basePeakMZ"              
## [21] "basePeakIntensity"        "ionisationEnergy"        
## [23] "lowMZ"                    "highMZ"                  
## [25] "mergedScan"               "mergedResultScanNum"     
## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  
## [29] "injectionTime"            "filterString"            
## [31] "spectrumId"               "ionMobilityDriftTime"    
## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"</code></pre>
<p>Each spectra variable can be accessed either <em>via</em> <code>$</code> and its name or by using its dedicated access function (which is the preferred way). Below we access the retention times of the first spectra using either <code>$rtime</code> or the function <code>rtime</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Access the spectras' retention time</span>
<span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">$</span><span class="va">rtime</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<p>Our <code>Spectra</code> object contains information from in total 1578 spectra from <code>length(unique(dataOrigin(sps_all)))</code> mzML files. By using the <code>MsBackendMzR</code> backend, only general information about each spectrum is kept in memory resulting in a low memory footprint.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 0.4 Mb</code></pre>
<p>The spectra’s m/z and intensity values can be accessed with the <code>mz</code> or <code>intensity</code> functions. By using an <code>MsBackendMzR</code> backend, these are retrieved on demand from the original data files each time the functions are called.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 1578
## [[1]] 50.2264681118888 52.9758613330164 ... 998.412321909748 999.815483842029
## [[2]] 50.0188439310345 51.0188982589394 ... 994.093212059943 998.65669267328
## [[3]] 50.0188439310345 51.0260087879784 ... 999.549654921888 999.904649454908
## [[4]] 50.0347997547605 51.0271913631291 ... 984.467433193755 998.839380503321
## [[5]] 50.1615393614339 51.0280734441081 ... 996.599267645346 999.81102566575
## [[6]] 50.0158524973623 50.2809808965161 ... 992.93057113729 999.650537939432
## [[7]] 50.0178467765376 51.02704020796 ... 999.217711368357 999.757528325686
## [[8]] 50.0158524973623 51.0257255950236 ... 993.780890433629 999.583671855333
## [[9]] 50.0158524973623 50.9727348052523 ... 999.508971233846 999.663911424618
## [[10]] 50.0158524973623 50.0264589058649 ... 997.312177169353 999.672827131107
## ...
## &lt;1568 more elements&gt;</code></pre>
<p>We can also load the full data into memory by changing the backend from <code>MsBackendMzR</code> to <code>MsBackendDataFrame</code>. This does not affect the way we use the <code>Spectra</code> object itself: the same operations and functions are available, independently of the way the data is stored (i.e. which backend is used).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Change backend to a MsBackendDataFrame: load data into memory</span>
<span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_all</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The size of our <code>Spectra</code> object is now larger, since the full data has been loaded into memory.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 16.5 Mb</code></pre>
<p>To subset <code>Spectra</code> objects, we can use either <code>[</code> or one of the many available <code>filter*</code> functions (that are usually more efficient than <code>[</code>). We could this subset the <code>sps_all</code> to some arbitrary spectra simply using:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_all</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 3 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         1     1.183         4
## 2         1     0.570         2
## 3         1     1.491         5
##  ... 33 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendDataFrame [Wed Aug  4 15:34:43 2021]</code></pre>
<p>In our workshop, we next want to identify in our experimental data MS2 spectra that were generated from an ion that matches the m/z of the <code>[M+H]+</code> ion of the metabolite cystine (one of the standards added to the sample mix measured in the present experimental data). We thus use below the <code>filterPrecursorMz</code> function to subset the data to MS2 spectra matching that m/z (accepting a difference in m/z of 10 parts-per-million (ppm)).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Define the m/z ratio for an ion of cystine</span>
<span class="va">mz</span> <span class="op">&lt;-</span> <span class="fl">241.0311</span>

<span class="co">#' Subset the dataset to MS2 spectra matching the m/z</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterPrecursorMz</a></span><span class="op">(</span><span class="va">sps_all</span>, mz <span class="op">=</span> <span class="va">mz</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">ppm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">mz</span>, <span class="va">mz</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 6 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2   209.936       673
## 2         2   220.072       714
## 3         2   231.604       734
## 4         2   215.089       761
## 5         2   225.739       781
## 6         2   240.020       804
##  ... 33 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendDataFrame [Wed Aug  4 15:34:43 2021]
##  Filter: select spectra with a precursor m/z within [241.028689689, 241.033510311] [Wed Aug  4 15:34:44 2021]</code></pre>
<p>In total 6 spectra matched our target precursor m/z.</p>
</div>
<div id="data-processing-and-manipulation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-processing-and-manipulation" class="anchor" aria-hidden="true"></a>Data processing and manipulation</h2>
<p>The <code>plotSpectra</code> function can be used to visualize spectra. Below we plot the first spectrum from our data subset.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Plot the first spectrum</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/raw-ms2-1.png" width="672"></p>
<p>This raw MS2 spectrum contains many very low intensity peaks, most likely representing noise. Thus we next filter the spectra removing all peaks with an intensity smaller than 5% of the maximum intensity of each spectrum (i.e. the base peak intensity). To this end we define a function that takes intensity values from each spectrum as input and returns a logical value whether the peak should be retained (<code>TRUE</code>) or not (<code>FALSE</code>). This function is then passed to the <code>filterIntensity</code> function to perform the actual filtering of the spectra.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Define a filtering function</span>
<span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span>
<span class="op">}</span>
<span class="co">#' Apply the function to filter the spectra</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">sps</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></code></pre></div>
<p>After filtering, the spectra are <em>cleaner</em>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Plot the first spectrum after filtering</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/raw-ms2-filtered-1.png" width="672"></p>
<p>In addition we <em>normalize</em> each spectrum replacing the absolute intensity values with values relative to the spectrum’s maximum intensity (which is set to 100). Also for this operation we define a function which takes a <em>peak matrix</em> as input and returns a matrix with the same dimensions. The peak matrix is the two-column matrix with m/z (first column) and intensity values (second column) representing the MS data of a spectrum. This function is then passed with parameter <code>FUN</code> to the <code>addProcessing</code> function which allows to apply any user-defined function to the peak matrix of each spectrum in a <code>Spectra</code> object. With this function <code>Spectra</code> thus provides a powerful framework to apply any user-defined data manipulation operation to MS data.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Define a function to *normalize* the intensities</span>
<span class="va">norm_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">maxint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="va">maxint</span>
    <span class="va">x</span>
<span class="op">}</span>
<span class="co">#' *Apply* the function to the data</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">norm_int</span><span class="op">)</span></code></pre></div>
<p>To show the effect of the normalization we extract the intensities of the first spectrum:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Get the intensities after normalization</span>
<span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>## [1]  13.439402  93.631648  49.287979 100.000000   9.422415   6.581111  12.969807
## [8]  54.633224</code></pre>
<p>The intensity values are now all between 0 and 100.</p>
</div>
<div id="spectrum-data-comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#spectrum-data-comparison" class="anchor" aria-hidden="true"></a>Spectrum data comparison</h2>
<p>We next perform a pairwise comparison of the subsetted spectra using the dot product as similarity measure. Prior to the actual similarity calculation, the peaks of the individual spectra have to be matched against each other (i.e. it has to be determined which peak from one spectrum correspond to which from the other spectrum based on their mass-to-charge ratios). We specify <code>ppm = 20</code> so that peaks with a difference in m/z smaller than 20ppm will be considered matching.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Pairwise comparison of all spectra</span>
<span class="va">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="va">cormat</span></code></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]
## [1,] 1.0000000 0.9717669 0.8907129 0.9721095 0.8795912 0.8818719
## [2,] 0.9717669 1.0000000 0.9992127 0.9964783 0.9525726 0.9486682
## [3,] 0.8907129 0.9992127 1.0000000 0.9947650 0.9518138 0.9478201
## [4,] 0.9721095 0.9964783 0.9947650 1.0000000 0.9543584 0.9494561
## [5,] 0.8795912 0.9525726 0.9518138 0.9543584 1.0000000 0.9994800
## [6,] 0.8818719 0.9486682 0.9478201 0.9494561 0.9994800 1.0000000</code></pre>
<p>The pairwise spectra similarities are represented with the heatmap below (note that RStudio in the docker might crash by the <code>pheatmap</code> call - to avoid this add <code>filename = "hm.pdf"</code> to the <code>heatmap</code> call).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>
<span class="va">hm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">cormat</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">101</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/ms2-heatmap-1.png" width="672"></p>
<p>The similarity between all the selected experimental MS2 spectra is very high (in fact above 0.88) suggesting all of them representing fragment spectra of the same compound.</p>
</div>
<div id="comparing-spectra-against-massbank" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-spectra-against-massbank" class="anchor" aria-hidden="true"></a>Comparing spectra against MassBank</h2>
<p>Although the precursor m/z of our spectra matches the m/z of cystine, we can still not exclude that they represent fragmentations of ions from different compounds (that would have the same precursor m/z than cystine).</p>
<p>Matching experimental spectra against a public spectral library can be used as a first step in the identification process. Several (public) spectral libraries for small molecules are available, such as:</p>
<ul>
<li><a href="https://massbank.eu/MassBank/" class="external-link">MassBank</a></li>
<li>MassBank of North America <a href="https://mona.fiehnlab.ucdavis.edu/" class="external-link">MoNa</a>
</li>
<li>Human Metabolom Database <a href="https://hmdb.ca/" class="external-link">HMDB</a>
</li>
<li><a href="https://gnps.ucsd.edu/ProteoSAFe/static/gnps-splash.jsp" class="external-link">GNPS</a></li>
<li>…</li>
</ul>
<p>For some of these databases <code>MsBackend</code> interfaces are already implemented allowing inclusion of their data directly into R-based analysis workflows. Access to MassBank data is for example possible with the <code>r BiocStyle::Biocpkg("MsBackendMassbank")</code> package. This package provides the <code>MsBackendMassbank</code> for import/export of <a href="https://github.com/MassBank/MassBank-data" class="external-link">MassBank files</a> as well as the <code>MsBackendMassbankSql</code> backend that directly interfaces the MassBank MySQL database.</p>
<p>Below we load the <code>MsBackendMassbank</code> package and connect to a local installation of the MassBank MySQL database (release <em>2021.03</em> which is provided within the docker image of this tutorial).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org" class="external-link">RMariaDB</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMassbank" class="external-link">MsBackendMassbank</a></span><span class="op">)</span>

<span class="co">#' Connect to the MassBank MySQL database</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, user <span class="op">=</span> <span class="st">"massbank"</span>, dbname <span class="op">=</span> <span class="st">"MassBank"</span>,
                 host <span class="op">=</span> <span class="st">"localhost"</span>, pass <span class="op">=</span> <span class="st">"massbank"</span><span class="op">)</span></code></pre></div>
<p>We can now initialize a <code>Spectra</code> object with a <code>MsBackendMassbankSql</code> backend to access all the data in MassBank.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Access the spectra data in MassBank</span>
<span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html" class="external-link">MsBackendMassbankSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">mbank</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 86576 spectra in a MsBackendMassbankSql backend:
##         msLevel precursorMz  polarity
##       &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;
## 1             2         506         0
## 2            NA          NA         1
## 3            NA          NA         0
## 4            NA          NA         1
## 5            NA          NA         0
## ...         ...         ...       ...
## 86572         2     449.380         1
## 86573         2     426.022         0
## 86574         2     131.060         0
## 86575         2     183.170         1
## 86576         2     358.270         0
##  ... 42 more variables/columns.
##  Use  'spectraVariables' to list all of them.</code></pre>
<p>The <code>Spectra</code> object <code>mbank</code> <em>represents</em> now the MS data from the MassBank database with in total <code>length(mbank)</code> spectra. In fact, the <code>mbank</code> object itself does not contain any MS data, but only the primary keys of the spectra in the MassBank database. Hence, it has also a relatively low memory footprint.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 6.6 Mb</code></pre>
<p>Any operation on a <code>Spectra</code> object with this backend will load the requested data from the database on demand. Calling <code>intensity</code> on such a <code>Spectra</code> object would for example retrieve the intensity values for all spectra from the database.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Get intensity values for the first spectrum</span>
<span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 1
## [["MCH00020"]] 0.980184 938.145447 56.718353 ... 2.051622 812.386597 1.093564</code></pre>
<p>As we can see, also MassBank provides absolute intensities for each spectrum. To have all the data on the same scale, we would however like to scale them to values between 0 and 100, just like we did for our experimental data. Below we thus apply the same data processing operation also to the MassBank <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' *Normalize* intensities for all MassBank spectra</span>
<span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">mbank</span>, <span class="va">norm_int</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 1
## [[1]] 0.00409025035453989 3.91482593798892 ... 0.00456337844599795</code></pre>
<p>This worked, although we are (for obvious reasons) <strong>not</strong> allowed to change the m/z and intensity values within the MassBank database. How is this then possible? It works, because any data manipulation operation on a <code>Spectra</code> object is cached within the object’s <em>lazy evaluation queue</em> and any such operation is applied to the m/z and intensity values <em>on-the-fly</em> whenever the data is requested (i.e. whenever <code>mz</code> or <code>intensity</code> is called on it). As a side effect, this also allows to <em>undo</em> certain data operations by simply calling <code>reset</code> on the <code>Spectra</code> object.</p>
<p>We next want to compare our experimental spectra against the spectra from MassBank. Instead of comparing against all 86576 available spectra, we first filter the MassBank database to spectra with a precursor m/z matching the one of the <em>[M+H]+</em> ion of cystine. Note that, as an alternative to the <code>filterPrecursorMz</code> used below, we could also use the <code>containsMz</code> function to screen for spectra containing an actual peak matching the precursor m/z.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Filter MassBank for spectra of precursor ion</span>
<span class="va">mbank_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterPrecursorMz</a></span><span class="op">(</span><span class="va">mbank</span>, mz <span class="op">=</span> <span class="va">mz</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">ppm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">mz</span>, <span class="va">mz</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">mbank_sub</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 12 spectra in a MsBackendMassbankSql backend:
##       msLevel precursorMz  polarity
##     &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;
## 1           2     241.031         1
## 2           2     241.031         1
## 3           2     241.031         1
## 4           2     241.031         1
## 5           2     241.031         1
## ...       ...         ...       ...
## 8           2     241.031         1
## 9           2     241.031         1
## 10          2     241.031         1
## 11          2     241.031         1
## 12          2     241.031         1
##  ... 42 more variables/columns.
##  Use  'spectraVariables' to list all of them.
## Lazy evaluation queue: 1 processing step(s)
## Processing:
##  Filter: select spectra with a precursor m/z within [241.028689689, 241.033510311] [Wed Aug  4 15:34:48 2021]</code></pre>
<p>This left us with 12 spectra for which we calculate the similarity against each of our experimental spectra using the <code>compareSpectra</code> function.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Compare MassBank subset to experimental spectra</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">mbank_sub</span>, <span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>##               [,1]       [,2]        [,3]        [,4]        [,5]        [,6]
## RP014401 0.2026317 0.18071444 0.180198970 0.159611261 0.178432055 0.187159472
## RP014402 0.3343503 0.29331600 0.289277897 0.306782584 0.360811559 0.362983456
## RP014403 0.0246586 0.02144096 0.005165072 0.005668103 0.005392068 0.005564441
## CE000600 0.9021127 0.88638673 0.886268770 0.866622989 0.879227845 0.884905386
## CE000598 0.9069832 0.86557977 0.854177851 0.876050308 0.910186361 0.870563436
## CE000602 0.7714246 0.75079464 0.733570598 0.777097524 0.776174404 0.720059795
## CE000595 0.4711052 0.43073883 0.440694894 0.438244787 0.501664547 0.505248228
## CE000599 0.5101048 0.53045776 0.537988018 0.473824102 0.491324937 0.501360573
## CE000596 0.7358534 0.74158396 0.748032016 0.695780398 0.718522961 0.727849493
## CE000597 0.2843629 0.30699105 0.315713004 0.258086379 0.278344659 0.286485423
## CE000603 0.6267950 0.60792849 0.622025989 0.581961642 0.646976175 0.655418467
## CE000601 0.6085564 0.56699213 0.545861294 0.604958829 0.605503692 0.552365660</code></pre>
<p>As a result we got the (normalized dot product) similarity score between each tested MassBank spectrum (rows) against each experimental spectrum (columns).</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>We get some very high similarity scores, but also some lower ones. We next determine the best matching pair from all the comparisons.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">best_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">best_match</span></code></pre></div>
<pre><code>##          row col
## CE000598   5   5</code></pre>
<p>The <code>best_match</code> variable contains now the index of the best matching MassBank and experimental spectrum. Below we visualize these two using a <em>mirror plot</em> showing in the upper panel the MS2 spectrum from MassBank and in the lower panel the best matching experimental spectrum. Matching peaks are highlighted with a blue color. Plotting functions in <code>Spectra</code> are highly customizable and in the example below we add the m/z for each individual peak as an <em>annotation</em> to it but only if the intensity of the peak is higher than 5.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Specifying a function to draw peak labels</span>
<span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">ints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
    <span class="va">mzs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
    <span class="va">mzs</span><span class="op">[</span><span class="va">ints</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">""</span>
    <span class="va">mzs</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,
                  ppm <span class="op">=</span> <span class="fl">20</span>, labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>,
                  labelOffset <span class="op">=</span> <span class="fl">0.2</span>, labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/massbank-mirror-plot-1.png" width="672"></p>
<p>As a comparison we plot also two spectra with a low similarity score.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,
                  ppm <span class="op">=</span> <span class="fl">20</span>, labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>,
                  labelOffset <span class="op">=</span> <span class="fl">0.2</span>, labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/massbank-mirror-plot-low-1.png" width="672"></p>
<p>Since we could identify a MassBank spectrum with a high similarity to our experimental spectra we would also like to know which compound this spectrum actually represents. <code>Spectra</code> objects are generally very flexible and can have arbitrarily many additional annotation fields (i.e. <em>spectra variables</em>) for each spectrum. Thus, we below use the <code>spectraVariables</code> function to list all of the variables that are available in our MassBank <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' What variables are available in MassBank</span>
<span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "spectrum_id"            
## [19] "spectrum_name"           "date"                   
## [21] "authors"                 "license"                
## [23] "copyright"               "publication"            
## [25] "splash"                  "compound_id"            
## [27] "adduct"                  "ionization"             
## [29] "ionization_voltage"      "fragmentation_mode"     
## [31] "collision_energy_text"   "instrument"             
## [33] "instrument_type"         "formula"                
## [35] "exactmass"               "smiles"                 
## [37] "inchi"                   "inchikey"               
## [39] "cas"                     "pubchem"                
## [41] "synonym"                 "precursor_mz_text"      
## [43] "compound_name"</code></pre>
<p>In fact, in addition to spectra specific information like the instrument on which it was measured or the ionization voltage used, we get also information on the originating compound such as its name (<code>"compound_name"</code>), its chemical formula (<code>"formula"</code>) or its INChI key (<code>"inchikey"</code>). We thus next subset <code>mbank_sub</code> to the best matching spectrum and display its associated compound name.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mbank_best_match</span> <span class="op">&lt;-</span> <span class="va">mbank_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">mbank_best_match</span><span class="op">$</span><span class="va">compound_name</span></code></pre></div>
<pre><code>## [1] "Cystine"</code></pre>
<p>Indeed, our experimental cystine spectrum matches (one) cystine spectrum in MassBank. Below we next add the name and the chemical formula of this spectrum to our experimental spectra. We also set the collision energy for to 20eV and assign the ion/adduct of cystine from which the reference spectrum was created.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Add annotations to the experimental spectra</span>
<span class="va">sps</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">compound_name</span>
<span class="va">sps</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">formula</span>
<span class="va">sps</span><span class="op">$</span><span class="va">adduct</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">adduct</span>
<span class="va">sps</span><span class="op">$</span><span class="va">collisionEnergy</span> <span class="op">&lt;-</span> <span class="fl">20</span></code></pre></div>
<p>Note: a more convenient spectra matching functionality designed for less experienced R users is available in the <a href="https://rformassspectrometry.github.io/MetaboAnnotation" class="external-link"><code>MetaboAnnotation</code></a> package.</p>
</div>
<div id="data-export" class="section level2">
<h2 class="hasAnchor">
<a href="#data-export" class="anchor" aria-hidden="true"></a>Data export</h2>
<p>At last we want to export our spectra to a file in MGF format. For this we use the <em><a href="https://bioconductor.org/packages/3.14/MsBackendMgf" class="external-link">MsBackendMgf</a></em> package which provides the <code>MsBackendMgf</code> backend that adds support for MGF file import/export to <code>Spectra</code> objects.</p>
<p>Data from <code>Spectra</code> objects can generally be exported with the <code>export</code> function. The format in which the data is exported depends on the specified <code>MsBackend</code> class. By using an instance of <code>MsBackendMgf</code> we define to export the data to a file in MGF format.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link">MsBackendMgf</a></span><span class="op">)</span>

<span class="co">#' Export the spectra to a MGF file</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">export</a></span><span class="op">(</span><span class="va">sps</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html" class="external-link">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"Cystine_ce20.mgf"</span><span class="op">)</span></code></pre></div>
</div>
<div id="comparing-spectra-against-hmdb" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-spectra-against-hmdb" class="anchor" aria-hidden="true"></a>Comparing spectra against HMDB</h2>
<p>In addition to the <code>MsBackendMassbank</code>, which provides access to MassBank data, there is also the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb" class="external-link"><code>MsBackendHmdb</code></a> package supporting spectral data from the public Human Metabolome Database (HMDB). This package does however not yet provide direct access to the HMDB database but, through the <code>MsBackendHmdbXml</code> backend, allows to import MS2 spectra files in HMDB format. These are provided by HMDB as individual xml files in a custom file format which are bundled (and can hence be downloaded) in a single archive.</p>
<p>To reproduce the following code it is expected (as detailed in the Installation section) that all xml files from HMDB are available in a folder <em>data/hmdb_all_spectra</em>. Below we identify all xml files containing the key word <code>"ms_ms"</code> in their file name and load them into a <code>Spectra</code> object using the <code>MsBackendHmdbXml</code> backend. Note that this import operation from the ~ 500,000 individual xml files takes up to ~ 2 hours to finish.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendHmdb" class="external-link">MsBackendHmdb</a></span><span class="op">)</span>

<span class="co">#' Get all MS2 spectra xml files and import data</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="st">"data/hmdb_all_spectra/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">"ms_ms"</span><span class="op">)</span>
<span class="va">hmdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendHmdb/man/MsBackendHmdbXml.html" class="external-link">MsBackendHmdbXml</a></span><span class="op">(</span><span class="op">)</span>, nonStop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>With this we have now a <code>Spectra</code> object containing all MS2 spectra from HMDB. Note that with the <code>MsBackendHmdbXml</code> all spectra data is kept in memory.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hmdb</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 458963 spectra in a MsBackendHmdbXml backend:
##          msLevel     rtime scanIndex
##        &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1              2        NA        NA
## 2              2        NA        NA
## 3              2        NA        NA
## 4              2        NA        NA
## 5              2        NA        NA
## ...          ...       ...       ...
## 458959         2        NA        NA
## 458960         2        NA        NA
## 458961         2        NA        NA
## 458962         2        NA        NA
## 458963         2        NA        NA
##  ... 21 more variables/columns.</code></pre>
<p>Also here, we want to filter the data resource first for spectra with a matching precursor m/z. Unfortunately, HMDB does not provided the spectra’s precursor m/z and we hence need to used the <code>containsMz</code> function to find spectra containing a peak with an m/z matching the m/z of our ion of interest. In addition, We need to use a rather large <code>tolerance</code> value (which defines the maximal acceptable absolute difference in m/z values) since some of the experimental spectra in HMDB seem to be recorded by not well calibrated instrument.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Identify spectra containing a peak matching cystine m/z</span>
<span class="va">has_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">containsMz</a></span><span class="op">(</span><span class="va">hmdb</span>, mz <span class="op">=</span> <span class="va">mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p>In total 46772 spectra contain a peak with the required m/z (+/- 0.2 Dalton) and we can proceed to calculate spectral similarities between these and our experimental spectra.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Subset HMDB</span>
<span class="va">hmdb_sub</span> <span class="op">&lt;-</span> <span class="va">hmdb</span><span class="op">[</span><span class="va">has_mz</span><span class="op">]</span>

<span class="co">#' Compare HMDB against experimental spectra</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">hmdb_sub</span>, <span class="va">sps</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p>The highest similarity between our spectra and the spectra from HMDB is <code>r max(res)</code>. Below we compare the two best matching spectra with a <em>mirror plot</em>, in the upper panel showing our experimental spectrum and in the lower panel the best matching MS2 spectrum from HMDB.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">best_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## Specifying a function to draw peak labels</span>
<span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">hmdb_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span>,
                  labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.2</span>,
                  labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/mirror-plot-1.png" width="672"></p>
<p>Our experimental spectrum seems to nicely match the <em>reference</em> MS2 in HMDB. Below we extract the compound identifier from the best matching HMDB spectrum (stored in a spectra variable called <code>"compound_id"</code>)</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hmdb_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">compound_id</span></code></pre></div>
<pre><code>## [1] "HMDB0000192"</code></pre>
<p>In fact, the matching spectrum from HMDB is an experimental spectrum for <a href="https://hmdb.ca/metabolites/HMDB0000192" class="external-link">L-Cystine</a>.</p>
</div>
</div>
<div id="short-summary" class="section level1">
<h1 class="hasAnchor">
<a href="#short-summary" class="anchor" aria-hidden="true"></a>Short summary</h1>
<ul>
<li><p>Independence between data analysis and data storage functionality allows to easily add support for additional data types or data handling/storage modes.</p></li>
<li><p>Caching data operations and applying them on-the-fly allow data manipulations regardless of how and where data is stored.</p></li>
</ul>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor" aria-hidden="true"></a>Summary</h1>
<p>With the simple use case of matching experimental MS2 spectra against a public database we illustrated in this short tutorial the flexibility and expandability of the <code>Spectra</code> package that enables the seamless integration of mass spectrometry data from different sources. This was only possible with a clear separation of the user functionality (<code>Spectra</code> object) from the representation of the data (<code>MsBackend</code> object). Backends such as the <a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link"><code>MsBackendMgf</code></a>, the <a href="https://github.com/michealwitting/MsBackendMassbank" class="external-link"><code>MsBackendMassbank</code></a> or the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb" class="external-link"><code>MsBackendHmdbXml</code></a> provide support for additional data formats or data sources, while others, due to their much lower memory footprint (<code>MsBackendMzR</code>, <code>MsBackendHdf5Peaks</code>), enable the analysis of also very large data sets. Most importantly however, these backends are interchangeable and do not affect the way users can handle and analyze MS data with the <code>Spectra</code> package. Also, by caching data operations within the <code>Spectra</code> object and applying them only upon data requests, the same data operations can be applied to any data resource regardless of how and where the data is stored, even if the data itself is <em>read-only</em>.</p>
</div>
<div id="what-else" class="section level1">
<h1 class="hasAnchor">
<a href="#what-else" class="anchor" aria-hidden="true"></a>What else?</h1>
<ul>
<li>
<a href="https://github.com/rformassspectrometry/MetaboAnnotation" class="external-link"><code>MetaboAnnotation</code></a> (Andrea Vicini, Michael Witting) to provide simple functions for matching of spectra or m/z and retention time data.</li>
<li>
<a href="https://github.com/EuracBiomedicalResearch/CompoundDb" class="external-link"><code>CompoundDb</code></a> to create and use small compound annotation databases (including <code>Spectra</code>).</li>
<li>
<a href="https://github.com/rformassspectrometry/MsExperiment" class="external-link"><code>MsExperiment</code></a> to represent whole MS experiments (incl. <code>Spectra</code>, sample annotation, data quantitation, annotation files etc).</li>
<li>
<a href="https://github.com/tnaake/msQC" class="external-link"><code>msQC</code></a> (Thomas Naake): QC measures for MS data.</li>
<li>
<a href="https://github.com/rformassspectrometry/MsBackendMsp" class="external-link"><code>MsBackendMsp</code></a> (Steffen Neumann): backend for files in MSP format.</li>
<li>
<a href="https://github.com/RforMassSpectrometry/MsBackendSql" class="external-link"><code>MsBackendSql</code></a> (Chong Tang): SQL-based backend for very large data sets.</li>
<li><code>...</code></li>
</ul>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor" aria-hidden="true"></a>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gattoMSnbaseEfficientElegant2020a" class="csl-entry">
Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020. <span>“<span>MSnbase</span>, <span>Efficient</span> and <span>Elegant R</span>-<span>Based Processing</span> and <span>Visualization</span> of <span>Raw Mass Spectrometry Data</span>.”</span> <em>Journal of Proteome Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313" class="external-link">https://doi.org/10.1021/acs.jproteome.0c00313</a>.
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Institute for Biomedicine, Eurac Research, Bolzano, Italy; <a href="mailto:johannes.rainer@eurac.edu" class="email">johannes.rainer@eurac.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Research Unit Analytical BioGeoChemistry, Helmholtz Zentrum München and Chair of Analytical Food Chemistry, TUM School or Life Sciences, Technical University of Munich, Germany<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Department of Anaesthesiology and Intensive Care, University Medicine Greifswald, Germany<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Computational Biology Unit, de Duve Institute, UCLouvain, Brussels, Belgium<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
