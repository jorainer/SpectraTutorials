<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SpectraTutorials">
<title>Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package • SpectraTutorials</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package">
<meta property="og:description" content="SpectraTutorials">
<meta property="og:image" content="https://jorainer.github.io/SpectraTutorials/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SpectraTutorials</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Spectra-matching-with-MetaboAnnotation.html">MS/MS Spectra Matching with the `MetaboAnnotation` Package</a>
    <a class="dropdown-item" href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jorainer/SpectraTutorials/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</h1>
                        <h4 data-toc-skip class="author">Johannes
Rainer<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Institute for Biomedicine, Eurac Research, Bolzano,
Italy; &lt;a href="mailto:johannes.rainer@eurac.edu" class="email"&gt;johannes.rainer@eurac.edu&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>,
Michael Witting<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Research Unit Analytical BioGeoChemistry, Helmholtz
Zentrum München and Chair of Analytical Food Chemistry, TUM School or
Life Sciences, Technical University of Munich, Germany&lt;/p&gt;"><sup>2</sup></a>, Sebastian Gibb<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Department of Anaesthesiology and Intensive Care,
University Medicine Greifswald, Germany&lt;/p&gt;"><sup>3</sup></a>, Laurent Gatto<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Computational Biology Unit, de Duve Institute,
UCLouvain, Brussels, Belgium&lt;/p&gt;"><sup>4</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/HEAD/vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd" class="external-link"><code>vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></a></small>
      <div class="d-none name"><code>analyzing-MS-data-from-different-sources-with-Spectra.Rmd</code></div>
    </div>

    
    
<p><strong>Last modified:</strong> 2022-09-19 06:15:28<br><strong>Compiled</strong>: Mon Sep 19 06:22:51 2022</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<div class="section level3">
<h3 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h3>
<p>Mass spectrometry (MS) data is a key technology in modern proteomics
and metabolomics experiments. Due to continuous improvements in MS
instrumentation, the generated data can easily become very large. Also,
additional resources of MS data exist, such as spectra libraries and
databases, all with their own specific file formats and database systems
that sometimes do not support manipulations of the original data.</p>
<p>Learning from experiences with the <em><a href="https://bioconductor.org/packages/3.16/MSnbase" class="external-link">MSnbase</a></em>
Bioconductor package, the <em><a href="https://bioconductor.org/packages/3.16/Spectra" class="external-link">Spectra</a></em>
package was developed to provide an even more flexible and expandable
infrastructure for MS data in R. This package implements a clear
separation between the user interface and the code to provide, store and
import MS data. The latter is defined by the <code>MsBackend</code>
interface which allows implementation of data type, format or
storage-dependent <em>backends</em>. Backends can thus be implemented
for specific file types and data resources or different ways to
represent MS data (e.g. in memory or <em>on-disk</em> data
representations as described in <span class="citation">(Gatto, Gibb, and
Rainer 2020)</span>). They are also supposed to be interchangeable hence
allowing the user to switch backends without affecting the analysis. To
enable processing of also very large MS data sets, data manipulations
are by default not directly applied to the data but cached in a <em>lazy
evaluation queue</em> which allows analyses also of <em>read-only</em>
data representations.</p>
<p>This workshop shows the expandability of the new infrastructure to
enable a seamless integration and analysis of MS data from a variety of
input formats. This is illustrated by a simple comparison and matching
of experimental MS2 spectra against public spectral databases and export
of the data in a format commonly used for exchange of MS2 data.</p>
</div>
<div class="section level3">
<h3 id="pre-requisites">Pre-requisites<a class="anchor" aria-label="anchor" href="#pre-requisites"></a>
</h3>
<ul>
<li>Basic familiarity with R and Bioconductor.</li>
<li>Basic understanding of Mass Spectrometry (MS) data.</li>
</ul>
</div>
<div class="section level3">
<h3 id="installation-and-participation">Installation and Participation<a class="anchor" aria-label="anchor" href="#installation-and-participation"></a>
</h3>
<ul>
<li><p>Get the <a href="https://hub.docker.com/r/jorainer/spectra_tutorials" class="external-link">docker
image</a> of this tutorial with
<code>docker pull jorainer/spectra_tutorials:latest</code>.</p></li>
<li>
<p>Start docker using</p>
<pre><code>docker run \
    -e PASSWORD=bioc \
    -p 8787:8787 \
    jorainer/spectra_tutorials:latest</code></pre>
</li>
<li><p>Enter <code>http://localhost:8787</code> in a web browser and log
in with username <code>rstudio</code> and password
<code>bioc</code>.</p></li>
<li><p>Open this R-markdown file
(<em>vignettes/analyzing-MS-data-from-different-sources-with-Spectra.Rmd</em>)
in the RStudio server version in the web browser and evaluate the R code
blocks.</p></li>
<li><p>To get the source code: clone <a href="https://github.com/jorainer/SpectraTutorials" class="external-link">this github
repository</a>, e.g. with
<code>git clone https://github.com/jorainer/SpectraTutorials</code>.</p></li>
</ul>
<p>For an alternative way to install the packages and data for the
workshop see the <em>README</em> file of the workshop’s <a href="https://github.com/jorainer/SpectraTutorials" class="external-link">github
repository</a>.</p>
</div>
<div class="section level3">
<h3 id="rbioconductor-packages-used">R/Bioconductor packages used<a class="anchor" aria-label="anchor" href="#rbioconductor-packages-used"></a>
</h3>
<ul>
<li><a href="https://bioconductor.org/packages/Spectra" class="external-link"><code>Spectra</code></a></li>
<li><a href="https://bioconductor.org/packages/MsCoreUtils" class="external-link"><code>MsCoreUtils</code></a></li>
<li><a href="https://bioconductor.org/packages/MsBackendMgf" class="external-link"><code>MsBackendMgf</code></a></li>
<li><a href="https://bioconductor.org/packages/MsBackendMassbank" class="external-link"><code>MsBackendMassbank</code></a></li>
<li><a href="https://bioconductor.org/packages/CompoundDb" class="external-link"><code>CompoundDb</code></a></li>
</ul>
</div>
<div class="section level3">
<h3 id="time-outline">Time outline<a class="anchor" aria-label="anchor" href="#time-outline"></a>
</h3>
<div class="section level4">
<h4 id="time-outline-1">Time outline<a class="anchor" aria-label="anchor" href="#time-outline-1"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th>Activity</th>
<th>Time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Introduction (LC-MS/MS, <code>Spectra</code> package)</td>
<td>10min</td>
</tr>
<tr class="even">
<td>MS data import and handling</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>Data processing and manipulation</td>
<td>5min</td>
</tr>
<tr class="even">
<td>Spectrum data comparison</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>Comparing spectra against MassBank</td>
<td>10min</td>
</tr>
<tr class="even">
<td>Data export</td>
<td>5min</td>
</tr>
<tr class="odd">
<td>(Comparing spectra against HMDB)</td>
<td>(5min)</td>
</tr>
<tr class="even">
<td>(An alternative way to store MS data)</td>
<td>(5min)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="workshop-goals-and-objectives">Workshop goals and objectives<a class="anchor" aria-label="anchor" href="#workshop-goals-and-objectives"></a>
</h3>
<div class="section level4">
<h4 id="learning-goals">Learning goals<a class="anchor" aria-label="anchor" href="#learning-goals"></a>
</h4>
<ul>
<li>Understand how to import MS data into R.</li>
<li>Understand the basic concept of <em>backends</em> in
<code>Spectra</code> and how they can be used to work with MS data from
various sources.</li>
</ul>
</div>
<div class="section level4">
<h4 id="learning-objectives">Learning objectives<a class="anchor" aria-label="anchor" href="#learning-objectives"></a>
</h4>
<ul>
<li>Import and export MS data with <code>Spectra</code>.</li>
<li>Integrate MS data from different resources into an MS data analysis
workflow.</li>
<li>Apply different data manipulations on MS data represented as a
<code>Spectra</code> object.</li>
<li>Use <code>Spectra</code> to perform spectra comparisons in R.</li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="workshop">Workshop<a class="anchor" aria-label="anchor" href="#workshop"></a>
</h2>
<div class="section level3">
<h3 id="lc-msms-in-a-nutshell">LC-MS/MS in a nutshell<a class="anchor" aria-label="anchor" href="#lc-msms-in-a-nutshell"></a>
</h3>
<ul>
<li>Mass spectrometry (<strong>MS</strong>) instruments measure
mass-to-charge ratios (m/z) and abundances of ions. The resulting m/z
and intensity values are stored/represented as a <em>spectrum</em>.</li>
<li>Most compounds are not charged, they need to be ionized first (with
e.g. electro spray ionization (<strong>ESI</strong>)).</li>
<li>MS is usually combined with another separation technique, such as
liquid chromatography (<strong>LC</strong>). This adds another dimension
to the data: retention time (rt). LC-MS data is represented by multiple
spectra, each spectrum with its own retention time.</li>
</ul>
<div class="figure">
<img src="LC-MS-drawing.gif" alt=""><p class="caption"><em>LC-MS setup</em></p>
</div>
<ul>
<li>With LC-MS we measure <em>features</em> characterized by m/z and
retention time - we still don’t know what molecule was actually
measured.</li>
<li>Create in addition fragment (MS/MS) spectra from the ions to get
some information about their structure.</li>
</ul>
<div class="figure">
<img src="MSMS.png" alt=""><p class="caption"><em>CID-based fragmentation</em></p>
</div>
<ul>
<li>Commonly used method: collision induced dissociation
(<strong>CID</strong>). In a collision chamber filled with e.g. N2, ions
get fragmented and a spectrum of these fragments is recorded <span class="citation">(Steckel and Schlosser 2019)</span>.</li>
<li>Comparing and matching such fragment spectra against a
<em>reference</em> helps identifying the compound.</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-spectra-package">The <code>Spectra</code> package<a class="anchor" aria-label="anchor" href="#the-spectra-package"></a>
</h3>
<ul>
<li>
<strong>Purpose</strong>: provide an expandable, well tested and
user-friendly infrastructure for mass spectrometry (MS) data.</li>
<li>
<strong>Design</strong>: separation between user interface
(functions) and code to provide, store and read MS data.</li>
<li>
<strong>Advantage</strong>: support different ways to store and
handle the data without affecting the user functionality: all
functionality of a <code>Spectra</code> object is independent of where
the data is, either in-memory, on-disk, locally or remote.</li>
<li>
<strong>Expandable</strong>: through implementation of additional
<em>backend</em> classes (extending the <code>MsBackend</code> virtual
class) it is possible to add support for additional input file formats
or data representations without needing to change the
<code>Spectra</code> package or object.</li>
</ul>
<div class="figure">
<img src="Spectra.png" alt=""><p class="caption">Spectra: separation into user functionality and data
representation</p>
</div>
<p>In this workshop we will:</p>
<ul>
<li>import MS data from <em>mzML</em> files,</li>
<li>select MS2 spectra for a certain compound,</li>
<li>compare and match the MS2 spectra against <em>reference</em> MS2
spectra from a public database,</li>
<li>annotate the spectra and export them to a file in <em>MGF</em>
format.</li>
</ul>
</div>
<div class="section level3">
<h3 id="ms-data-import-and-handling">MS data import and handling<a class="anchor" aria-label="anchor" href="#ms-data-import-and-handling"></a>
</h3>
<p>Below we import the MS data from the mzML files provided within this
package. These files contain MSn data of a mix of 8 standard compounds
(added either to water or a pool of human serum samples) measured with a
HILIC-based LC-MS/MS setup. MS2 data was generated by data dependent
acquisition using a collision energy of 20eV. For data import and
representation of these experimental data we use the
<code>MsBackendMzR</code> backend which supports import (and export) of
data from the most common <em>raw</em> mass spectrometry file formats
(i.e. mzML, mzXML and CDF).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Define the input files</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"mzML"</span>, package <span class="op">=</span> <span class="st">"SpectraTutorials"</span><span class="op">)</span>,</span>
<span>           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Import the data</span></span>
<span><span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The MS data is now represented by a <code>Spectra</code> object,
which can be thought of as a <code>data.frame</code> with rows being the
individual spectra and columns the spectra <em>variables</em> (such as
<code>"rtime"</code>, i.e. the retention time). The
<code>spectraVariables</code> function lists all available variables
within such a <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' List all available spectra variables (attributes)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"</span></span></code></pre>
<p>Each spectra variable can be accessed either <em>via</em>
<code>$</code> and its name or by using its dedicated access function
(which is the preferred way). Below we extract the retention times of
the first spectra using either <code>$rtime</code> or the function
<code>rtime</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Access the spectras' retention time</span></span>
<span><span class="va">sps_all</span><span class="op">$</span><span class="va">rtime</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.273 0.570 0.873 1.183 1.491 1.798</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">rtime</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.273 0.570 0.873 1.183 1.491 1.798</span></span></code></pre>
<p>Our <code>Spectra</code> object contains information from in total
1578 spectra from <code>length(unique(dataOrigin(sps_all)))</code> mzML
files. By using the <code>MsBackendMzR</code> backend, only general
information about each spectrum is kept in memory resulting in a low
memory footprint.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.4 Mb</span></span></code></pre>
<p>The spectra’s m/z and intensity values can be accessed with the
<code>mz</code> or <code>intensity</code> functions or also with the
<code>peaksData</code> function that returns a list of numeric matrices
with the m/z and intensity values. By using an <code>MsBackendMzR</code>
backend, these are retrieved on demand from the original data files each
time the functions are called.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Show the first 6 lines of the first spectrum's peak matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 50.22647  383.7802</span></span>
<span><span class="co">## [2,] 52.97586  377.5944</span></span>
<span><span class="co">## [3,] 59.97846  518.6014</span></span>
<span><span class="co">## [4,] 60.04677 4716.1259</span></span>
<span><span class="co">## [5,] 60.06897  181.5105</span></span>
<span><span class="co">## [6,] 61.02565  250.6573</span></span></code></pre>
<p>We can also load the full data into memory by changing the backend
from <code>MsBackendMzR</code> to <code>MsBackendDataFrame</code>. This
does not affect the way we use the <code>Spectra</code> object itself:
the same operations and functions are available, independently of the
way the data is stored (i.e. which backend is used).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Change backend to a MsBackendDataFrame: load data into memory</span></span>
<span><span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_all</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The size of our <code>Spectra</code> object is now larger, since the
full data has been loaded into memory.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 16.5 Mb</span></span></code></pre>
<p>To subset <code>Spectra</code> objects, we can use either
<code>[</code> or one of the many available <code>filter*</code>
functions (that are usually more efficient than <code>[</code>). We
could this subset the <code>sps_all</code> to some arbitrary spectra
simply using:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_all</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 3 spectra in a MsBackendDataFrame backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         1     1.183         4</span></span>
<span><span class="co">## 2         1     0.570         2</span></span>
<span><span class="co">## 3         1     1.491         5</span></span>
<span><span class="co">##  ... 33 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendMzR to MsBackendDataFrame [Mon Sep 19 06:22:56 2022]</span></span></code></pre>
<p>In our workshop, we next want to identify in our experimental data
MS2 spectra that were generated from an ion that matches the m/z of the
<code>[M+H]+</code> ion of the metabolite cystine (one of the standards
added to the sample mix measured in the present experimental data). We
thus use below the <code>filterPrecursorMzValues</code> function to
subset the data to MS2 spectra matching that m/z (accepting a difference
in m/z of 10 parts-per-million (ppm)).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define the m/z ratio for an ion of cystine</span></span>
<span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fl">241.0311</span></span>
<span></span>
<span><span class="co">#' Subset the dataset to MS2 spectra matching the m/z</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">filterPrecursorMzValues</a></span><span class="op">(</span><span class="va">sps_all</span>, mz <span class="op">=</span> <span class="va">mz</span>, ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 6 spectra in a MsBackendDataFrame backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2   209.936       673</span></span>
<span><span class="co">## 2         2   220.072       714</span></span>
<span><span class="co">## 3         2   231.604       734</span></span>
<span><span class="co">## 4         2   215.089       761</span></span>
<span><span class="co">## 5         2   225.739       781</span></span>
<span><span class="co">## 6         2   240.020       804</span></span>
<span><span class="co">##  ... 33 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendMzR to MsBackendDataFrame [Mon Sep 19 06:22:56 2022]</span></span>
<span><span class="co">##  Filter: select spectra with precursor m/z matching 241.0311 [Mon Sep 19 06:22:57 2022]</span></span></code></pre>
<p>In total 6 spectra matched our target precursor m/z.</p>
</div>
<div class="section level3">
<h3 id="data-processing-and-manipulation">Data processing and manipulation<a class="anchor" aria-label="anchor" href="#data-processing-and-manipulation"></a>
</h3>
<p>The <code>plotSpectra</code> function can be used to visualize
spectra. Below we plot the first spectrum from our data subset.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Plot the first spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/raw-ms2-1.png" width="672"></p>
<p>This raw MS2 spectrum contains many very low intensity peaks, most
likely representing noise. Thus we next filter the spectra removing all
peaks with an intensity smaller than 5% of the maximum intensity of each
spectrum (i.e. the base peak intensity). To this end we define a
function that takes intensity values from each spectrum as input and
returns a logical value whether the peak should be retained
(<code>TRUE</code>) or not (<code>FALSE</code>). This function is then
passed to the <code>filterIntensity</code> function to perform the
actual filtering of the spectra.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define a filtering function</span></span>
<span><span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' Apply the function to filter the spectra</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span><span class="va">sps</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span></span></code></pre></div>
<p>After filtering, the spectra are <em>cleaner</em>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Plot the first spectrum after filtering</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/raw-ms2-filtered-1.png" width="672"></p>
<p>In addition we want to replace the absolute peak intensities with
values that are relative to each spectrum’s highest peak intensity. To
this end we define a function that takes a <em>peak matrix</em> as input
(i.e. a <code>numeric</code> matrix with columns containing the m/z and
intensity values) and returns a two-column <code>numeric</code> matrix.
This function is then passed with parameter <code>FUN</code> to the
<code>addProcessing</code> function to perform the desired data
processing.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define a function to scale the intensities. `x` is expected to be a</span></span>
<span><span class="co">#' *peak matrix*, i.e. numeric matrix with columns m/z and intensity</span></span>
<span><span class="va">scale_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">maxint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="va">maxint</span></span>
<span>    <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' *Apply* the function to the data</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">scale_int</span><span class="op">)</span></span></code></pre></div>
<p>The <code>addProcessing</code> function allows to add
<strong>any</strong> user-defined data manipulation operation on MS data
(i.e. the peaks matrices) in a <code>Spectra</code> object.</p>
<p>To show the effect of the data processing we extract the intensities
of the first spectrum:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get the intensities after scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##             mz  intensity</span></span>
<span><span class="co">## [1,]  74.02289  13.439402</span></span>
<span><span class="co">## [2,] 120.01111  93.631648</span></span>
<span><span class="co">## [3,] 122.02667  49.287979</span></span>
<span><span class="co">## [4,] 151.98277 100.000000</span></span>
<span><span class="co">## [5,] 153.99924   9.422415</span></span>
<span><span class="co">## [6,] 177.99880   6.581111</span></span>
<span><span class="co">## [7,] 195.02556  12.969807</span></span>
<span><span class="co">## [8,] 241.03074  54.633224</span></span></code></pre>
<p>The intensity values are now all between 0 and 100.</p>
</div>
<div class="section level3">
<h3 id="spectrum-data-comparison">Spectrum data comparison<a class="anchor" aria-label="anchor" href="#spectrum-data-comparison"></a>
</h3>
<p>We next perform a pairwise comparison of the subsetted spectra using
the dot product as similarity measure. Prior to the actual similarity
calculation, the peaks of the individual spectra have to be matched
against each other (i.e. it has to be determined which peak from one
spectrum correspond to which from the other spectrum based on their
mass-to-charge ratios). We specify <code>ppm = 20</code> so that peaks
with a difference in m/z smaller than 20ppm will be considered
matching.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Pairwise comparison of all spectra</span></span>
<span><span class="va">sim_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">sim_mat</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]</span></span>
<span><span class="co">## [1,] 1.0000000 0.9717669 0.8907129 0.9721095 0.8795912 0.8818719</span></span>
<span><span class="co">## [2,] 0.9717669 1.0000000 0.9992127 0.9964783 0.9525726 0.9486682</span></span>
<span><span class="co">## [3,] 0.8907129 0.9992127 1.0000000 0.9947650 0.9518138 0.9478201</span></span>
<span><span class="co">## [4,] 0.9721095 0.9964783 0.9947650 1.0000000 0.9543584 0.9494561</span></span>
<span><span class="co">## [5,] 0.8795912 0.9525726 0.9518138 0.9543584 1.0000000 0.9994800</span></span>
<span><span class="co">## [6,] 0.8818719 0.9486682 0.9478201 0.9494561 0.9994800 1.0000000</span></span></code></pre>
<p>The pairwise spectra similarities are represented with the heatmap
below (note that RStudio in the docker might crash by the
<code>pheatmap</code> call - to avoid this add
<code>filename = "hm.pdf"</code> to the <code>heatmap</code> call).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></span>
<span><span class="va">hm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">sim_mat</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">101</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/ms2-heatmap-1.png" width="672"></p>
<p>The similarity between all the selected experimental MS2 spectra is
very high (in fact above 0.88) suggesting that all of them are fragment
spectra from the same original compound.</p>
</div>
<div class="section level3">
<h3 id="comparing-spectra-against-massbank">Comparing spectra against MassBank<a class="anchor" aria-label="anchor" href="#comparing-spectra-against-massbank"></a>
</h3>
<p>Although the precursor m/z of our spectra matches the m/z of cystine,
we can still not exclude that they represent fragments of ions from
different compounds (with the same m/z than cystine).</p>
<p>Matching experimental spectra against a public spectral library can
be used as a first step in the identification process of untargeted
metabolomics data. Several (public) spectral libraries for small
molecules are available, such as:</p>
<ul>
<li><a href="https://massbank.eu/MassBank/" class="external-link">MassBank</a></li>
<li>MassBank of North America <a href="https://mona.fiehnlab.ucdavis.edu/" class="external-link">MoNa</a>
</li>
<li>Human Metabolom Database <a href="https://hmdb.ca/" class="external-link">HMDB</a>
</li>
<li><a href="https://gnps.ucsd.edu/ProteoSAFe/static/gnps-splash.jsp" class="external-link">GNPS</a></li>
<li>…</li>
</ul>
<p>For some of these databases <code>MsBackend</code> interfaces are
already implemented allowing inclusion of their data directly into
R-based analysis workflows. Access to MassBank data is for example
possible with the <em><a href="https://bioconductor.org/packages/3.16/MsBackendMassbank" class="external-link">MsBackendMassbank</a></em>
package. This package provides the <code>MsBackendMassbank</code> for
import/export of <a href="https://github.com/MassBank/MassBank-data" class="external-link">MassBank files</a> as
well as the <code>MsBackendMassbankSql</code> backend that directly
interfaces the MassBank MySQL database.</p>
<p>Below we connect to a local installation of the MassBank MySQL
database (release <em>2021.03</em> which is provided within the docker
image of this tutorial).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org" class="external-link">RMariaDB</a></span><span class="op">)</span></span>
<span><span class="co">#' Connect to the MassBank MySQL database</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, user <span class="op">=</span> <span class="st">"massbank"</span>, dbname <span class="op">=</span> <span class="st">"MassBank"</span>,</span>
<span>                 host <span class="op">=</span> <span class="st">"localhost"</span>, pass <span class="op">=</span> <span class="st">"massbank"</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, if no MySQL database system is available or if this
tutorial can not be run within <em>docker</em>, an SQLite database
version of the MassBank data (in the format required for
<code>MsBackendMassbankSql</code> is available <a href="https://github.com/jorainer/SpectraTutorials/releases/tag/2021.03" class="external-link">here</a>.
After downloading the database <em>MassbankSql-2021-03.db</em> to the
current R workspace, the resource can be loaded with the code below.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Alternative to the MySQL server - assuming the SQLite database was</span></span>
<span><span class="co">## stored to the R working directory.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"MassbankSql-2021-03.db"</span><span class="op">)</span></span></code></pre></div>
<p>We next load the <code>MsBackendMassbank</code> package and
initialize a <code>Spectra</code> object with a
<code>MsBackendMassbankSql</code> backend providing it with the database
connection (either the MySQL or the SQLite connection generated
above).</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMassbank" class="external-link">MsBackendMassbank</a></span><span class="op">)</span></span>
<span><span class="co">#' Access the spectra data in MassBank</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html" class="external-link">MsBackendMassbankSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mbank</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 86576 spectra in a MsBackendMassbankSql backend:</span></span>
<span><span class="co">##         msLevel precursorMz  polarity</span></span>
<span><span class="co">##       &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1             2         506         0</span></span>
<span><span class="co">## 2            NA          NA         1</span></span>
<span><span class="co">## 3            NA          NA         0</span></span>
<span><span class="co">## 4            NA          NA         1</span></span>
<span><span class="co">## 5            NA          NA         0</span></span>
<span><span class="co">## ...         ...         ...       ...</span></span>
<span><span class="co">## 86572         2     449.380         1</span></span>
<span><span class="co">## 86573         2     426.022         0</span></span>
<span><span class="co">## 86574         2     131.060         0</span></span>
<span><span class="co">## 86575         2     183.170         1</span></span>
<span><span class="co">## 86576         2     358.270         0</span></span>
<span><span class="co">##  ... 42 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span></code></pre>
<p>The <code>Spectra</code> object <code>mbank</code>
<em>represents</em> now the MS data from the MassBank database with in
total <code>length(mbank)</code> spectra. In fact, the
<code>mbank</code> object itself does not contain any MS data, but only
the primary keys of the spectra in the MassBank database. Hence, it has
also a relatively low memory footprint.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 6.6 Mb</span></span></code></pre>
<p>Any operation on a <code>Spectra</code> object with this backend will
load the requested data from the database on demand. Calling
<code>intensity</code> on such a <code>Spectra</code> object would for
example retrieve the intensity values for all spectra from the database.
Below we extract the peaks matrix for the first spectrum.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get peaks matrix for the first spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##             mz    intensity</span></span>
<span><span class="co">##  [1,] 146.7608     0.980184</span></span>
<span><span class="co">##  [2,] 158.8635   938.145447</span></span>
<span><span class="co">##  [3,] 174.9888    56.718353</span></span>
<span><span class="co">##  [4,] 176.8688   847.169678</span></span>
<span><span class="co">##  [5,] 213.9867   133.479233</span></span>
<span><span class="co">##  [6,] 221.0402     3.189743</span></span>
<span><span class="co">##  [7,] 238.9681    76.114944</span></span>
<span><span class="co">##  [8,] 246.3159     2.592528</span></span>
<span><span class="co">##  [9,] 255.0206     2.059480</span></span>
<span><span class="co">## [10,] 256.8184     1.597428</span></span>
<span><span class="co">## [11,] 272.9973   801.059082</span></span>
<span><span class="co">## [12,] 290.9484     4.848598</span></span>
<span><span class="co">## [13,] 293.9753     1.233919</span></span>
<span><span class="co">## [14,] 310.1210    33.710808</span></span>
<span><span class="co">## [15,] 352.9528    49.103123</span></span>
<span><span class="co">## [16,] 370.9348   461.860779</span></span>
<span><span class="co">## [17,] 390.0576     4.611422</span></span>
<span><span class="co">## [18,] 408.0003 23963.912109</span></span>
<span><span class="co">## [19,] 409.0284     0.884388</span></span>
<span><span class="co">## [20,] 426.1263    69.098648</span></span>
<span><span class="co">## [21,] 470.0574     2.051622</span></span>
<span><span class="co">## [22,] 487.9893   812.386597</span></span>
<span><span class="co">## [23,] 585.8845     1.093564</span></span></code></pre>
<p>As we can see, also MassBank provides absolute intensities for each
spectrum. To have all the data on the same scale, we would however like
to scale them to values between 0 and 100, just like we did for our
experimental data. Below we thus apply the same data processing
operation also to the MassBank <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Scale intensities for all MassBank spectra</span></span>
<span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">mbank</span>, <span class="va">scale_int</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##             mz    intensity</span></span>
<span><span class="co">##  [1,] 146.7608 4.090250e-03</span></span>
<span><span class="co">##  [2,] 158.8635 3.914826e+00</span></span>
<span><span class="co">##  [3,] 174.9888 2.366824e-01</span></span>
<span><span class="co">##  [4,] 176.8688 3.535189e+00</span></span>
<span><span class="co">##  [5,] 213.9867 5.570010e-01</span></span>
<span><span class="co">##  [6,] 221.0402 1.331061e-02</span></span>
<span><span class="co">##  [7,] 238.9681 3.176232e-01</span></span>
<span><span class="co">##  [8,] 246.3159 1.081847e-02</span></span>
<span><span class="co">##  [9,] 255.0206 8.594089e-03</span></span>
<span><span class="co">## [10,] 256.8184 6.665973e-03</span></span>
<span><span class="co">## [11,] 272.9973 3.342773e+00</span></span>
<span><span class="co">## [12,] 290.9484 2.023292e-02</span></span>
<span><span class="co">## [13,] 293.9753 5.149072e-03</span></span>
<span><span class="co">## [14,] 310.1210 1.406732e-01</span></span>
<span><span class="co">## [15,] 352.9528 2.049045e-01</span></span>
<span><span class="co">## [16,] 370.9348 1.927318e+00</span></span>
<span><span class="co">## [17,] 390.0576 1.924319e-02</span></span>
<span><span class="co">## [18,] 408.0003 1.000000e+02</span></span>
<span><span class="co">## [19,] 409.0284 3.690499e-03</span></span>
<span><span class="co">## [20,] 426.1263 2.883446e-01</span></span>
<span><span class="co">## [21,] 470.0574 8.561298e-03</span></span>
<span><span class="co">## [22,] 487.9893 3.390042e+00</span></span>
<span><span class="co">## [23,] 585.8845 4.563378e-03</span></span></code></pre>
<p>This worked, although we are (for obvious reasons)
<strong>not</strong> allowed to change the m/z and intensity values
within the MassBank database. How is this then possible? It works,
because any data manipulation operation on a <code>Spectra</code> object
is cached within the object’s <em>lazy evaluation queue</em> and any
such operation is applied to the m/z and intensity values
<em>on-the-fly</em> whenever the data is requested (i.e. whenever
<code>mz</code> or <code>intensity</code> is called on it). As a side
effect, this also allows to <em>undo</em> certain data operations by
simply calling <code>reset</code> on the <code>Spectra</code>
object.</p>
<p>We next want to compare our experimental spectra against the spectra
from MassBank. Instead of comparing against all 86576 available spectra,
we first filter the MassBank database to spectra with a precursor m/z
matching the one of the <em>[M+H]+</em> ion of cystine. Note that, as an
alternative to the <code>filterPrecursorMzValues</code> used below, we
could also use the <code>containsMz</code> function to screen for
spectra containing an actual peak matching the precursor m/z.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Filter MassBank for spectra of precursor ion</span></span>
<span><span class="va">mbank_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">filterPrecursorMzValues</a></span><span class="op">(</span><span class="va">mbank</span>, mz <span class="op">=</span> <span class="va">mz</span>, ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mbank_sub</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 12 spectra in a MsBackendMassbankSql backend:</span></span>
<span><span class="co">##       msLevel precursorMz  polarity</span></span>
<span><span class="co">##     &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           2     241.031         1</span></span>
<span><span class="co">## 2           2     241.031         1</span></span>
<span><span class="co">## 3           2     241.031         1</span></span>
<span><span class="co">## 4           2     241.031         1</span></span>
<span><span class="co">## 5           2     241.031         1</span></span>
<span><span class="co">## ...       ...         ...       ...</span></span>
<span><span class="co">## 8           2     241.031         1</span></span>
<span><span class="co">## 9           2     241.031         1</span></span>
<span><span class="co">## 10          2     241.031         1</span></span>
<span><span class="co">## 11          2     241.031         1</span></span>
<span><span class="co">## 12          2     241.031         1</span></span>
<span><span class="co">##  ... 42 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">## Lazy evaluation queue: 1 processing step(s)</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select spectra with precursor m/z matching 241.0311 [Mon Sep 19 06:23:01 2022]</span></span></code></pre>
<p>This left us with 12 spectra for which we calculate the similarity
against each of our experimental spectra using the
<code>compareSpectra</code> function.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compare MassBank subset to experimental spectra</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">mbank_sub</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##       RP014401  RP014402    RP014403  CE000600  CE000598  CE000602  CE000595</span></span>
<span><span class="co">## [1,] 0.2026317 0.3343503 0.024658599 0.9021127 0.9069832 0.7714246 0.4711052</span></span>
<span><span class="co">## [2,] 0.1807144 0.2933160 0.021440961 0.8863867 0.8655798 0.7507946 0.4307388</span></span>
<span><span class="co">## [3,] 0.1801990 0.2892779 0.005165072 0.8862688 0.8541779 0.7335706 0.4406949</span></span>
<span><span class="co">## [4,] 0.1596113 0.3067826 0.005668103 0.8666230 0.8760503 0.7770975 0.4382448</span></span>
<span><span class="co">## [5,] 0.1784321 0.3608116 0.005392068 0.8792278 0.9101864 0.7761744 0.5016645</span></span>
<span><span class="co">## [6,] 0.1871595 0.3629835 0.005564441 0.8849054 0.8705634 0.7200598 0.5052482</span></span>
<span><span class="co">##       CE000599  CE000596  CE000597  CE000603  CE000601</span></span>
<span><span class="co">## [1,] 0.5101048 0.7358534 0.2843629 0.6267950 0.6085564</span></span>
<span><span class="co">## [2,] 0.5304578 0.7415840 0.3069911 0.6079285 0.5669921</span></span>
<span><span class="co">## [3,] 0.5379880 0.7480320 0.3157130 0.6220260 0.5458613</span></span>
<span><span class="co">## [4,] 0.4738241 0.6957804 0.2580864 0.5819616 0.6049588</span></span>
<span><span class="co">## [5,] 0.4913249 0.7185230 0.2783447 0.6469762 0.6055037</span></span>
<span><span class="co">## [6,] 0.5013606 0.7278495 0.2864854 0.6554185 0.5523657</span></span></code></pre>
<p>As a result we got the (normalized dot product) similarity score
between each tested MassBank spectrum (rows) against each experimental
spectrum (columns).</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>We get some very high similarity scores, but also some lower ones. We
next determine the best matching pair from all the comparisons.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">best_match</span></span></code></pre></div>
<pre><code><span><span class="co">##      row col</span></span>
<span><span class="co">## [1,]   5   5</span></span></code></pre>
<p>The <code>best_match</code> variable contains now the index of the
best matching MassBank and experimental spectrum. Below we visualize
these two using a <em>mirror plot</em> showing in the upper panel the
MS2 spectrum from MassBank and in the lower panel the best matching
experimental spectrum. Matching peaks are highlighted with a blue color.
Plotting functions in <code>Spectra</code> are highly customizable and
in the example below we add the m/z for each individual peak as an
<em>annotation</em> to it but only if the intensity of the peak is
higher than 5.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Specifying a function to draw peak labels</span></span>
<span><span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">mzs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>    <span class="va">mzs</span><span class="op">[</span><span class="va">ints</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">""</span></span>
<span>    <span class="va">mzs</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                  ppm <span class="op">=</span> <span class="fl">20</span>, labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  labelOffset <span class="op">=</span> <span class="fl">0.2</span>, labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/massbank-mirror-plot-1.png" width="672"></p>
<p>As a comparison we plot also two spectra with a low similarity
score.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                  ppm <span class="op">=</span> <span class="fl">20</span>, labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  labelOffset <span class="op">=</span> <span class="fl">0.2</span>, labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/massbank-mirror-plot-low-1.png" width="672"></p>
<p>Since we could identify a MassBank spectrum with a high similarity to
our experimental spectra we would also like to know which compound this
spectrum actually represents. <code>Spectra</code> objects are generally
very flexible and can have arbitrarily many additional annotation fields
(i.e. <em>spectra variables</em>) for each spectrum. Thus, we below use
the <code>spectraVariables</code> function to list all of the variables
that are available in our MassBank <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' What variables are available in MassBank</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">mbank_sub</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "spectrum_id"            </span></span>
<span><span class="co">## [19] "spectrum_name"           "date"                   </span></span>
<span><span class="co">## [21] "authors"                 "license"                </span></span>
<span><span class="co">## [23] "copyright"               "publication"            </span></span>
<span><span class="co">## [25] "splash"                  "compound_id"            </span></span>
<span><span class="co">## [27] "adduct"                  "ionization"             </span></span>
<span><span class="co">## [29] "ionization_voltage"      "fragmentation_mode"     </span></span>
<span><span class="co">## [31] "collision_energy_text"   "instrument"             </span></span>
<span><span class="co">## [33] "instrument_type"         "formula"                </span></span>
<span><span class="co">## [35] "exactmass"               "smiles"                 </span></span>
<span><span class="co">## [37] "inchi"                   "inchikey"               </span></span>
<span><span class="co">## [39] "cas"                     "pubchem"                </span></span>
<span><span class="co">## [41] "synonym"                 "precursor_mz_text"      </span></span>
<span><span class="co">## [43] "compound_name"</span></span></code></pre>
<p>In fact, in addition to spectra specific information like the
instrument on which it was measured or the ionization voltage used, we
get also information on the originating compound such as its name
(<code>"compound_name"</code>), its chemical formula
(<code>"formula"</code>) or its INChI key (<code>"inchikey"</code>). We
thus next subset <code>mbank_sub</code> to the best matching spectrum
and display its associated compound name.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mbank_best_match</span> <span class="op">&lt;-</span> <span class="va">mbank_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">mbank_best_match</span><span class="op">$</span><span class="va">compound_name</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Cystine"</span></span></code></pre>
<p>Indeed, our experimental cystine spectrum matches (one) cystine
spectrum in MassBank. Below we next add the name and the chemical
formula of this spectrum to our experimental spectra. We also set the
collision energy for to 20eV and assign the ion/adduct of cystine from
which the reference spectrum was created. <code>Spectra</code> allows
adding new (or replacing existing) spectra variables using
<code>$&lt;-</code>.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Add annotations to the experimental spectra</span></span>
<span><span class="va">sps</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">compound_name</span></span>
<span><span class="va">sps</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">formula</span></span>
<span><span class="va">sps</span><span class="op">$</span><span class="va">adduct</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">adduct</span></span>
<span><span class="va">sps</span><span class="op">$</span><span class="va">collisionEnergy</span> <span class="op">&lt;-</span> <span class="fl">20</span></span></code></pre></div>
<p>Note: a more convenient spectra matching functionality designed for
less experienced R users is available in the <a href="https://rformassspectrometry.github.io/MetaboAnnotation" class="external-link"><code>MetaboAnnotation</code></a>
package. A second tutorial is available within this github repository/R
package and additional tutorials can be found in the <a href="https://jorainer.github.io/MetaboAnnotationTutorials" class="external-link">MetaboAnnotationTutorials</a>
repository/R package.</p>
</div>
<div class="section level3">
<h3 id="data-export">Data export<a class="anchor" aria-label="anchor" href="#data-export"></a>
</h3>
<p>At last we want to export our spectra to a file in MGF format. For
this we use the <em><a href="https://bioconductor.org/packages/3.16/MsBackendMgf" class="external-link">MsBackendMgf</a></em>
package which provides the <code>MsBackendMgf</code> backend that adds
support for MGF file import/export to <code>Spectra</code> objects.</p>
<p>Data from <code>Spectra</code> objects can generally be exported with
the <code>export</code> function. The format in which the data is
exported depends on the specified <code>MsBackend</code> class. By using
an instance of <code>MsBackendMgf</code> we define to export the data to
a file in MGF format.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link">MsBackendMgf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Export the spectra to a MGF file</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">export</a></span><span class="op">(</span><span class="va">sps</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html" class="external-link">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"Cystine_ce20.mgf"</span><span class="op">)</span></span></code></pre></div>
<p>Below we read the first 6 lines from the resulting file.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"Cystine_ce20.mgf"</span>, n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "BEGIN IONS"                               </span></span>
<span><span class="co">## [2] "TITLE=msLevel 2; retentionTime ; scanNum "</span></span>
<span><span class="co">## [3] "msLevel=2"                                </span></span>
<span><span class="co">## [4] "RTINSECONDS=209.93599999998"              </span></span>
<span><span class="co">## [5] "SCANS=673"                                </span></span>
<span><span class="co">## [6] "scanIndex=673"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="comparing-spectra-against-hmdb">Comparing spectra against HMDB<a class="anchor" aria-label="anchor" href="#comparing-spectra-against-hmdb"></a>
</h3>
<p>In addition to the <code>MsBackendMassbank</code>, which provides
access to MassBank data, there is also the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb" class="external-link"><code>MsBackendHmdb</code></a>
package supporting spectral data from the public Human Metabolome
Database (HMDB). This package does however not yet provide direct access
to the HMDB database but, through the <code>MsBackendHmdbXml</code>
backend, allows to import MS2 spectra files in HMDB format. These are
provided by HMDB as individual xml files in a custom file format which
are bundled (and can hence be downloaded) in a single archive.</p>
<p>As an alternative, it is also possible to create portable annotation
resources using the <a href="https://rformassspectrometry.github.io/CompoundDb" class="external-link"><code>CompoundDb</code></a>
package. This packages allows for example to create annotation databases
for MoNA, MassBank or HMDB. <code>CompDb</code> with annotations for
small compounds from different resources will become available also on
Bioconductors <em><a href="https://bioconductor.org/packages/3.16/AnnotationHub" class="external-link">AnnotationHub</a></em>.</p>
<p>A <code>CompDb</code> database containing all compound annotations
along with all (experimental) MS2 spectra is provided as a data release
in the <a href="https://jorainer.github.io/MetaboAnnotationTutorials/" class="external-link">MetaboAnnotationTutorials</a>
repository. Below we download this SQLite database to a temporary
file.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Download the CompDb database using curl</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jeroen/curl" class="external-link">curl</a></span><span class="op">)</span></span>
<span><span class="va">dbname</span> <span class="op">&lt;-</span> <span class="st">"CompDb.Hsapiens.HMDB.5.0.sqlite"</span></span>
<span><span class="va">db_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbname</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/curl/man/curl_download.html" class="external-link">curl_download</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"https://github.com/jorainer/MetaboAnnotationTutorials/"</span>,</span>
<span>           <span class="st">"releases/download/2021-11-02/"</span>, <span class="va">dbname</span><span class="op">)</span>,</span>
<span>    destfile <span class="op">=</span> <span class="va">db_file</span><span class="op">)</span></span></code></pre></div>
<p>We can now load this annotation resource using the
<code>CompDb</code> function from the <code>CompoundDb</code>
package:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/CompoundDb" class="external-link">CompoundDb</a></span><span class="op">)</span></span>
<span><span class="co">#' Load a CompDb database with compound annotation from HMDB</span></span>
<span><span class="va">cdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/CompDb.html" class="external-link">CompDb</a></span><span class="op">(</span><span class="va">db_file</span><span class="op">)</span></span>
<span><span class="va">cdb</span></span></code></pre></div>
<pre><code><span><span class="co">## class: CompDb </span></span>
<span><span class="co">##  data source: HMDB </span></span>
<span><span class="co">##  version: 5.0 </span></span>
<span><span class="co">##  organism: Hsapiens </span></span>
<span><span class="co">##  compound count: 217776 </span></span>
<span><span class="co">##  MS/MS spectra count: 64920</span></span></code></pre>
<p>We can now again create a <code>Spectra</code> object to get access
to the MS2 spectra within this package:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hmdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">)</span></span></code></pre></div>
<p>With this we have now a <code>Spectra</code> object containing all
MS2 spectra from HMDB along with compound annotations.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hmdb</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 64920 spectra in a MsBackendCompDb backend:</span></span>
<span><span class="co">##         msLevel precursorMz  polarity</span></span>
<span><span class="co">##       &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            NA          NA         1</span></span>
<span><span class="co">## 2            NA          NA         1</span></span>
<span><span class="co">## 3            NA          NA         1</span></span>
<span><span class="co">## 4            NA          NA         1</span></span>
<span><span class="co">## 5            NA          NA         1</span></span>
<span><span class="co">## ...         ...         ...       ...</span></span>
<span><span class="co">## 64916        NA          NA         0</span></span>
<span><span class="co">## 64917        NA          NA         0</span></span>
<span><span class="co">## 64918        NA          NA         0</span></span>
<span><span class="co">## 64919        NA          NA         0</span></span>
<span><span class="co">## 64920        NA          NA         1</span></span>
<span><span class="co">##  ... 32 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">##  data source: HMDB </span></span>
<span><span class="co">##  version: 5.0 </span></span>
<span><span class="co">##  organism: Hsapiens</span></span></code></pre>
<p>The spectra variables (including compound annotations) available for
each spectrum are:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">hmdb</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "compound_id"            </span></span>
<span><span class="co">## [19] "name"                    "inchi"                  </span></span>
<span><span class="co">## [21] "inchikey"                "formula"                </span></span>
<span><span class="co">## [23] "exactmass"               "smiles"                 </span></span>
<span><span class="co">## [25] "original_spectrum_id"    "predicted"              </span></span>
<span><span class="co">## [27] "splash"                  "instrument_type"        </span></span>
<span><span class="co">## [29] "instrument"              "spectrum_id"            </span></span>
<span><span class="co">## [31] "msms_mz_range_min"       "msms_mz_range_max"      </span></span>
<span><span class="co">## [33] "synonym"</span></span></code></pre>
<p>Also here, we want to filter the data resource first for spectra with
a matching precursor m/z. Unfortunately, HMDB does not provided the
spectra’s precursor m/z and we hence need to used the
<code>containsMz</code> function to find spectra containing a peak with
an m/z matching the m/z of our ion of interest. In addition, We need to
use a rather large <code>tolerance</code> value (which defines the
maximal acceptable absolute difference in m/z values) since some of the
experimental spectra in HMDB seem to be recorded by not well calibrated
instrument.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Identify spectra containing a peak matching cystine m/z</span></span>
<span><span class="va">has_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">containsMz</a></span><span class="op">(</span><span class="va">hmdb</span>, mz <span class="op">=</span> <span class="va">mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>In total 3904 spectra contain a peak with the required m/z (+/- 0.2
Dalton) and we can proceed to calculate spectral similarities between
these and our experimental spectra.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Subset HMDB</span></span>
<span><span class="va">hmdb_sub</span> <span class="op">&lt;-</span> <span class="va">hmdb</span><span class="op">[</span><span class="va">has_mz</span><span class="op">]</span></span>
<span><span class="co">#' Compare HMDB against experimental spectra</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">hmdb_sub</span>, <span class="va">sps</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>The highest similarity between our spectra and the spectra from HMDB
is <code>r max(res)</code>. Below we compare the two best matching
spectra with a <em>mirror plot</em>, in the upper panel showing our
experimental spectrum and in the lower panel the best matching MS2
spectrum from HMDB.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## Specifying a function to draw peak labels</span></span>
<span><span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">hmdb_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                  labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                  labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="analyzing-MS-data-from-different-sources-with-Spectra_files/figure-html/mirror-plot-1.png" width="672"></p>
<p>Our experimental spectrum seems to nicely match the
<em>reference</em> MS2 in HMDB. Below we extract the compound identifier
from the best matching HMDB spectrum (stored in a spectra variable
called <code>"compound_id"</code>)</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hmdb_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">compound_id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "HMDB0000192"</span></span></code></pre>
<p>And the name of this compound</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hmdb_sub</span><span class="op">[</span><span class="va">best_match</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "L-Cystine"</span></span></code></pre>
<p>In fact, the matching spectrum from HMDB is an experimental spectrum
for <a href="https://hmdb.ca/metabolites/HMDB0000192" class="external-link">L-Cystine</a>.</p>
</div>
<div class="section level3">
<h3 id="an-alternative-way-to-store-ms-data">An alternative way to store MS data<a class="anchor" aria-label="anchor" href="#an-alternative-way-to-store-ms-data"></a>
</h3>
<p>For some use cases it might be useful to store the data from whole MS
experiments in a central place. The <code>MsqlBackend</code> backend
allows for example to store such data into a relational database, such
as simple <em>SQLite</em> files or <em>MySQL</em>/<em>MariaDB</em>
database systems. The latter case would allow also remote access to a
centrally stored data set. Also, performance, especially for large
datasets would be much better with a MySQL database compared to a SQLite
database as used here. In this section we show how data from an MS
experiment can be inserted into such a database and how it can be again
retrieved.</p>
<p>Below we create an empty SQLite database (in a temporary file). As
detailed above, any SQL database system could be used instead (resulting
eventually in even better performance).</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span><span class="va">scon</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can next import the data from our example experiment into the
selected database.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsqlBackend" class="external-link">MsqlBackend</a></span><span class="op">)</span></span>
<span><span class="co">## Create a database containing the full raw data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/MsqlBackend/man/MsqlBackend.html" class="external-link">createMsqlBackendDatabase</a></span><span class="op">(</span><span class="va">scon</span>, <span class="va">fls</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>The <code>MsqlBackend</code> allows now to access and use the MS data
stored in such a database. We simply provide the connection to the
database as a parameter to the <code>Spectra</code> function and use the
<code>MsqlBackend</code> as <em>backend</em>.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">scon</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsqlBackend/man/MsqlBackend.html" class="external-link">MsqlBackend</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_db</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1578 spectra in a MsqlBackend backend:</span></span>
<span><span class="co">##        msLevel precursorMz  polarity</span></span>
<span><span class="co">##      &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1          NA         1</span></span>
<span><span class="co">## 2            1          NA         1</span></span>
<span><span class="co">## 3            1          NA         1</span></span>
<span><span class="co">## 4            1          NA         1</span></span>
<span><span class="co">## 5            1          NA         1</span></span>
<span><span class="co">## ...        ...         ...       ...</span></span>
<span><span class="co">## 1574         2    130.9659         1</span></span>
<span><span class="co">## 1575         2    175.1178         1</span></span>
<span><span class="co">## 1576         2    193.9281         1</span></span>
<span><span class="co">## 1577         2    107.9501         1</span></span>
<span><span class="co">## 1578         2     95.0608         1</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">## Database: /tmp/Rtmpd0oLdw/file60218bd9c23</span></span></code></pre>
<p>The memory footprint of this <code>Spectra</code> object is only very
small as all the data is retrieved from the database
<em>on-the-fly</em>.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_db</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.1 Mb</span></span></code></pre>
<p>The performance of this backend is also higher than for example of a
<code>MsBackendMzR</code>. Below we compare the performance of the
<code>MsqlBackend</code> on the present small data set to a
<code>MsBackendDataFrame</code> (data in-memory) and a
<code>MsBackendMzR</code> (data retrieved from original file).</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Load the data to different backends</span></span>
<span><span class="va">sps_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_mzr</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_df</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_db</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##                expr      min       lq      mean    median       uq      max</span></span>
<span><span class="co">##  peaksData(sps_mzr) 446.1647 454.2958 466.48957 460.80715 488.7996 494.9686</span></span>
<span><span class="co">##   peaksData(sps_df) 138.5289 140.6505 150.90686 145.00480 159.4934 182.5854</span></span>
<span><span class="co">##   peaksData(sps_db)  88.0310  90.7271  95.82102  94.67725  97.8086 115.0974</span></span>
<span><span class="co">##  neval</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span></code></pre>
<p>Thus, the <code>MsqlBackend</code> has similar performance than
having all the data in memory. The performance is even better if smaller
subsets of the data are loaded.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_db</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##                      expr     min      lq     mean   median      uq     max</span></span>
<span><span class="co">##  peaksData(sps_mzr[1:10]) 16.5493 16.8125 17.06416 16.98370 17.1897 18.2603</span></span>
<span><span class="co">##   peaksData(sps_df[1:10])  6.8988  7.1295  8.04241  7.30760  7.6314 12.6421</span></span>
<span><span class="co">##   peaksData(sps_db[1:10])  2.8145  2.8960  3.00021  2.93295  3.0558  3.4799</span></span>
<span><span class="co">##  neval</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span></code></pre>
<p>A real world use case for such a backend would be to store a large MS
experiment in a central place. Data analysts could connect to that
central database, explore and subset the data and ultimately either load
subsets of the data into the (local) memory by changing the backend of
the data subset to e.g. a <code>MsBackendDataFrame</code> or store the
data subset to local files e.g. in mzML format by using the
<code>export</code> method and the <code>MsBackendMzR</code>
backend.</p>
</div>
</div>
<div class="section level2">
<h2 id="short-summary">Short summary<a class="anchor" aria-label="anchor" href="#short-summary"></a>
</h2>
<ul>
<li><p><code>Spectra</code> provides a powerful infrastructure for MS
data.</p></li>
<li><p>Independence between data analysis and data storage functionality
allows to easily add support for additional data types or data
handling/storage modes.</p></li>
<li><p>Caching data operations and applying them on-the-fly allows data
manipulations regardless of how and where data is stored.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>With the simple use case of matching experimental MS2 spectra against
a public database we illustrated in this short tutorial the flexibility
and expandability of the <code>Spectra</code> package that enables the
seamless integration of mass spectrometry data from different sources.
This was only possible with a clear separation of the user functionality
(<code>Spectra</code> object) from the representation of the data
(<code>MsBackend</code> object). Backends such as the <a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link"><code>MsBackendMgf</code></a>,
the <a href="https://github.com/michealwitting/MsBackendMassbank" class="external-link"><code>MsBackendMassbank</code></a>
or the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb" class="external-link"><code>MsBackendHmdbXml</code></a>
provide support for additional data formats or data sources, while
others, due to their much lower memory footprint
(<code>MsBackendMzR</code>, <code>MsBackendHdf5Peaks</code>), enable the
analysis of also very large data sets. Most importantly however, these
backends are interchangeable and do not affect the way users can handle
and analyze MS data with the <code>Spectra</code> package. Also, by
caching data operations within the <code>Spectra</code> object and
applying them only upon data requests, the same data operations can be
applied to any data resource regardless of how and where the data is
stored, even if the data itself is <em>read-only</em>.</p>
</div>
<div class="section level2">
<h2 id="what-else">What else?<a class="anchor" aria-label="anchor" href="#what-else"></a>
</h2>
<ul>
<li>
<a href="https://github.com/rformassspectrometry/MetaboAnnotation" class="external-link"><code>MetaboAnnotation</code></a>
(Andrea Vicini, Michael Witting) to provide simple functions for
matching of spectra or m/z and retention time data <span class="citation">(Rainer et al. 2022)</span>.</li>
<li>
<a href="https://github.com/rformassspectrometry/MsExperiment" class="external-link"><code>MsExperiment</code></a>
to represent whole MS experiments (incl. <code>Spectra</code>, sample
annotation, data quantitation, annotation files etc).</li>
<li>
<a href="https://github.com/tnaake/msQC" class="external-link"><code>msQC</code></a>
(Thomas Naake): QC measures for MS data.</li>
<li>
<a href="https://github.com/rformassspectrometry/MsBackendMsp" class="external-link"><code>MsBackendMsp</code></a>
(Steffen Neumann): backend for files in MSP format.</li>
<li><code>...</code></li>
</ul>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-gattoMSnbaseEfficientElegant2020a" class="csl-entry">
Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020.
<span>“<span>MSnbase</span>, <span>Efficient</span> and <span>Elegant
R</span>-<span>Based Processing</span> and <span>Visualization</span> of
<span>Raw Mass Spectrometry Data</span>.”</span> <em>Journal of Proteome
Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313" class="external-link">https://doi.org/10.1021/acs.jproteome.0c00313</a>.
</div>
<div id="ref-rainer_modular_2022" class="csl-entry">
Rainer, Johannes, Andrea Vicini, Liesa Salzer, Jan Stanstrup, Josep M.
Badia, Steffen Neumann, Michael A. Stravs, et al. 2022. <span>“A
<span>Modular</span> and <span>Expandable</span> <span>Ecosystem</span>
for <span>Metabolomics</span> <span>Data</span> <span>Annotation</span>
in <span>R</span>.”</span> <em>Metabolites</em> 12 (2): 173. <a href="https://doi.org/10.3390/metabo12020173" class="external-link">https://doi.org/10.3390/metabo12020173</a>.
</div>
<div id="ref-steckel_organic_2019" class="csl-entry">
Steckel, Arnold, and Gitta Schlosser. 2019. <span>“An
<span>Organic</span> <span>Chemist</span>’s <span>Guide</span> to
<span>Electrospray</span> <span>Mass</span> <span>Spectrometric</span>
<span>Structure</span> <span>Elucidation</span>.”</span> <em>Molecules
(Basel, Switzerland)</em> 24 (3): E611. <a href="https://doi.org/10.3390/molecules24030611" class="external-link">https://doi.org/10.3390/molecules24030611</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
