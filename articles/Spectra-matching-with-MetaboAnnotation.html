<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MS/MS Spectra Matching with the `MetaboAnnotation` Package • SpectraTutorials</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MS/MS Spectra Matching with the `MetaboAnnotation` Package">
<meta property="og:description" content="SpectraTutorials">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpectraTutorials</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Spectra-matching-with-MetaboAnnotation.html">MS/MS Spectra Matching with the `MetaboAnnotation` Package</a>
    </li>
    <li>
      <a href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jorainer/SpectraTutorials">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Spectra-matching-with-MetaboAnnotation_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip></h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/master/vignettes/Spectra-matching-with-MetaboAnnotation.Rmd"><code>vignettes/Spectra-matching-with-MetaboAnnotation.Rmd</code></a></small>
      <div class="hidden name"><code>Spectra-matching-with-MetaboAnnotation.Rmd</code></div>

    </div>

    
    
<table class="table"><tbody>
<tr class="odd">
<td>title: “MS/MS Spectra Matching with the <code>MetaboAnnotation</code> Package”</td>
</tr>
<tr class="even">
<td>author: “Johannes Rainer^[Institute for Biomedicine, Eurac Research, Bolzano,</td>
</tr>
<tr class="odd">
<td>Italy; <a href="mailto:johannes.rainer@eurac.edu" class="email">johannes.rainer@eurac.edu</a>], Michael Witting^[Research Unit Analytical</td>
</tr>
<tr class="even">
<td>BioGeoChemistry, Helmholtz Zentrum München and Chair of Analytical Food Chemistry, TUM School or Life Sciences, Technical University of Munich, Germany]”</td>
</tr>
<tr class="odd">
<td>output:</td>
</tr>
<tr class="even">
<td>rmarkdown::html_document:</td>
</tr>
<tr class="odd">
<td>highlight: pygments</td>
</tr>
<tr class="even">
<td>toc: true</td>
</tr>
<tr class="odd">
<td>toc_depth: 3</td>
</tr>
<tr class="even">
<td>fig_width: 5</td>
</tr>
<tr class="odd">
<td>vignette: &gt;</td>
</tr>
<tr class="even">
<td>%</td>
</tr>
<tr class="odd">
<td>%</td>
</tr>
<tr class="even">
<td>%</td>
</tr>
<tr class="odd">
<td>%</td>
</tr>
<tr class="even">
<td>%</td>
</tr>
<tr class="odd">
<td>bibliography: references.bib</td>
</tr>
</tbody></table>
<p><strong>Last modified:</strong> 2021-10-04 14:50:05<br><strong>Compiled</strong>: Mon Oct 4 14:56:24 2021</p>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The <code>Spectra</code> package provides all the functionality required for annotation and identification workflows for untargeted LC-MS/MS data, but, while being very flexible and customizable, it might be too cumbersome for beginners or analysts not accustomed with R. To fill this gap we developed the <a href="https://rformassspectrometry.github.io/MetaboAnnotation"><code>MetaboAnnotation</code></a> package that builds upon <code>Spectra</code> and provides functions for annotation of LC-MS and LC-MS/MS data sets tailored towards the less experienced R user.</p>
</div>
<div id="convenient-spectra-matching-using-metaboannotation" class="section level2">
<h2 class="hasAnchor">
<a href="#convenient-spectra-matching-using-metaboannotation" class="anchor"></a>Convenient spectra matching using <code>MetaboAnnotation</code>
</h2>
<p>In this example use case we match experimental MS2 spectra from a DDA experiment on a pesticide mix against reference spectra from MassBank. Below we load the experimental data file which is distributed <em>via</em> the <code>msdata</code> R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/">pander</a></span><span class="op">)</span>

<span class="co">#' Load the pesticide mix data</span>
<span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_DDA.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>
<span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span></code></pre></div>
<p>We next restrict the data set to MS2 spectra only and in addition <em>clean</em> these spectra by removing all peaks from a spectrum that have an intensity lower than 5% of the largest peak intensity of that spectrum. Finally, single-peak spectra are removed.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' restrict to MS2 data and remove intensities with intensity lower 5%</span>
<span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu">filterMsLevel</span><span class="op">(</span><span class="va">pest</span>, msLevel <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span>

<span class="co">#' Remove peaks with an intensity below 5% or the spectra's BPC</span>
<span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span>
<span class="op">}</span>
<span class="va">pest</span> <span class="op">&lt;-</span> <span class="fu">filterIntensity</span><span class="op">(</span><span class="va">pest</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span>

<span class="co">#' Remove peaks with a single peak</span>
<span class="va">pest</span> <span class="op">&lt;-</span> <span class="va">pest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">pest</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></code></pre></div>
<p>This leads to a data set consisting of 2451 spectra. We next connect to a MassBank database (running within this docker image) and create a <code>Spectra</code> object representing that data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org">RMariaDB</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMassbank">MsBackendMassbank</a></span><span class="op">)</span>

<span class="co">#' Connect to the MassBank MySQL database</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, user <span class="op">=</span> <span class="st">"massbank"</span>, dbname <span class="op">=</span> <span class="st">"MassBank"</span>,
                 host <span class="op">=</span> <span class="st">"localhost"</span>, pass <span class="op">=</span> <span class="st">"massbank"</span><span class="op">)</span>
<span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html">MsBackendMassbankSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We could now directly calculate similarities between the 2451 experimental (query) MS2 spectra and the 86576 MassBank reference (target) spectra using the <code>compareSpectra</code> method, but this would be computationally very intense because a similarity score would be calculated between each query and each target spectrum. As alternative we use here the <code>matchSpectra</code> function from the <a href="https://github.com/RforMassSpectrometry/MetaboAnnotation"><code>MetaboAnnotation</code></a> package that allows to restrict similarity calculations only between query and target spectra that have a similar precursor m/z. We thus create below a <code>CompareSpectraParam</code> object with parameter <code>requirePrecursor = TRUE</code> (to restrict similarity calculations only to query and target spectra with a similar precursor m/z) and <code>ppm = 10</code> (m/z difference between the query and target precursor has to be within 10 ppm). Parameter <code>THRESHFUN</code> enables to define a <em>threshold function</em> that defines which spectra are considered matching. With the function used below only MS2 spectra with a similarity (calculated with the default <em>dotproduct</em> function) larger or equal to 0.8 are considered matching.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboAnnotation">MetaboAnnotation</a></span><span class="op">)</span>
<span class="va">prm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/CompareSpectraParam.html">CompareSpectraParam</a></span><span class="op">(</span>ppm <span class="op">=</span> <span class="fl">10</span>, requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>,
                           THRESHFUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We next call <code>matchSpectra</code> with this parameter object and pass <code>pest</code> and <code>mbank</code> as query and target <code>Spectra</code>, respectively. This takes approximately 1 minute to complete, which is not tremendously fast, but still much faster than a pairwise comparison between all query and target spectra would be.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest</span>, <span class="va">mbank</span>, param <span class="op">=</span> <span class="va">prm</span><span class="op">)</span>
<span class="va">mtch</span></code></pre></div>
<pre><code>## Object of class MatchedSpectra 
## Total number of matches: 78 
## Number of query objects: 2451 (29 matched)
## Number of target objects: 86576 (47 matched)</code></pre>
<p>As a result we got a <code>MatchedSpectra</code> object that contains the query and target spectra as well as the matching result (i.e. the information which query spectrum matches with which target spectrum based on what similarity score). We can use the <code>query</code> and <code>target</code> functions to access the query and target <code>Spectra</code> objects and <code>matches</code> to extract the matching information. Below we display the first 6 rows of that matrix.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html">matches</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   query_idx target_idx     score
## 1       163      31941 0.9264249
## 2       163      32022 0.9264249
## 3       163      32214 0.9264249
## 4       163      32508 0.9264249
## 5       163      32667 0.9264249
## 6       163      32900 0.9264249</code></pre>
<p>Functions <code>whichQuery</code> and <code>whichTarget</code> return the (unique) indices of the query and target spectra that could be matched.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1]  163  320  420  433  493  496  497  571  682  685  686  805  806  809  810
## [16]  819  829  983 1095 1454 1457 1706 1830 1834 1839 1906 2047 2048 2050</code></pre>
<p>As we can see only few of the query spectra (29 of the 2451 spectra) could be matched. In part this is because a big proportion of the MassBank spectra have a missing precursor m/z and with <code>requirePrecursor = TRUE</code> they would not be considered in the similarity calculation. Setting <code>requirePrecursor = FALSE</code> would calculate a similarity between all spectra (even those with missing precursor information) but calculations can take up to several hours.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="fu">precursorMz</span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 24498</code></pre>
<p>The <code>MatchedSpectra</code> object inherits much of the functionality of a <code>Spectra</code> object. <code>spectraVariables</code> returns for example all the available <em>spectra variables</em>, from both the query as well as the target <code>Spectra</code>. The variable names of the latter are prefixed with <code>target_</code> to discriminate them from the variable names of the query.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                        "rtime"                         
##  [3] "acquisitionNum"                 "scanIndex"                     
##  [5] "dataStorage"                    "dataOrigin"                    
##  [7] "centroided"                     "smoothed"                      
##  [9] "polarity"                       "precScanNum"                   
## [11] "precursorMz"                    "precursorIntensity"            
## [13] "precursorCharge"                "collisionEnergy"               
## [15] "isolationWindowLowerMz"         "isolationWindowTargetMz"       
## [17] "isolationWindowUpperMz"         "peaksCount"                    
## [19] "totIonCurrent"                  "basePeakMZ"                    
## [21] "basePeakIntensity"              "ionisationEnergy"              
## [23] "lowMZ"                          "highMZ"                        
## [25] "mergedScan"                     "mergedResultScanNum"           
## [27] "mergedResultStartScanNum"       "mergedResultEndScanNum"        
## [29] "injectionTime"                  "filterString"                  
## [31] "spectrumId"                     "ionMobilityDriftTime"          
## [33] "scanWindowLowerLimit"           "scanWindowUpperLimit"          
## [35] "target_msLevel"                 "target_rtime"                  
## [37] "target_acquisitionNum"          "target_scanIndex"              
## [39] "target_dataStorage"             "target_dataOrigin"             
## [41] "target_centroided"              "target_smoothed"               
## [43] "target_polarity"                "target_precScanNum"            
## [45] "target_precursorMz"             "target_precursorIntensity"     
## [47] "target_precursorCharge"         "target_collisionEnergy"        
## [49] "target_isolationWindowLowerMz"  "target_isolationWindowTargetMz"
## [51] "target_isolationWindowUpperMz"  "target_spectrum_id"            
## [53] "target_spectrum_name"           "target_date"                   
## [55] "target_authors"                 "target_license"                
## [57] "target_copyright"               "target_publication"            
## [59] "target_splash"                  "target_compound_id"            
## [61] "target_adduct"                  "target_ionization"             
## [63] "target_ionization_voltage"      "target_fragmentation_mode"     
## [65] "target_collision_energy_text"   "target_instrument"             
## [67] "target_instrument_type"         "target_formula"                
## [69] "target_exactmass"               "target_smiles"                 
## [71] "target_inchi"                   "target_inchikey"               
## [73] "target_cas"                     "target_pubchem"                
## [75] "target_synonym"                 "target_precursor_mz_text"      
## [77] "target_compound_name"           "score"</code></pre>
<p>We can access spectra variables using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> and the variable name, or by passing the variable name(s) to the <code>spectraData</code> function. Below we thus extract the retention time the precursor m/z or the query spectrum, the precursor m/z of the target spectrum as well as the similarity score from the object.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraData</span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="st">"precursorMz"</span>, <span class="st">"target_precursorMz"</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 2500 rows and 4 columns
##          rtime precursorMz target_precursorMz     score
##      &lt;numeric&gt;   &lt;numeric&gt;          &lt;numeric&gt; &lt;numeric&gt;
## 1        7.216    137.9639                 NA        NA
## 2       13.146     56.9419                 NA        NA
## 3       13.556     89.9449                 NA        NA
## 4       23.085    207.0294                 NA        NA
## 5       27.385    121.0990                 NA        NA
## ...        ...         ...                ...       ...
## 2496   895.182    137.9850                 NA        NA
## 2497   895.472     56.0495                 NA        NA
## 2498   896.252    142.9611                 NA        NA
## 2499   896.662     53.0129                 NA        NA
## 2500   898.602     91.5022                 NA        NA</code></pre>
<p>The returned <code>DataFrame</code> contains the matching information for the full data set, i.e. of each query spectrum and hence, returns <code>NA</code> values for query spectra that could not be matched with a target spectrum. If we’re only interested in query spectra for which a match was found, we could simply subset the <code>MatchedSpectra</code> like below.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mtch</span> <span class="op">&lt;-</span> <span class="va">mtch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">mtch</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>Subsetting of <code>MatchedSpectra</code> is always relative to the query, i.e. subsetting an object with an index <code>4</code> would restrict the object to only the matching results for the 4th query spectrum. We now extract now the matching information after subsetting</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraData</span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="st">"precursorMz"</span>, <span class="st">"target_precursorMz"</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 78 rows and 4 columns
##         rtime precursorMz target_precursorMz     score
##     &lt;numeric&gt;   &lt;numeric&gt;          &lt;numeric&gt; &lt;numeric&gt;
## 1     173.184     305.156            305.157  0.926425
## 2     173.184     305.156            305.157  0.926425
## 3     173.184     305.156            305.157  0.926425
## 4     173.184     305.156            305.157  0.926425
## 5     173.184     305.156            305.157  0.926425
## ...       ...         ...                ...       ...
## 74    527.419     279.156            279.159  0.814331
## 75    527.419     279.156            279.159  0.822396
## 76    570.096     373.039            373.041  0.934031
## 77    570.506     373.042            373.041  0.888829
## 78    570.825     373.040            373.041  0.827892</code></pre>
<p>We can also return the compound names for the matching spectra.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html">pandoc.table</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"rmarkdown"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">spectraData</span><span class="op">(</span><span class="va">mtch</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rtime"</span>, <span class="st">"target_compound_name"</span>,
                                      <span class="st">"score"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center">rtime</th>
<th align="center">target_compound_name</th>
<th align="center">score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="even">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="odd">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="even">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="odd">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="even">
<td align="center">173.2</td>
<td align="center">Hexaethylene glycol</td>
<td align="center">0.9264</td>
</tr>
<tr class="odd">
<td align="center">266.4</td>
<td align="center">Triacetin</td>
<td align="center">0.8046</td>
</tr>
<tr class="even">
<td align="center">320</td>
<td align="center">SPI_270.2429_14.9</td>
<td align="center">0.9656</td>
</tr>
<tr class="odd">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.8067</td>
</tr>
<tr class="even">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.8225</td>
</tr>
<tr class="odd">
<td align="center">326.7</td>
<td align="center">Lenacil</td>
<td align="center">0.8205</td>
</tr>
<tr class="even">
<td align="center">338.5</td>
<td align="center">Azaconazole</td>
<td align="center">0.8943</td>
</tr>
<tr class="odd">
<td align="center">338.9</td>
<td align="center">Azaconazole</td>
<td align="center">0.8179</td>
</tr>
<tr class="even">
<td align="center">338.9</td>
<td align="center">Azaconazole</td>
<td align="center">0.905</td>
</tr>
<tr class="odd">
<td align="center">339.3</td>
<td align="center">Azaconazole</td>
<td align="center">0.9017</td>
</tr>
<tr class="even">
<td align="center">353.5</td>
<td align="center">Fosthiazate</td>
<td align="center">0.8962</td>
</tr>
<tr class="odd">
<td align="center">353.5</td>
<td align="center">Fosthiazate</td>
<td align="center">0.8689</td>
</tr>
<tr class="even">
<td align="center">361.7</td>
<td align="center">Azaconazole</td>
<td align="center">0.9002</td>
</tr>
<tr class="odd">
<td align="center">362.3</td>
<td align="center">Azaconazole</td>
<td align="center">0.8949</td>
</tr>
<tr class="even">
<td align="center">362.6</td>
<td align="center">Azaconazole</td>
<td align="center">0.8925</td>
</tr>
<tr class="odd">
<td align="center">377.7</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.9025</td>
</tr>
<tr class="even">
<td align="center">377.7</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8801</td>
</tr>
<tr class="odd">
<td align="center">377.7</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8563</td>
</tr>
<tr class="even">
<td align="center">378.1</td>
<td align="center">N,N-Dimethyldodecylamine</td>
<td align="center">0.8195</td>
</tr>
<tr class="odd">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8086</td>
</tr>
<tr class="even">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8623</td>
</tr>
<tr class="odd">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8447</td>
</tr>
<tr class="even">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8627</td>
</tr>
<tr class="odd">
<td align="center">378.9</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8391</td>
</tr>
<tr class="even">
<td align="center">379</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8081</td>
</tr>
<tr class="odd">
<td align="center">379</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8743</td>
</tr>
<tr class="even">
<td align="center">379</td>
<td align="center">triphenylphosphineoxide</td>
<td align="center">0.8491</td>
</tr>
<tr class="odd">
<td align="center">379</td>
<td align="center">Triphenylphosphine oxide</td>
<td align="center">0.8851</td>
</tr>
<tr class="even">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.844</td>
</tr>
<tr class="odd">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8923</td>
</tr>
<tr class="even">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8596</td>
</tr>
<tr class="odd">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8922</td>
</tr>
<tr class="even">
<td align="center">382</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8547</td>
</tr>
<tr class="odd">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8457</td>
</tr>
<tr class="even">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8966</td>
</tr>
<tr class="odd">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8625</td>
</tr>
<tr class="even">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8963</td>
</tr>
<tr class="odd">
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
<td align="center">0.8573</td>
</tr>
<tr class="even">
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
<td align="center">0.8145</td>
</tr>
<tr class="odd">
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
<td align="center">0.8357</td>
</tr>
<tr class="even">
<td align="center">405.1</td>
<td align="center">Cyproconazole (CP)</td>
<td align="center">0.8262</td>
</tr>
<tr class="odd">
<td align="center">414.6</td>
<td align="center">Tris(1-chloro-2-propyl)phosphate</td>
<td align="center">0.8613</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8464</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.9146</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8042</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.9388</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8483</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8517</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.865</td>
</tr>
<tr class="odd">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.863</td>
</tr>
<tr class="even">
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
<td align="center">0.8011</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9033</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9066</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.8807</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.8828</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9333</td>
</tr>
<tr class="even">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.9288</td>
</tr>
<tr class="odd">
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
<td align="center">0.8397</td>
</tr>
<tr class="even">
<td align="center">490.7</td>
<td align="center">Tri-isobutylphosphate</td>
<td align="center">0.8907</td>
</tr>
<tr class="odd">
<td align="center">490.7</td>
<td align="center">Tri-isobutyl phosphate</td>
<td align="center">0.8871</td>
</tr>
<tr class="even">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.848</td>
</tr>
<tr class="odd">
<td align="center">506.8</td>
<td align="center">Diflufenican</td>
<td align="center">0.8604</td>
</tr>
<tr class="even">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.8416</td>
</tr>
<tr class="odd">
<td align="center">507.3</td>
<td align="center">Diflufenican</td>
<td align="center">0.8524</td>
</tr>
<tr class="even">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.8591</td>
</tr>
<tr class="odd">
<td align="center">507.7</td>
<td align="center">Diflufenican</td>
<td align="center">0.8707</td>
</tr>
<tr class="even">
<td align="center">527.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.818</td>
</tr>
<tr class="odd">
<td align="center">527.4</td>
<td align="center">Dibutyl phthalate</td>
<td align="center">0.8847</td>
</tr>
<tr class="even">
<td align="center">527.4</td>
<td align="center">Di-n-butyl phthalate</td>
<td align="center">0.8143</td>
</tr>
<tr class="odd">
<td align="center">527.4</td>
<td align="center">Di-n-butyl phthalate</td>
<td align="center">0.8224</td>
</tr>
<tr class="even">
<td align="center">570.1</td>
<td align="center">Proquinazid</td>
<td align="center">0.934</td>
</tr>
<tr class="odd">
<td align="center">570.5</td>
<td align="center">Proquinazid</td>
<td align="center">0.8888</td>
</tr>
<tr class="even">
<td align="center">570.8</td>
<td align="center">Proquinazid</td>
<td align="center">0.8279</td>
</tr>
</tbody>
</table>
<p>The <code>matchSpectra</code> enables thus to perform convenient spectra matching between MS data represented as <code>Spectra</code> objects. As a result a <code>MatchedSpectra</code> object is returned that, in addition to the matching results, contains also the query and target spectra. Pre-filtering the spectra prior the actual spectra similarity calculation can reduce the running time of a <code>matchSpectra</code> call but might also miss some potential matches. Note that in addition to the precursor m/z-based pre-filter also retention time pre-filtering would be available (see <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html">?matchSpectra</a></code> for more information). Also, a more advanced matching approach would be available with the <code>MatchForwardReverseParam</code> that calculates in addition to the <em>forward score</em> also a <em>reverse similarity</em> for each match.</p>
</div>
<div id="ms2-spectra-matching-in-an-xcms-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#ms2-spectra-matching-in-an-xcms-workflow" class="anchor"></a>MS2 spectra matching in an <code>xcms</code> workflow</h2>
<p>In LC-MS/MS-based untargeted metabolomics (or small compound mass spectrometry experiments in general) quantification of the compounds is performed in MS1 while the MS2 data is used for identification of the features. Quantification of MS1 data requires a chromatographic peak detection step which is most frequently performed using the functionality from the <em><a href="https://bioconductor.org/packages/3.14/xcms">xcms</a></em> package. Below we load thus the <code>xcms</code> package and read the data using the <code>readMSData</code> function.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sneumann/xcms">xcms</a></span><span class="op">)</span>
<span class="va">pest_all</span> <span class="op">&lt;-</span> <span class="fu">readMSData</span><span class="op">(</span><span class="va">fl</span>, mode <span class="op">=</span> <span class="st">"onDisk"</span><span class="op">)</span></code></pre></div>
<p>We next perform the chromatographic peak detection using the <em>centWave</em> algorithm (see the <em>LC-MS/MS data analysis with xcms</em> vignette from the <code>xcms</code> package for details about chromatographic peak detection related settings).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cwp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks-centWave.html">CentWaveParam</a></span><span class="op">(</span>snthresh <span class="op">=</span> <span class="fl">5</span>, noise <span class="op">=</span> <span class="fl">100</span>, ppm <span class="op">=</span> <span class="fl">10</span>,
                     peakwidth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span>
<span class="va">pest_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/chromatographic-peak-detection.html">findChromPeaks</a></span><span class="op">(</span><span class="va">pest_all</span>, param <span class="op">=</span> <span class="va">cwp</span><span class="op">)</span></code></pre></div>
<p>In total 99 chromatographic peaks have been identified. Below we display the first 6 of them.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">pest_all</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            mz    mzmin    mzmax      rt   rtmin   rtmax       into      intb
## CP01 142.9926 142.9921 142.9931 130.615 125.856 134.241  1113.8028  1106.229
## CP02 221.0918 221.0906 221.0925 240.897 236.657 246.984   756.6935   744.779
## CP03 220.0985 220.0978 220.0988 240.897 237.187 246.327  2060.5921  2052.549
## CP04 219.0957 219.0950 219.0962 241.018 236.253 246.327 15172.6662 15133.811
## CP05 153.0659 153.0655 153.0663 330.591 325.373 334.400  2148.7134  2141.943
## CP06 235.1447 235.1441 235.1454 330.591 326.431 334.400  2836.2675  2829.627
##           maxo  sn sample
## CP01  346.7006 102      1
## CP02  212.5239  21      1
## CP03  585.3036 151      1
## CP04 4877.1162 367      1
## CP05  784.9196 114      1
## CP06 1006.9720 110      1</code></pre>
<p>We can now extract all MS2 spectra for each chromatographic peak with the <code>chromPeakSpectra</code> function. By setting <code>return.type = "Spectra"</code> we ensure the data to be returned in the newer <code>Spectra</code> format hence enabling the simplified spectra matching with the functionality presented here.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/chromPeakSpectra.html">chromPeakSpectra</a></span><span class="op">(</span><span class="va">pest_all</span>, return.type <span class="op">=</span> <span class="st">"Spectra"</span><span class="op">)</span>
<span class="va">pest_ms2</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 158 spectra in a MsBackendMzR backend:
##            msLevel     rtime scanIndex
##          &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## F1.S1000         2   128.237      1000
## F1.S1008         2   128.737      1008
## F1.S1023         2   129.857      1023
## F1.S1812         2   237.869      1812
## F1.S1846         2   241.299      1846
## ...            ...       ...       ...
## F1.S5115         2   575.255      5115
## F1.S5272         2   596.584      5272
## F1.S5236         2   592.424      5236
## F1.S5266         2   596.054      5266
## F1.S7344         2   873.714      7344
##  ... 38 more variables/columns.
## 
## file(s):
## PestMix1_DDA.mzML</code></pre>
<p>Spectra variable <code>peak_id</code> contains the identified of the chromatographic peak (i.e. its row name in <code>chromPeaks</code>).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pest_ms2</span><span class="op">$</span><span class="va">peak_id</span></code></pre></div>
<pre><code>##   [1] "CP01" "CP01" "CP01" "CP04" "CP04" "CP05" "CP05" "CP06" "CP06" "CP08"
##  [11] "CP08" "CP11" "CP11" "CP12" "CP12" "CP13" "CP13" "CP13" "CP13" "CP14"
##  [21] "CP14" "CP14" "CP14" "CP18" "CP22" "CP22" "CP22" "CP22" "CP22" "CP25"
##  [31] "CP25" "CP25" "CP25" "CP25" "CP26" "CP26" "CP26" "CP26" "CP26" "CP26"
##  [41] "CP33" "CP33" "CP34" "CP34" "CP34" "CP34" "CP34" "CP35" "CP35" "CP35"
##  [51] "CP35" "CP35" "CP36" "CP41" "CP41" "CP41" "CP42" "CP42" "CP42" "CP42"
##  [61] "CP42" "CP44" "CP44" "CP46" "CP46" "CP46" "CP46" "CP47" "CP47" "CP47"
##  [71] "CP48" "CP48" "CP48" "CP50" "CP51" "CP51" "CP51" "CP52" "CP52" "CP52"
##  [81] "CP53" "CP53" "CP53" "CP53" "CP53" "CP57" "CP57" "CP57" "CP57" "CP57"
##  [91] "CP59" "CP59" "CP60" "CP60" "CP61" "CP61" "CP63" "CP63" "CP63" "CP63"
## [101] "CP64" "CP64" "CP64" "CP64" "CP64" "CP65" "CP66" "CP66" "CP66" "CP66"
## [111] "CP67" "CP67" "CP67" "CP69" "CP69" "CP69" "CP71" "CP71" "CP71" "CP71"
## [121] "CP72" "CP72" "CP72" "CP73" "CP81" "CP81" "CP81" "CP81" "CP82" "CP82"
## [131] "CP82" "CP85" "CP85" "CP88" "CP88" "CP89" "CP89" "CP89" "CP90" "CP90"
## [141] "CP90" "CP91" "CP91" "CP91" "CP93" "CP93" "CP93" "CP93" "CP93" "CP93"
## [151] "CP94" "CP94" "CP94" "CP94" "CP95" "CP98" "CP98" "CP99"</code></pre>
<p>We next, like in the previous section, <em>clean up</em> the spectra removing peaks with an intensity below 5% of the largest peak intensity per spectrum and removing spectra with a single peak.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Remove peaks with an intensity below 5%</span>
<span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu">filterIntensity</span><span class="op">(</span><span class="va">pest_ms2</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span>

<span class="co">#' Remove peaks with a single peak</span>
<span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="va">pest_ms2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></code></pre></div>
<p>In addition we scale also the intensities within each MS2 spectrum by replacing them with intensities relative to the maximum peak intensity (see <a href="https://jorainer.github.io/SpectraTutorials/articles/analyzing-MS-data-from-different-sources-with-Spectra.html#data-processing-and-manipulation-1">here</a> for more information). In addition to the query spectra, we also <em>normalize</em> the MassBank spectra in the same way.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Define a function to *normalize* the intensities</span>
<span class="va">norm_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">maxint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="va">maxint</span>
    <span class="va">x</span>
<span class="op">}</span>
<span class="co">#' *Apply* the function to the data</span>
<span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">addProcessing</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">norm_int</span><span class="op">)</span>
<span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">addProcessing</a></span><span class="op">(</span><span class="va">mbank</span>, <span class="va">norm_int</span><span class="op">)</span></code></pre></div>
<p>Next we perform now the spectra matching with the same parameters as in the previous section.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pest_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">mbank</span>, param <span class="op">=</span> <span class="va">prm</span><span class="op">)</span>
<span class="va">pest_match</span></code></pre></div>
<pre><code>## Object of class MatchedSpectra 
## Total number of matches: 31 
## Number of query objects: 155 (7 matched)
## Number of target objects: 86576 (19 matched)</code></pre>
<p>Again, we restrict the <code>MatchedSpectra</code> to query spectra which could be matched.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pest_match</span> <span class="op">&lt;-</span> <span class="va">pest_match</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">pest_match</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>The table below lists the compound names of matching spectra for the chromatographic peaks.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html">pandoc.table</a></span><span class="op">(</span>
    style <span class="op">=</span> <span class="st">"rmarkdown"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">spectraData</span><span class="op">(</span><span class="va">pest_match</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"peak_id"</span>, <span class="st">"rtime"</span>,
                                            <span class="st">"target_compound_name"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center"> </th>
<th align="center">peak_id</th>
<th align="center">rtime</th>
<th align="center">target_compound_name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>F1.S2860</strong></td>
<td align="center">CP18</td>
<td align="center">362.6</td>
<td align="center">Azaconazole</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3061</strong></td>
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3061.1</strong></td>
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3061.2</strong></td>
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3061.3</strong></td>
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3061.4</strong></td>
<td align="center">CP25</td>
<td align="center">382</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3080</strong></td>
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3080.1</strong></td>
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3080.2</strong></td>
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3080.3</strong></td>
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3080.4</strong></td>
<td align="center">CP25</td>
<td align="center">384.5</td>
<td align="center">Dimethachlor</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3314</strong></td>
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3314.1</strong></td>
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3314.2</strong></td>
<td align="center">CP42</td>
<td align="center">405.1</td>
<td align="center">Cyproconazole (CP)</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3968</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3968.1</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3968.2</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3968.3</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3968.4</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3968.5</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3968.6</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3968.7</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3968.8</strong></td>
<td align="center">CP67</td>
<td align="center">452.9</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3972</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3972.1</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3972.2</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3972.3</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3972.4</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S3972.5</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="even">
<td align="center"><strong>F1.S3972.6</strong></td>
<td align="center">CP67</td>
<td align="center">453.3</td>
<td align="center">Flufenacet</td>
</tr>
<tr class="odd">
<td align="center"><strong>F1.S5077</strong></td>
<td align="center">CP94</td>
<td align="center">570.5</td>
<td align="center">Proquinazid</td>
</tr>
</tbody>
</table>
<p>We can also directly plot matching (query and target) spectra against each other using the <code>plotSpectraMirror</code> function subsetting the <code>MatchedSpectra</code> object to the query spectrum of interest. Below we plot the third query spectrum against all of its matching target spectra.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">pest_match</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra-matching-with-MetaboAnnotation_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>Summarizing, with the <code>chromPeakSpectra</code> and the <code>featureSpectra</code> functions, <code>xcms</code> allows to return MS data as <code>Spectra</code> objects which enables, as shown in this simple example, to perform MS2 spectra matching using the <code>Spectra</code> as well as the <code>MetaboAnnotation</code> packages hence simplifying MS/MS-based annotation of LC-MS features from <code>xcms</code>.</p>
</div>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.1.1 (2021-08-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.3 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] xcms_3.15.3             MSnbase_2.19.2          mzR_2.27.1             
##  [4] Rcpp_1.0.7              Biobase_2.53.0          MetaboAnnotation_0.2.11
##  [7] MsBackendMassbank_1.1.3 RMariaDB_1.1.2          pander_0.6.4           
## [10] Spectra_1.3.10          ProtGenerics_1.25.1     BiocParallel_1.27.12   
## [13] S4Vectors_0.31.5        BiocGenerics_0.39.2     BiocStyle_2.21.3       
## 
## loaded via a namespace (and not attached):
##  [1] bitops_1.0-7                matrixStats_0.61.0         
##  [3] fs_1.5.0                    lubridate_1.7.10           
##  [5] bit64_4.0.5                 RColorBrewer_1.1-2         
##  [7] doParallel_1.0.16           rprojroot_2.0.2            
##  [9] GenomeInfoDb_1.29.8         tools_4.1.1                
## [11] affyio_1.63.2               utf8_1.2.2                 
## [13] R6_2.5.1                    DBI_1.1.1                  
## [15] colorspace_2.0-2            tidyselect_1.1.1           
## [17] MassSpecWavelet_1.59.0      preprocessCore_1.55.2      
## [19] bit_4.0.4                   compiler_4.1.1             
## [21] textshaping_0.3.5           desc_1.4.0                 
## [23] DelayedArray_0.19.4         scales_1.1.1               
## [25] DEoptimR_1.0-9              robustbase_0.93-9          
## [27] affy_1.71.0                 pkgdown_1.6.1              
## [29] systemfonts_1.0.2           stringr_1.4.0              
## [31] digest_0.6.28               rmarkdown_2.11             
## [33] XVector_0.33.0              pkgconfig_2.0.3            
## [35] htmltools_0.5.2             MetaboCoreUtils_1.1.1      
## [37] MatrixGenerics_1.5.4        highr_0.9                  
## [39] limma_3.49.4                fastmap_1.1.0              
## [41] rlang_0.4.11                impute_1.67.0              
## [43] jquerylib_0.1.4             generics_0.1.0             
## [45] mzID_1.31.0                 dplyr_1.0.7                
## [47] RCurl_1.98-1.5              magrittr_2.0.1             
## [49] GenomeInfoDbData_1.2.7      MALDIquant_1.20            
## [51] Matrix_1.3-4                munsell_0.5.0              
## [53] fansi_0.5.0                 MsCoreUtils_1.5.0          
## [55] lifecycle_1.0.1             vsn_3.61.2                 
## [57] stringi_1.7.5               yaml_2.2.1                 
## [59] MASS_7.3-54                 SummarizedExperiment_1.23.4
## [61] zlibbioc_1.39.0             plyr_1.8.6                 
## [63] grid_4.1.1                  parallel_4.1.1             
## [65] crayon_1.4.1                lattice_0.20-45            
## [67] MsFeatures_1.1.0            hms_1.1.1                  
## [69] knitr_1.36                  pillar_1.6.3               
## [71] GenomicRanges_1.45.0        codetools_0.2-18           
## [73] XML_3.99-0.8                glue_1.4.2                 
## [75] evaluate_0.14               pcaMethods_1.85.0          
## [77] BiocManager_1.30.16         foreach_1.5.1              
## [79] vctrs_0.3.8                 RANN_2.6.1                 
## [81] gtable_0.3.0                purrr_0.3.4                
## [83] clue_0.3-59                 cachem_1.0.6               
## [85] ggplot2_3.3.5               xfun_0.26                  
## [87] ragg_1.1.3                  ncdf4_1.17                 
## [89] tibble_3.1.5                iterators_1.0.13           
## [91] memoise_2.0.0               IRanges_2.27.2             
## [93] cluster_2.1.2               ellipsis_0.3.2</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
