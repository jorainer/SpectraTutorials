<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EuroBioC2020: Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package • SpectraTutorials</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="EuroBioC2020: Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package">
<meta property="og:description" content="SpectraTutorials">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpectraTutorials</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/EuroBioc2020-Spectra-backends.html">EuroBioC2020: Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    </li>
    <li>
      <a href="../articles/analyzing-MS-data-from-different-sources-with-Spectra.html">Seamless Integration of Mass Spectrometry Data from Different Sources with the `Spectra` Package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jorainer/SpectraTutorials">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="EuroBioc2020-Spectra-backends_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>EuroBioC2020: Seamless Integration of Mass Spectrometry Data from Different Sources with the <code>Spectra</code> Package</h1>
                        <h4 class="author">Johannes Rainer<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, Michael Witting<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, Sebastian Gibb<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>, Laurent Gatto<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jorainer/SpectraTutorials/blob/master/vignettes/EuroBioc2020-Spectra-backends.Rmd"><code>vignettes/EuroBioc2020-Spectra-backends.Rmd</code></a></small>
      <div class="hidden name"><code>EuroBioc2020-Spectra-backends.Rmd</code></div>

    </div>

    
    
<p><strong>Last modified:</strong> 2020-12-09 15:37:36<br><strong>Compiled</strong>: Wed Dec 9 15:45:25 2020</p>
<p>Note: this document is used for the online workshop. A version with more descriptive text is available <a href="analyzing-MS-data-from-different-sources-with-Spectra.Rmd">here</a>.</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<ul>
<li>Describe the concept of <em>backends</em> to store/represent mass spectrometry (MS) data in the <code>Spectra</code> package.</li>
<li>Use case: match experimental MS2 spectra against <em>reference</em> spectra from a public spectra database:
<ul>
<li>import MS data from <em>mzML</em> files</li>
<li>perform some data manipulations on this data</li>
<li>match spectra against the <a href="https://massbank.eu/MassBank/">MassBank</a>
</li>
<li>export spectra in <em>MGF</em> format.</li>
</ul>
</li>
</ul>
</div>
<div id="lc-msms-in-a-nutshell" class="section level1">
<h1 class="hasAnchor">
<a href="#lc-msms-in-a-nutshell" class="anchor"></a>LC-MS/MS in a nutshell</h1>
<div class="figure">
<img src="LC-MS-drawing.gif" alt=""><p class="caption">LC-MS setup</p>
</div>
<ul>
<li><p>Mass spectrometry (MS) instruments measure mass-to-charge ratios (m/z) of ions.</p></li>
<li><p>Most compounds are not charged, they need to be ionized first (with e.g. electro spray ionization (ESI).</p></li>
<li><p>MS is usually combined with another separation technique, such as liquid chromatography (LC). This adds another dimension: retention time (rt).</p></li>
<li><p>With LC-MS we measure <em>features</em> characterized by m/z and retention time - we still don’t know what molecule was actually measured.</p></li>
<li><p>Create in addition fragment (MS/MS) spectra from the ions to get some information about their structure.</p></li>
</ul>
<div class="figure">
<img src="MSMS.png" alt=""><p class="caption">CID-based fragmentation</p>
</div>
<ul>
<li>Commonly used method: collision induced dissociation (CID). In a collision chamber filled with e.g. N2, ions get fragmented, a spectrum of these fragments is recorded.</li>
<li>Matching fragment spectra from an ion against a <em>reference</em> helps identifying the compound.</li>
</ul>
</div>
<div id="analysing-ms-data-with-spectra" class="section level1">
<h1 class="hasAnchor">
<a href="#analysing-ms-data-with-spectra" class="anchor"></a>Analysing MS data with <code>Spectra</code>
</h1>
<ul>
<li><p>The <code>Spectra</code> package implements a clear separation of user functionality from code to provide, store and read mass spectrometry data.</p></li>
<li><p>This represents an extension to the <em>in-memory</em> and <em>on-disk</em> data modes already in the <em><a href="https://bioconductor.org/packages/3.13/MSnbase">MSnbase</a></em> <span class="citation">(Gatto, Gibb, and Rainer 2020)</span>.</p></li>
</ul>
<div class="figure">
<img src="Spectra.png" alt=""><p class="caption">Spectra: separation into user functionality and data representation</p>
</div>
<ul>
<li><p>Enables analysis of very large MS data sets: backends that import the data only on demand.</p></li>
<li><p>Below we import the MS data from mzML files containing MSn data of a mix of 8 standard compounds.</p></li>
<li><p>MS2 data was generated by data dependent acquisition using two different collision energies.</p></li>
<li><p>We use the <code>MsBackendMzR</code> backend which supports data import from most common <em>raw</em> MS file formats:</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"mzML"</span>, package <span class="op">=</span> <span class="st">"SpectraTutorials"</span><span class="op">)</span>,
           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<ul>
<li><p><code>sps_all</code> is now a <code>Spectra</code> object: <code>data.frame</code>-like representation with columns being spectra variables and rows individual spectra.</p></li>
<li><p>Spectra variables can be accessed <em>via</em> <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> or using the dedicates access function (preferred way).</p></li>
<li><p>Use <code>spectraVariables</code> to list all available spectra variables:</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                  "rtime"                   
##  [3] "acquisitionNum"           "scanIndex"               
##  [5] "dataStorage"              "dataOrigin"              
##  [7] "centroided"               "smoothed"                
##  [9] "polarity"                 "precScanNum"             
## [11] "precursorMz"              "precursorIntensity"      
## [13] "precursorCharge"          "collisionEnergy"         
## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" 
## [17] "isolationWindowUpperMz"   "peaksCount"              
## [19] "totIonCurrent"            "basePeakMZ"              
## [21] "basePeakIntensity"        "ionisationEnergy"        
## [23] "lowMZ"                    "highMZ"                  
## [25] "mergedScan"               "mergedResultScanNum"     
## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  
## [29] "injectionTime"            "filterString"            
## [31] "spectrumId"               "ionMobilityDriftTime"    
## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"</code></pre>
<ul>
<li>Access retention times of the first spectra:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">$</span><span class="va">rtime</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">rtime</span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.273 0.570 0.873 1.183 1.491 1.798</code></pre>
<ul>
<li><p>Our <code>Spectra</code> object uses a <code>MsBackendMzR</code> backend to provide the data.</p></li>
<li><p>Only general spectra information is kept in memory, MS peak data is retrieved on demand from the original data files. This ensures a small memory footprint.</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 0.8 Mb</code></pre>
<ul>
<li><p><code>MsBackendDataFrame</code> backend keeps all data in memory.</p></li>
<li><p><code>setBackend</code> allows to change backends - which does not affect the way we can use/work with the data.</p></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">setBackend</a></span><span class="op">(</span><span class="va">sps_all</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_all</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 35.9 Mb</code></pre>
<ul>
<li>Next we subset our data to MS2 spectra with a precursor ion that matches the m/z of the [M+H]+ ion of the metabolite Cystine.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fl">241.0311</span>

<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu">filterPrecursorMz</span><span class="op">(</span><span class="va">sps_all</span>, mz <span class="op">=</span> <span class="va">mz</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">ppm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">mz</span>, <span class="va">mz</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 11 spectra in a MsBackendDataFrame backend:
##      msLevel     rtime scanIndex
##    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1          2   209.936       673
## 2          2   220.072       714
## 3          2   231.604       734
## 4          2   211.481       687
## 5          2   224.634       718
## 6          2   236.326       731
## 7          2   215.089       761
## 8          2   225.739       781
## 9          2   240.020       804
## 10         2   212.161       771
## 11         2   224.662       801
##  ... 33 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendDataFrame [Wed Dec  9 15:45:31 2020]
##  Filter: select spectra with a precursor m/z within [241.028689689, 241.033510311] [Wed Dec  9 15:45:31 2020]</code></pre>
<ul>
<li>In total 11 spectra matched our target precursor m/z.</li>
</ul>
<div id="data-processing-and-manipulation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-processing-and-manipulation" class="anchor"></a>Data processing and manipulation</h2>
<ul>
<li>The <code>plotSpectra</code> function can be used to visualize spectra.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="EuroBioc2020-Spectra-backends_files/figure-html/raw-ms2-1.png" width="672"></p>
<ul>
<li><p>Many very low abundance peaks present (noise?).</p></li>
<li><p>Filter the spectra removing all peaks with intensity below 5% of maximum peak.</p></li>
<li><p>Filter function: takes intensity values from each spectrum and returns <code>logical</code> whether a peak should be kept or not.</p></li>
<li><p>Use <code>filterIntensity</code> to apply this function to the data.</p></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">low_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.05</span>
<span class="op">}</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">filterIntensity</a></span><span class="op">(</span><span class="va">sps</span>, intensity <span class="op">=</span> <span class="va">low_int</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="EuroBioc2020-Spectra-backends_files/figure-html/filter-intensity-1.png" width="672"></p>
<ul>
<li><p>Low intensity peaks removed.</p></li>
<li><p>Next: <em>normalize</em> each spectrum to get intensities relative to the maximum peak intensity (set to a value of <code>100</code>).</p></li>
<li><p>Define a function that takes the peak matrix, normalizes the intensities and returns the modifier peak matrix.</p></li>
<li><p>Use <code>addProcessing</code> to apply the normalization. <code>addProcessing</code> can be used to apply any user provided function to the peak matrices.</p></li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">norm_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">maxint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="va">maxint</span>
    <span class="va">x</span>
<span class="op">}</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">addProcessing</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">norm_int</span><span class="op">)</span></code></pre></div>
<ul>
<li>Get the normalized intensities of the first spectrum:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>## [1]  13.439402  93.631648  49.287979 100.000000   9.422415   6.581111  12.969807
## [8]  54.633224</code></pre>
<ul>
<li><p><strong>Note</strong>: data manipulation operations are <strong>not</strong> applied to the actual MS data, but cached in the <em>lazy evaluation queue</em> of the <code>Spectra</code> object.</p></li>
<li><p>Data manipulation are applied <em>on-the-fly</em> each time m/z or intensity values are accessed. This enables the use of <em>read-only</em> data representations (e.g. raw data files, databases, …).</p></li>
<li><p>This mechanism enables us also to <em>undo</em> cached data manipulations with the <code>reset</code> function:</p></li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">reset</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_orig</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  10 163  41  20  31 210</code></pre>
</div>
<div id="spectrum-data-comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#spectrum-data-comparison" class="anchor"></a>Spectrum data comparison</h2>
<ul>
<li><p>Next we perform a pairwise comparison of the spectra.</p></li>
<li>
<p>Spectra comparison involves:</p>
<ul>
<li>matching of peaks from the compared spectra</li>
<li>similarity calculation based on intensities of the matched peaks.</li>
</ul>
</li>
<li><p>With <code>ppm = 20</code> peaks with a difference in m/z smaller than 20ppm are considered matching.</p></li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
<ul>
<li><p><code>compareSpectra</code> allows to specify a mapping function with <code>MAPFUN</code> (defaults to <code>joinPeaks</code> and a similarity calculation function with <code>FUN</code> (defaults to <code>ndotproduct</code>).</p></li>
<li><p>The pairwise spectra similarities are represented with the heatmap below.</p></li>
</ul>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>
<span class="va">hm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span><span class="va">cormat</span>, cutree_rows <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p><img src="EuroBioc2020-Spectra-backends_files/figure-html/ms2-heatmap-1.png" width="672"></p>
<ul>
<li><p>The 11 spectra group into 3 clusters related to the collision energy used for the fragmentation.</p></li>
<li><p>We reduce our dataset to the cluster with the spectra generated with a collision energy of 20eV.</p></li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hm</span><span class="op">$</span><span class="va">tree_row</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## $`1`
## [1] "HighIS_Mix06_CE20_POS.mzML"    "HighIS_Mix06_CE20_POS.mzML"   
## [3] "HighIS_Mix06_CE20_POS.mzML"    "QC_HighIS_Mix06_CE20_POS.mzML"
## [5] "QC_HighIS_Mix06_CE20_POS.mzML" "QC_HighIS_Mix06_CE20_POS.mzML"
## 
## $`2`
## [1] "HighIS_Mix06_CE30_POS.mzML"    "HighIS_Mix06_CE30_POS.mzML"   
## [3] "QC_HighIS_Mix06_CE30_POS.mzML"
## 
## $`3`
## [1] "HighIS_Mix06_CE30_POS.mzML"    "QC_HighIS_Mix06_CE30_POS.mzML"</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_ce20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hm</span><span class="op">$</span><span class="va">tree_row</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<div id="matching-against-massbank" class="section level3">
<h3 class="hasAnchor">
<a href="#matching-against-massbank" class="anchor"></a>Matching against MassBank</h3>
<ul>
<li><p>Although the precursor m/z matches the m/z of Cystine, we can not exclude that they might not be from another ion/compound.</p></li>
<li><p>First step of annotation process: matching experimental spectra against public (or in-house) spectral library.</p></li>
<li>
<p>Many public spectral libraries for small molecules exist:</p>
<ul>
<li><a href="https://massbank.eu/MassBank/">MassBank</a></li>
<li>MassBank of North America <a href="https://mona.fiehnlab.ucdavis.edu/">MoNa</a>
</li>
<li>Human Metabolom Database <a href="https://hmdb.ca/">HMDB</a>
</li>
<li><a href="https://gnps.ucsd.edu/ProteoSAFe/static/gnps-splash.jsp">GNPS</a></li>
<li>…</li>
</ul>
</li>
<li><p>Data access to these resources is not standardized.</p></li>
<li>
<p><a href="https://github.com/michaelwitting/MsBackendMassbank"><code>MsBackendMassbank</code></a> package: <code>Spectra</code> backends for MassBank data:</p>
<ul>
<li>
<code>MsBackendMassbank</code>: data import/export from/to files in MassBank format.</li>
<li>
<code>MsBackendMassbankSql</code>: direct access to MassBank database.</li>
</ul>
</li>
<li><p>Below we load the <code>MsBackendMassbank</code> package and connect to a local installation of the MassBank MySQL database (release <em>2020.11</em>, provided within the docker image).</p></li>
</ul>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org">RMariaDB</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/michaelwitting/MsBackendMassbank">MsBackendMassbank</a></span><span class="op">)</span>

<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, user <span class="op">=</span> <span class="st">"massbank"</span>, dbname <span class="op">=</span> <span class="st">"MassBank"</span>,
                 host <span class="op">=</span> <span class="st">"localhost"</span><span class="op">)</span></code></pre></div>
<ul>
<li>Create a <code>Spectra</code> object with a <code>MsBackendMassbankSql</code> backend to access all the data in MassBank.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html">MsBackendMassbankSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">mbank</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 88168 spectra in a MsBackendMassbankSql backend:
##      msLevel precursorMz  polarity
##    &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;
## 1          2      269.11         1
## 2          2      242.08         0
## 3          2      119.09         1
## 4          2      330.06         1
## 5         NA          NA         1
## 6         NA          NA         1
## 7          2      584.42         1
## 8          2      380.24         1
## 9          2      584.42         1
## 10         2      568.00         1
##  ... 33 more variables/columns.
##  Use  'spectraVariables' to list all of them.</code></pre>
<ul>
<li>
<code>mbank</code> does only contain the primary keys of spectra from the database, memory size is thus (relatively) small.</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">mbank</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></code></pre></div>
<pre><code>## 6.1 Mb</code></pre>
<ul>
<li><p>Any operation on this <code>Spectra</code> object will load the requested data from the database on-the-fly.</p></li>
<li><p>Before matching we subset <code>mbank</code> to spectra with a peak matching the precursor m/z.</p></li>
</ul>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">has_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">containsMz</a></span><span class="op">(</span><span class="va">mbank</span>, mz <span class="op">=</span> <span class="va">mz</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
<ul>
<li><p>Note that, to improve performance, we could also load all the spectra data into memory by changing the backend with <code>setBackend</code> to a <code>MsBackendDataFrame</code>.</p></li>
<li><p>Calculate spectral similarity between experimental spectra and the 217 spectra from MassBank.</p></li>
</ul>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mbank_with_mz</span> <span class="op">&lt;-</span> <span class="va">mbank</span><span class="op">[</span><span class="va">has_mz</span><span class="op">]</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps_ce20</span>, <span class="va">mbank_with_mz</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.9236822</code></pre>
<ul>
<li>Below we indentify the best matching spectrum and access its intensity values.</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">intensity</span><span class="op">(</span><span class="va">mbank_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 1
## [["PB000446"]] 50.369 88.328 45.922 37.428 ... 950.368 69.414 130.733 2338.193</code></pre>
<ul>
<li><p>MassBank reports absolute intensities, for better visualization we need to <em>normalize</em> them the same way we did with our data.</p></li>
<li><p>We can not change the data in MassBank, but <code>Spectra</code>’s <em>lazy evaluation queue</em> allows us to apply data manipulations.</p></li>
</ul>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mbank_with_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">addProcessing</a></span><span class="op">(</span><span class="va">mbank_with_mz</span>, <span class="va">norm_int</span><span class="op">)</span></code></pre></div>
<ul>
<li>Compare the best matching spectra with a <em>mirror plot</em>.</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Specifying a function to draw peak labels</span>
<span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu">mz</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps_ce20</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">mbank_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span>,
                  labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.2</span>,
                  labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="EuroBioc2020-Spectra-backends_files/figure-html/massbank-mirror-plot-1.png" width="672"></p>
<ul>
<li><p>Nice match between experimental and <em>reference</em> spectrum.</p></li>
<li><p>Next we want to know from which compound the <em>reference</em> spectrum was created.</p></li>
</ul>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">mbank_with_mz</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "spectrum_id"            
## [19] "spectrum_name"           "date"                   
## [21] "authors"                 "license"                
## [23] "copyright"               "publication"            
## [25] "splash"                  "compound_id"            
## [27] "adduct"                  "ionization"             
## [29] "ionization_voltage"      "fragmentation_mode"     
## [31] "collision_energy_text"   "instrument"             
## [33] "instrument_type"         "precursor_mz_text"</code></pre>
<ul>
<li><p>Various information on spectra available, but not on the actual compound.</p></li>
<li><p><code>MsBackendMassbank</code> provides method <code>compounds</code> that allows to retrieve compound annotations from a MassBank database.</p></li>
<li><p>Subset the MassBank <code>Spectra</code> to the best matching spectrum and retrieve annotation.</p></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mbank_best_match</span> <span class="op">&lt;-</span> <span class="va">mbank_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="va">mbank_cmpd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbankSql.html">compounds</a></span><span class="op">(</span><span class="va">mbank_best_match</span><span class="op">)</span>
<span class="va">mbank_cmpd</span></code></pre></div>
<pre><code>## DataFrame with 1 row and 10 columns
##   compound_id     formula exactmass                 smiles
##     &lt;integer&gt; &lt;character&gt; &lt;numeric&gt;            &lt;character&gt;
## 1       48048 C6H12N2O4S2   240.024 C(C(C(=O)O)N)SSCC(C(..
##                    inchi               inchikey         cas     pubchem
##              &lt;character&gt;            &lt;character&gt; &lt;character&gt; &lt;character&gt;
## 1 InChI=1S/C6H12N2O4S2.. LEVWYRKDKASIDU-UHFFF..          NA     CID:595
##                          synonym        name
##                  &lt;CharacterList&gt; &lt;character&gt;
## 1 Cystine,2-amino-3-(2-amino-3..     Cystine</code></pre>
<ul>
<li><p>Best matching spectrum is in fact a MS2 spectrum of Cystine.</p></li>
<li><p>Add additional annotations to the experimental spectra (name, chemical formula and collision energy).</p></li>
</ul>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_ce20</span><span class="op">$</span><span class="va">hmdb_id</span> <span class="op">&lt;-</span> <span class="va">mbank_cmpd</span><span class="op">$</span><span class="va">name</span>
<span class="va">sps_ce20</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">mbank_cmpd</span><span class="op">$</span><span class="va">formula</span>
<span class="va">sps_ce20</span><span class="op">$</span><span class="va">adduct</span> <span class="op">&lt;-</span> <span class="va">mbank_best_match</span><span class="op">$</span><span class="va">adduct</span>
<span class="va">sps_ce20</span><span class="op">$</span><span class="va">collisionEnergy</span> <span class="op">&lt;-</span> <span class="fl">20</span></code></pre></div>
<ul>
<li>Note: adding additional annotations should be possible regardless of the used backend.</li>
</ul>
</div>
</div>
<div id="data-export" class="section level2">
<h2 class="hasAnchor">
<a href="#data-export" class="anchor"></a>Data export</h2>
<ul>
<li><p>At last we want to export our spectra to a file in MGF format.</p></li>
<li><p><a href="https://github.com/RforMassSpectrometry/MsBackendMgf"><code>MsBackendMgf</code></a> package: adds support for MGF file import/export.</p></li>
<li><p>Export the data with the <code>export</code> function, define the output format with the <code>backend</code> parameter.</p></li>
</ul>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf">MsBackendMgf</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">export</a></span><span class="op">(</span><span class="va">sps_ce20</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"Cystine_ce20.mgf"</span><span class="op">)</span></code></pre></div>
</div>
<div id="matching-against-hmdb" class="section level2">
<h2 class="hasAnchor">
<a href="#matching-against-hmdb" class="anchor"></a>Matching against HMDB</h2>
<p>In addition to the <code>MsBackendMassbank</code>, which provides access to MassBank data, there is also the <a href="https://github.com/RforMassSpectrometry/MsBackendHmdb"><code>MsBackendHmdb</code></a> package supporting spectral data from the public Human Metabolome Database (HMDB). This package does however not yet provide direct access to the HMDB database but, through the <code>MsBackendHmdbXml</code> backend, allows to import MS2 spectra files in HMDB format. These are provided by HMDB as individual xml files in a custom file format which are bundled (and can hence be downloaded) in a single archive.</p>
<p>To reproduce the following code it is expected (as detailed in the Installation section) that all xml files from HMDB are available in a folder <em>data/hmdb_all_spectra</em>. Below we identify all xml files containing the key word <code>"ms_ms"</code> in their file name and load them into a <code>Spectra</code> object using the <code>MsBackendHmdbXml</code> backend. Note that this import operation from the ~ 500,000 individual xml files takes up to ~ 2 hours to finish.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendHmdb">MsBackendHmdb</a></span><span class="op">)</span>
<span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"data/hmdb_all_spectra/"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">"ms_ms"</span><span class="op">)</span>
<span class="va">hmdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendHmdb/man/MsBackendHmdbXml.html">MsBackendHmdbXml</a></span><span class="op">(</span><span class="op">)</span>, nonStop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>With this we have now a <code>Spectra</code> object containing all MS2 spectra from HMDB. Note that with the <code>MsBackendHmdbXml</code> all spectra data is kept in memory.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hmdb</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 458963 spectra in a MsBackendHmdbXml backend:
##          msLevel     rtime scanIndex
##        &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1              2        NA        NA
## 2              2        NA        NA
## 3              2        NA        NA
## 4              2        NA        NA
## 5              2        NA        NA
## ...          ...       ...       ...
## 458959         2        NA        NA
## 458960         2        NA        NA
## 458961         2        NA        NA
## 458962         2        NA        NA
## 458963         2        NA        NA
##  ... 21 more variables/columns.</code></pre>
<p>Also here, to avoid comparing our experimental spectra against all these ~500,000 spectra, we first determine with the <code>containsMz</code> function which of the HMDB spectra contain a peak matching the m/z of our ion of interest. We have to use a rather large <code>tolerance</code> value (which defines the maximal acceptable absolute difference in m/z values) since some of the experimental spectra in HMDB seem to be recorded by not well calibrated instruments.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">has_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">containsMz</a></span><span class="op">(</span><span class="va">hmdb</span>, mz <span class="op">=</span> <span class="va">mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p>In total 46772 spectra contain a peak with the required m/z (+/- 0.2 Dalton) and we can proceed to calculate spectral similarities between our experimental spectra and this subset from HMDB.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hmdb_with_mz</span> <span class="op">&lt;-</span> <span class="va">hmdb</span><span class="op">[</span><span class="va">has_mz</span><span class="op">]</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps_ce20</span>, <span class="va">hmdb_with_mz</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p>The highest similarity between our spectra and the spectra from HMDB is <code>r max(res)</code>. Below we compare the two best matching spectra with a <em>mirror plot</em>, in the upper panel showing our experimental spectrum and in the lower panel the best matching MS2 spectrum from HMDB.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">res</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## Specifying a function to draw peak labels</span>
<span class="va">label_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu">mz</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps_ce20</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">hmdb_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span>,
                  labels <span class="op">=</span> <span class="va">label_fun</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.2</span>,
                  labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="EuroBioc2020-Spectra-backends_files/figure-html/mirror-plot-1.png" width="672"></p>
<p>Our experimental spectrum seems to nicely match the <em>reference</em> MS2 in HMDB. Below we extract the compound identifier from the best matching HMDB spectrum (stored in a spectra variable called <code>"compound_id"</code>)</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hmdb_with_mz</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">compound_id</span></code></pre></div>
<pre><code>## [1] "HMDB0000192"</code></pre>
<p>In fact, the matching spectrum from HMDB is an experimental spectrum for <a href="https://hmdb.ca/metabolites/HMDB0000192">L-Cystine</a>.</p>
</div>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<ul>
<li><p>Separation of user functionaltity from data storage: ensures flexibility and expandability of the <code>Spectra</code> package.</p></li>
<li><p>Different backends for different data sources or to enable analysis of very large data sets.</p></li>
<li><p><em>Lazy evaluation queue</em> allows to perform data manipulations without changing the actual data.</p></li>
<li><p>User functionality is indepenend of the backend.</p></li>
</ul>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-gattoMSnbaseEfficientElegant2020a">
<p>Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020. “MSnbase, Efficient and Elegant R-Based Processing and Visualization of Raw Mass Spectrometry Data.” <em>Journal of Proteome Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313">https://doi.org/10.1021/acs.jproteome.0c00313</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Institute for Biomedicine, Eurac Research, Bolzano, Italy; <a href="mailto:johannes.rainer@eurac.edu" class="email">johannes.rainer@eurac.edu</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Research Unit Analytical BioGeoChemistry, Helmholtz Zentrum München and Chair of Analytical Food Chemistry, TUM School or Life Sciences, Technical University of Munich, Germany<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Department of Anaesthesiology and Intensive Care, University Medicine Greifswald, Germany<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Computational Biology Unit, de Duve Institute, UCLouvain, Brussels, Belgium<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Johannes Rainer, Michael Witting, Laurent Gatto, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
